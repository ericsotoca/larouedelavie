<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Roue de la Vie Interactive</title>
    <style>
        /* --- Variables & Thème --- */
        :root {
            --bg-color: #f4f4f4;
            --container-bg: white;
            --text-color: #2c3e50;
            --secondary-text-color: #34495e;
            --primary-color: #3498db;
            --primary-hover-color: #2980b9;
            --disabled-color: #bdc3c7;
            --slider-track-color: #dfe6e9;
            --slider-thumb-color: #3498db;
            --chart-bg-color: rgba(52, 152, 219, 0.2);
            --chart-border-color: #3498db;
            --goal-bg-color: rgba(231, 76, 60, 0.1);
            --goal-border-color: #e74c3c;
            --danger-color: #e74c3c;
            --danger-hover-color: #c0392b;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --focus-ring-color: #74b9ff;
            --grid-color: #dbe4e9;
            --tooltip-bg: rgba(255, 255, 255, 0.95);
            --pillar-border-color: transparent; /* Variable pour la couleur du pilier */
            --pillar-border-width: 10px; /* Largeur de la bordure colorée */

             /* Couleurs spécifiques pour les 8 piliers */
            --pillar-color-0: #e74c3c; /* Rouge */
            --pillar-color-1: #e67e22; /* Orange */
            --pillar-color-2: #f1c40f; /* Jaune */
            --pillar-color-3: #2ecc71; /* Vert */
            --pillar-color-4: #3498db; /* Bleu */
            --pillar-color-5: #1abc9c; /* Turquoise */
            --pillar-color-6: #9b59b6; /* Violet */
            --pillar-color-7: #34495e; /* Bleu Foncé / Gris */
        }

        body.dark-theme {
            --bg-color: #2c3e50;
            --container-bg: #34495e;
            --text-color: #ecf0f1;
            --secondary-text-color: #bdc3c7;
            --primary-color: #3498db;
            --primary-hover-color: #5dade2;
            --disabled-color: #7f8c8d;
            --slider-track-color: #7f8c8d;
            --slider-thumb-color: #3498db;
            --chart-bg-color: rgba(52, 152, 219, 0.3);
            --chart-border-color: #5dade2;
            --goal-bg-color: rgba(241, 150, 138, 0.2);
            --goal-border-color: #f1948a;
            --danger-color: #e74c3c;
            --danger-hover-color: #f1948a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --focus-ring-color: #a9cce3;
            --grid-color: #566573;
            --tooltip-bg: rgba(44, 62, 80, 0.95);

             /* Couleurs piliers thème sombre (peuvent être les mêmes ou adaptées) */
            --pillar-color-0: #c0392b;
            --pillar-color-1: #d35400;
            --pillar-color-2: #f39c12;
            --pillar-color-3: #27ae60;
            --pillar-color-4: #2980b9;
            --pillar-color-5: #16a085;
            --pillar-color-6: #8e44ad;
            --pillar-color-7: #7f8c8d;
        }

        /* --- Styles Généraux --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            touch-action: manipulation;
        }
        /* Styles pour les conteneurs principaux (Input et Chart) */
        .main-view {
            max-width: 700px;
            margin: 0 auto;
            background: var(--container-bg);
            color: var(--text-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color 0.3s, color 0.3s, border-left-color 0.3s; /* Ajout transition pour border */
        }
        #inputView {
            border-left: var(--pillar-border-width) solid var(--pillar-border-color); /* Bordure colorée */
            padding-left: calc(30px - var(--pillar-border-width)); /* Ajustement padding pour compenser bordure */
        }
        #chartView {
            display: none; /* Caché par défaut */
            text-align: center; /* Centre le contenu */
        }

        h1, h2, h3 { text-align: center; color: var(--text-color); }
        h1 { font-size: 2.5rem; font-weight: 700; margin: 20px 0; }
        h3 { font-size: 1.5rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h4 { margin-top: 15px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1.1rem;}
        h5 { margin-top: 10px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1rem;}

        /* --- Logo & Scores --- */
        .logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; }
        #globalScore { font-size: 1.6rem; font-weight: 600; margin-bottom: 10px; text-align: center; }
        #pillarAverageScore { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--secondary-text-color); }

        /* --- Piliers & Sous-Piliers --- */
        .pillar { margin-bottom: 25px; }
        .sub-pillar {
            margin: 20px 0; padding: 15px; border: 1px solid var(--slider-track-color);
            border-radius: 8px; background-color: var(--bg-color); transition: background-color 0.3s;
        }
        .sub-pillar-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px; }
        .sub-pillar label { flex-grow: 1; font-size: 1.1rem; color: var(--secondary-text-color); display: flex; align-items: center; gap: 8px; }
        .sub-pillar-controls { display: flex; align-items: center; gap: 10px; width: 60%; }
        input[type="range"] {
            flex-grow: 1; margin-left: 10px; -webkit-appearance: none; appearance: none;
            height: 8px; background: var(--slider-track-color); border-radius: 5px;
            outline: none; transition: background 0.3s; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; transition: background 0.3s;
        }
        input[type="range"]::-moz-range-thumb {
             width: 20px; height: 20px; background: var(--slider-thumb-color);
             border-radius: 50%; cursor: pointer; border: none; transition: background 0.3s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { background: var(--primary-hover-color); }
        input[type="range"]::-moz-range-thumb:hover { background: var(--primary-hover-color); }
        .slider-value { font-size: 1.1rem; font-weight: bold; min-width: 25px; text-align: right; }

        /* --- Notes & Objectifs --- */
        .sub-pillar-details { margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; } /* align-items: center */
        .detail-group { display: flex; align-items: center; gap: 5px; }
        .detail-group label { font-size: 0.9rem; color: var(--secondary-text-color); flex-grow: 0; }
        /* Suppression de l'input texte pour la note ici */
        .detail-group input[type="number"] {
            padding: 5px 8px; border-radius: 4px; border: 1px solid var(--slider-track-color);
            background-color: var(--container-bg); color: var(--text-color); font-size: 0.9rem;
            width: 50px;
        }
        /* Style pour le bouton icône Note */
        .note-button {
            background: none; border: none; padding: 3px; margin-left: 5px; /* Espace à gauche */
            cursor: pointer; color: var(--secondary-text-color); line-height: 0; /* Important pour alignement vertical */
        }
        .note-button:hover { color: var(--primary-color); }
        .note-button svg { width: 18px; height: 18px; vertical-align: middle; }

        /* --- Boutons --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button, .button-like {
            background-color: var(--primary-color); color: white; padding: 12px 25px;
            border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-align: center;
            transition: background-color 0.3s, transform 0.1s; text-decoration: none; display: inline-block;
        }
        button:disabled { background-color: var(--disabled-color); cursor: not-allowed; transform: none; }
        button:hover:not(:disabled), .button-like:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); }
        button:active:not(:disabled), .button-like:active { transform: translateY(0); }
        button:focus-visible, .button-like:focus-visible { outline: 3px solid var(--focus-ring-color); outline-offset: 2px; }
        .danger-button { background-color: var(--danger-color); }
        .danger-button:hover:not(:disabled) { background-color: var(--danger-hover-color); }
        .icon-button { background: none; border: none; padding: 2px; cursor: pointer; color: var(--secondary-text-color); }
        .icon-button:hover { color: var(--primary-color); }
        .icon-button svg { width: 16px; height: 16px; vertical-align: middle; }
        .danger-button.icon-button:hover { color: var(--danger-color); }

        /* --- Graphique --- */
        /* Déplacé dans #chartView */
        #radarChart { max-width: 100%; margin-top: 10px; background-color: var(--container-bg); border-radius: 8px; display: block; }

        /* --- Popups / Modals --- */
        .popup {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--container-bg); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color); max-width: 90%; max-height: 85%;
            overflow-y: auto; z-index: 1000; width: 600px; /* Largeur popup standard */
        }
        .popup h3, .popup h4 { margin-top: 0; text-align: center; }
        .popup-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 999;
        }
        /* Styles spécifiques Popup Note */
        #notePopup textarea {
             width: 100%; min-height: 150px; margin-top: 15px; padding: 10px;
             border: 1px solid var(--slider-track-color); border-radius: 4px;
             background-color: var(--bg-color); color: var(--text-color); font-size: 1rem;
             resize: vertical; /* Permet redimensionnement vertical */
             box-sizing: border-box; /* Inclut padding/border dans la largeur */
        }
        #notePopup #notePopupSubPillarName { font-weight: bold; color: var(--primary-color); }

        /* --- Historique (dans popup) --- */
        #historyContent ul { list-style: none; padding: 0; }
        #historyContent li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--slider-track-color); }
        #historyContent li:last-child { border-bottom: none; }
        .history-entry strong { font-size: 1.1em; }
        .history-scores { margin-top: 5px; font-size: 0.9em; }
        .score-diff { margin-left: 5px; font-size: 0.8em; }
        .score-diff.positive { color: #2ecc71; font-weight: bold;}
        .score-diff.negative { color: var(--danger-color); font-weight: bold; }

        /* --- Personnalisation (dans popup) --- */
        .customization-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--slider-track-color); }
        .customization-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .customization-item input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); }

        /* --- Theme Toggle --- */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; position: absolute; top: 15px; right: 15px; z-index: 5; } /* z-index ajouté */
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- Aide (dans popup) --- */
        #helpPopup ul { margin-top: 15px; padding-left: 20px; }
        #helpPopup li { margin-bottom: 8px; }

        /* --- Utilitaires --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-2 { margin-bottom: 20px; }
        .w-100 { width: 100%; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-view { padding: 15px; }
             #inputView {
                 padding-left: calc(15px - var(--pillar-border-width)); /* Ajustement padding responsive */
             }
            h1 { font-size: 1.8rem; }
            .sub-pillar-header { flex-direction: column; align-items: stretch; gap: 8px; }
            .sub-pillar-controls { width: 100%; margin-top: 5px;}
            input[type="range"] { margin-left: 0; width: 100%; }
            .sub-pillar label { font-size: 1rem; }
            .nav-buttons, .popup-buttons { flex-direction: column; gap: 10px; }
            button, .button-like { width: 100%; }
            .popup { width: 90%; padding: 20px; }
            .theme-switch-wrapper { position: static; justify-content: center; margin: 15px 0 5px; order: -1; /* Met le switch en haut sur mobile */ }
            .detail-group { flex-basis: calc(50% - 8px); } /* Deux par ligne si possible */
            .detail-group:has(.note-button) { flex-basis: auto; } /* Le groupe note prend moins de place */
            h3 { font-size: 1.3rem; }
             #notePopup textarea { min-height: 100px; }
        }
         @media (max-width: 480px) {
             .detail-group { flex-basis: 100%; } /* Une par ligne sur très petit écran */
             h1 { font-size: 1.6rem; }
             h3 { flex-direction: column; gap: 5px; } /* Titre pilier sur 2 lignes si besoin */
         }

    </style>
</head>
<body>
    <!-- Theme Switch -->
    <div class="theme-switch-wrapper">
        <span aria-hidden="true">☀️</span>
        <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" aria-label="Changer de thème (clair/sombre)">
            <span class="slider round"></span>
        </label>
        <span aria-hidden="true">🌙</span>
    </div>

    <!-- === Vue Principale (Inputs) === -->
    <div id="inputView" class="main-view">
        <img src="logo.png" alt="" class="logo" onerror="this.style.display='none'; this.alt='Logo indisponible'">
        <h1>La Roue de la Vie</h1>
        <div id="globalScore">Note globale : - / 20</div>
        <div id="pillarDisplay">
            <!-- Contenu du pilier actuel injecté par JS -->
        </div>
         <div id="pillarAverageScore">Moyenne Pilier : - / 10</div>

        <div class="nav-buttons">
            <button id="prevBtn" onclick="changePillar(-1)" aria-label="Pilier précédent">Précédent</button>
            <button id="nextBtn" onclick="changePillar(1)" aria-label="Pilier suivant">Suivant</button>
        </div>

        <!-- Boutons d'action principaux -->
        <button id="showChartBtn" onclick="showChartAndSave()" class="w-100 mt-2" aria-label="Afficher le graphique et sauvegarder l'évaluation">Afficher la Roue & Sauvegarder</button>

        <div class="mt-2 text-center" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button onclick="openModal('historyPopup')" aria-label="Ouvrir l'historique des évaluations">Historique</button>
            <button onclick="openModal('customizationPopup')" aria-label="Ouvrir les options de personnalisation">Personnaliser</button>
            <button onclick="openModal('helpPopup')" aria-label="Ouvrir l'aide">Aide</button>
             <!-- Input caché pour l'import -->
             <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
             <button onclick="document.getElementById('importFile').click()" aria-label="Importer des données depuis un fichier JSON">Importer</button>
        </div>
    </div>

    <!-- === Vue Graphique === -->
    <div id="chartView" class="main-view">
         <h2>Votre Roue de la Vie</h2>
         <canvas id="radarChart" aria-label="Graphique radar des scores de la roue de la vie"></canvas>
         <button onclick="showInputView()" class="w-100 mt-2 mb-2" aria-label="Revenir à la saisie des notes">Retour au Menu</button>
     </div>

    <!-- Overlay pour les popups -->
    <div id="overlay" onclick="closeAllModals()"></div>

    <!-- === Popups === -->

    <!-- Popup Historique -->
    <div id="historyPopup" class="popup" role="dialog" aria-labelledby="historyTitle" aria-modal="true">
        <h3 id="historyTitle">Historique des évaluations</h3>
        <div id="historyContent"></div>
        <div class="popup-buttons">
            <button onclick="exportData()" class="button-like">Exporter Tout (JSON)</button>
            <button onclick="copyHistory()" aria-label="Copier l'historique au format JSON avec prompt de coaching">Copier (JSON+Prompt)</button>
            <button onclick="resetApp()" class="danger-button" aria-label="Réinitialiser toutes les données de l'application">Tout Réinitialiser</button>
            <button onclick="closeModal('historyPopup')" aria-label="Fermer la fenêtre d'historique">Fermer</button>
        </div>
    </div>

     <!-- Popup Personnalisation -->
    <div id="customizationPopup" class="popup" role="dialog" aria-labelledby="customizationTitle" aria-modal="true">
        <h3 id="customizationTitle">Personnaliser les Piliers</h3>
        <div id="customizationContent">
            <!-- Contenu généré par JS -->
        </div>
         <p style="font-size: 0.9em; color: var(--secondary-text-color);">Note: L'ajout de nouveaux piliers/sous-piliers n'est pas supporté. La suppression est définitive pour la session (sauvegardée ensuite).</p>
        <div class="popup-buttons">
            <button onclick="saveCustomization()" aria-label="Sauvegarder les changements de personnalisation">Sauvegarder & Fermer</button>
            <button onclick="closeModal('customizationPopup')" aria-label="Annuler et fermer la personnalisation">Annuler</button>
        </div>
    </div>

    <!-- Popup Aide -->
    <div id="helpPopup" class="popup" role="dialog" aria-labelledby="helpTitle" aria-modal="true">
        <h3 id="helpTitle">Aide - La Roue de la Vie</h3>
        <p>La Roue de la Vie est un outil pour évaluer votre satisfaction dans différents domaines clés.</p>
        <ul>
            <li>Naviguez entre les "Piliers" avec "Précédent" / "Suivant". La couleur de la marge gauche indique le pilier actuel.</li>
            <li>Notez chaque "Sous-Pilier" de 1 (bas) à 10 (haut) avec le curseur.</li>
            <li>Cliquez sur l'icône <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em; height:1em; vertical-align: -0.125em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> à côté de "Objectif" pour ajouter une note détaillée dans une fenêtre dédiée.</li>
            <li>Définissez un objectif optionnel (1-10) pour chaque sous-pilier.</li>
            <li>Cliquez sur "Afficher la Roue & Sauvegarder" pour voir le graphique sur une nouvelle page et enregistrer l'évaluation.</li>
            <li>Depuis la page du graphique, cliquez sur "Retour au Menu" pour revenir à la saisie.</li>
            <li>"Historique" montre les évaluations passées et leur évolution.</li>
            <li>"Personnaliser" permet de renommer ou supprimer des piliers/sous-piliers.</li>
            <li>Utilisez l'interrupteur (☀️/🌙) pour changer de thème.</li>
            <li>Exportez/Importez vos données via l'Historique ou les boutons principaux.</li>
        </ul>
        <div class="popup-buttons">
            <button onclick="closeModal('helpPopup')" aria-label="Fermer la fenêtre d'aide">Fermer</button>
        </div>
    </div>

    <!-- Popup pour la Note -->
    <div id="notePopup" class="popup" role="dialog" aria-labelledby="notePopupTitle" aria-modal="true">
        <h4 id="notePopupTitle">Ajouter/Modifier une Note pour <span id="notePopupSubPillarName"></span></h4>
        <textarea id="notePopupTextarea" placeholder="Écrivez vos réflexions, détails, contexte ici..."></textarea>
        <div class="popup-buttons">
            <button id="saveNoteBtn" onclick="saveNoteFromPopup()" aria-label="Sauvegarder la note">Sauvegarder</button>
            <button onclick="closeModal('notePopup')" aria-label="Annuler et fermer sans sauvegarder la note">Annuler</button>
        </div>
    </div>

    <!-- Librairie Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // --- SVG Icons ---
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`;
        const noteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>`; // Pencil Icon

        // --- Default Structure ---
        const defaultPillarsData = [
             { id: "sante", name: "Santé", subPillars: [
                { id: "sante-phy", name: "Physique", score: 5, note: "", goal: 8 }, { id: "sante-men", name: "Mental", score: 5, note: "", goal: 8 },
                { id: "sante-som", name: "Sommeil", score: 5, note: "", goal: 7 }, { id: "sante-nut", name: "Nutrition", score: 5, note: "", goal: 7 },
                { id: "sante-ene", name: "Énergie", score: 5, note: "", goal: 8 } ]},
             { id: "famille", name: "Famille", subPillars: [
                { id: "fam-pro", name: "Proches", score: 5, note: "", goal: 8 }, { id: "fam-com", name: "Communication", score: 5, note: "", goal: 7 },
                { id: "fam-tmp", name: "Temps passé", score: 5, note: "", goal: 7 }, { id: "fam-sou", name: "Soutien", score: 5, note: "", goal: 8 },
                { id: "fam-har", name: "Harmonie", score: 5, note: "", goal: 8 } ]},
            { id: "finances", name: "Finances", subPillars: ["Revenus", "Épargne", "Dépenses", "Investissements", "Sécurité"].map((n, i) => ({ id: `fin-${i}`, name: n, score: 5, note: "", goal: 7 })) },
            { id: "carriere", name: "Carrière", subPillars: ["Satisfaction", "Progression", "Équilibre", "Compétences", "Reconnaissance"].map((n, i) => ({ id: `car-${i}`, name: n, score: 5, note: "", goal: 8 })) },
            { id: "loisirs", name: "Loisirs", subPillars: ["Temps libre", "Passions", "Détente", "Créativité", "Social"].map((n, i) => ({ id: `loi-${i}`, name: n, score: 5, note: "", goal: 7 })) },
            { id: "devperso", name: "Développement perso", subPillars: ["Apprentissage", "Objectifs", "Confiance", "Résilience", "Clarté"].map((n, i) => ({ id: `dev-${i}`, name: n, score: 5, note: "", goal: 9 })) },
            { id: "relations", name: "Relations sociales", subPillars: ["Amis", "Réseau", "Écoute", "Partage", "Qualité"].map((n, i) => ({ id: `rel-${i}`, name: n, score: 5, note: "", goal: 7 })) },
            { id: "cadrevie", name: "Cadre de vie", subPillars: ["Logement", "Environnement", "Organisation", "Confort", "Esthétique"].map((n, i) => ({ id: `cad-${i}`, name: n, score: 5, note: "", goal: 8 })) }
        ];

        // --- State Variables ---
        let pillars = [];
        let history = [];
        let currentPillarIndex = 0;
        let chartInstance = null;
        let tempCustomPillars = [];

        // --- Pillar Colors ---
        // Doit correspondre aux variables CSS --pillar-color-X
        const pillarColors = [
            'var(--pillar-color-0)', 'var(--pillar-color-1)', 'var(--pillar-color-2)', 'var(--pillar-color-3)',
            'var(--pillar-color-4)', 'var(--pillar-color-5)', 'var(--pillar-color-6)', 'var(--pillar-color-7)'
        ];

        // --- DOM Elements ---
        const inputView = document.getElementById('inputView');
        const chartView = document.getElementById('chartView');
        const pillarDisplay = document.getElementById('pillarDisplay');
        const globalScoreDisplay = document.getElementById('globalScore');
        const pillarAverageScoreDisplay = document.getElementById('pillarAverageScore');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const radarChartCanvas = document.getElementById('radarChart');
        const historyContent = document.getElementById('historyContent');
        const overlay = document.getElementById('overlay');
        const themeCheckbox = document.getElementById('theme-checkbox');
        const customizationContent = document.getElementById('customizationContent');
        const showChartBtn = document.getElementById('showChartBtn');
        // Note Popup Elements
        const notePopup = document.getElementById('notePopup');
        const notePopupSubPillarName = document.getElementById('notePopupSubPillarName');
        const notePopupTextarea = document.getElementById('notePopupTextarea');
        const saveNoteBtn = document.getElementById('saveNoteBtn');


        // --- Helper Functions ---
        function getCssVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function generateId(prefix = 'item') {
            return `${prefix.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`;
        }

        // --- Initialization ---
        function initializeApp() {
            loadData();
            setupTheme(); // Applique le thème initial AVANT le premier rendu
            if (pillars.length > 0) {
                 renderPillar(); // Affiche le premier pilier
                 showInputView(); // Assure que la vue input est visible
            } else {
                 handleNoPillars();
            }
            addEventListeners();
        }

        function handleNoPillars() {
             inputView.style.display = 'block'; // Assure que l'input view est visible même si vide
             chartView.style.display = 'none';
             pillarDisplay.innerHTML = "<p class='text-center'>Aucun pilier défini. Veuillez réinitialiser l'application ou importer des données.</p>";
             globalScoreDisplay.textContent = `Note globale : - / 20`;
             pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
             prevBtn.disabled = true;
             nextBtn.disabled = true;
             showChartBtn.disabled = true;
             inputView.style.setProperty('--pillar-border-color', 'transparent'); // Reset border color
             if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
             // radarChartCanvas.style.display = 'none'; // Déjà dans chartView qui est cachée
        }


        // --- Data Management (LocalStorage) ---
        function loadData() {
            const storedPillars = localStorage.getItem('wheelOfLife_pillars');
            const storedHistory = localStorage.getItem('wheelOfLife_history');

            try {
                const parsedPillars = storedPillars ? JSON.parse(storedPillars) : null;
                // Utilise defaultPillarsData si storage vide, invalide OU si le tableau chargé est vide
                 pillars = parsedPillars && Array.isArray(parsedPillars) && parsedPillars.length > 0
                            ? migrateDataStructure(parsedPillars)
                            : JSON.parse(JSON.stringify(defaultPillarsData)); // Deep copy defaults
            } catch (e) {
                console.error("Erreur chargement piliers, fallback aux défauts.", e);
                pillars = JSON.parse(JSON.stringify(defaultPillarsData));
            }

             try {
                 const parsedHistory = storedHistory ? JSON.parse(storedHistory) : [];
                 history = Array.isArray(parsedHistory) ? parsedHistory : [];
                 history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
             } catch (e) {
                 console.error("Erreur chargement historique, réinitialisation.", e);
                 history = [];
             }

            // Re-vérification / Nettoyage final
             if (!Array.isArray(pillars) || pillars.length === 0) {
                 console.warn("Pillars array invalid or empty after load attempt, resetting to defaults.");
                 pillars = JSON.parse(JSON.stringify(defaultPillarsData));
            } else {
                pillars = migrateDataStructure(pillars); // Assure que la structure est toujours correcte
            }

            currentPillarIndex = 0;
        }

        function migrateDataStructure(loadedPillars) {
            if (!Array.isArray(loadedPillars)) return []; // Retourne tableau vide si l'entrée n'est pas un tableau

            return loadedPillars.map((p, pIdx) => {
                const pillarBase = p || {}; // Gère le cas où p est null/undefined
                return {
                    id: pillarBase.id || generateId(pillarBase.name || `pillar-${pIdx}`),
                    name: pillarBase.name || `Pilier ${pIdx + 1}`,
                    subPillars: Array.isArray(pillarBase.subPillars) ? pillarBase.subPillars.map((sp, spIdx) => {
                        const subPillarBase = typeof sp === 'string' ? { name: sp } : (sp || {}); // Gère string ou objet null/undefined
                        return {
                            id: subPillarBase.id || generateId((pillarBase.id || `p${pIdx}`) + '-' + (subPillarBase.name || `sub-${spIdx}`)),
                            name: subPillarBase.name || `Sous-pilier ${spIdx + 1}`,
                            score: (subPillarBase.score !== undefined && !isNaN(parseInt(subPillarBase.score))) ? parseInt(subPillarBase.score) : 5,
                            note: subPillarBase.note || "", // Assure que 'note' existe
                            goal: (subPillarBase.goal !== undefined && !isNaN(parseInt(subPillarBase.goal))) ? parseInt(subPillarBase.goal) : 7
                        };
                    }) : [] // Retourne un tableau vide si subPillars n'est pas un tableau
                };
            }).filter(p => p.name && p.id); // Filtre les piliers potentiellement invalides
        }


        function saveData() {
            try {
                localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars));
                localStorage.setItem('wheelOfLife_history', JSON.stringify(history));
            } catch (e) {
                 console.error("Erreur lors de la sauvegarde des données:", e);
                 alert("Erreur: Impossible de sauvegarder les données. Le stockage local est peut-être plein ou indisponible.");
            }
        }

        // --- Rendering ---
        function renderPillar() {
             if (!pillars || pillars.length === 0) {
                 handleNoPillars();
                 return;
             }
             if (currentPillarIndex < 0 || currentPillarIndex >= pillars.length) {
                 currentPillarIndex = 0;
             }

            const pillar = pillars[currentPillarIndex];
            if (!pillar) {
                console.error("Pilier introuvable à l'index", currentPillarIndex);
                handleNoPillars(); return;
            }

            // --- MAJ Couleur Marge ---
            const pillarColor = pillarColors[currentPillarIndex % pillarColors.length]; // Utilise modulo pour cycler les couleurs si plus de 8 piliers
             inputView.style.setProperty('--pillar-border-color', pillarColor);
             // --- Fin MAJ Couleur ---

            let pillarHTML = `
                <h3 id="pillar-title">
                    <span>${pillar.name}</span>
                    (${currentPillarIndex + 1}/${pillars.length})
                </h3>`;

            if (!pillar.subPillars || pillar.subPillars.length === 0) {
                 pillarHTML += "<p class='text-center'>Ce pilier n'a pas de sous-piliers définis.</p>";
            } else {
                pillar.subPillars.forEach((subPillar) => {
                    const displayScore = (subPillar.score !== undefined && !isNaN(subPillar.score)) ? subPillar.score : 5;
                    const displayGoal = (subPillar.goal !== undefined && !isNaN(subPillar.goal)) ? subPillar.goal : 7;
                    // Note n'est plus affichée directement ici

                    pillarHTML += `
                        <div class="sub-pillar" id="subpillar-div-${subPillar.id}">
                            <div class="sub-pillar-header">
                                <label for="range-${subPillar.id}" id="label-${subPillar.id}">
                                    <span>${subPillar.name}</span>
                                </label>
                                <div class="sub-pillar-controls">
                                    <input type="range" id="range-${subPillar.id}" min="1" max="10" value="${displayScore}"
                                        oninput="updateScore('${pillar.id}', '${subPillar.id}', this.value, true)"
                                        aria-labelledby="label-${subPillar.id}"
                                        aria-valuemin="1" aria-valuemax="10" aria-valuenow="${displayScore}">
                                    <output class="slider-value" for="range-${subPillar.id}">${displayScore}</output>
                                </div>
                            </div>
                            <div class="sub-pillar-details">
                                 <div class="detail-group">
                                    <label for="goal-${subPillar.id}">Objectif:</label>
                                    <input type="number" id="goal-${subPillar.id}" min="1" max="10" value="${displayGoal}"
                                           onchange="updateGoal('${pillar.id}', '${subPillar.id}', this.value)">
                                    </div>
                                <div class="detail-group">
                                    <button class="note-button" onclick="openNotePopup('${pillar.id}', '${subPillar.id}')" aria-label="Ajouter ou modifier une note pour ${subPillar.name}">
                                         ${noteIcon}
                                     </button>
                                 </div>
                                <!-- L'ancien input 'note' est supprimé -->
                            </div>
                        </div>`;
                });
            }
            pillarDisplay.innerHTML = pillarHTML;

            updateNavigationButtons();
            updateScoresDisplay();
            showChartBtn.disabled = false;
        }

        // --- Updates & Calculations ---
        function findSubPillar(pillarId, subPillarId) {
            const pillar = pillars.find(p => p.id === pillarId);
            if (!pillar || !Array.isArray(pillar.subPillars)) return null;
            return pillar.subPillars.find(sp => sp.id === subPillarId);
        }

        function updateScore(pillarId, subPillarId, value, fromInput = false) {
            const score = parseInt(value);
            if (isNaN(score)) return;

            const subPillar = findSubPillar(pillarId, subPillarId);
            if (subPillar) {
                 subPillar.score = score;
                 if (fromInput) {
                    const output = document.querySelector(`output[for='range-${subPillarId}']`);
                    if (output) output.textContent = score;
                    const rangeInput = document.getElementById(`range-${subPillarId}`);
                    if (rangeInput) rangeInput.setAttribute('aria-valuenow', score);
                 }
                 updateScoresDisplay();
                 saveData();
            }
        }

         // Fonction updateNote modifiée pour être appelée depuis la popup
         function updateNote(pillarId, subPillarId, value) {
             const subPillar = findSubPillar(pillarId, subPillarId);
             if (subPillar) {
                 subPillar.note = value.trim(); // Toujours trimmer la valeur
                 saveData();
                 console.log(`Note pour ${subPillar.name} mise à jour.`);
             } else {
                 console.error("Impossible de trouver le sous-pilier pour mettre à jour la note:", pillarId, subPillarId);
             }
         }


        function updateGoal(pillarId, subPillarId, value) {
            const goal = parseInt(value);
             const input = document.getElementById(`goal-${subPillarId}`);

             const subPillar = findSubPillar(pillarId, subPillarId);
             if (subPillar) {
                 if (!isNaN(goal) && goal >= 1 && goal <= 10) {
                     subPillar.goal = goal;
                     saveData();
                 } else {
                     if(input) input.value = subPillar.goal !== undefined ? subPillar.goal : 7;
                     console.warn("Objectif invalide, remis à la valeur précédente:", subPillar.goal);
                     alert("L'objectif doit être un nombre entre 1 et 10.");
                 }
             }
         }

        function calculateAverages() {
            const pillarAverages = pillars.map(pillar => {
                 if (!pillar.subPillars || pillar.subPillars.length === 0) return 0;
                 const sum = pillar.subPillars.reduce((acc, sub) => acc + (sub.score || 0), 0);
                 return sum / pillar.subPillars.length;
            });
            const validAverages = pillarAverages.filter(avg => !isNaN(avg));
            const globalAverage = validAverages.length > 0 ? validAverages.reduce((sum, avg) => sum + avg, 0) / validAverages.length : 0;
            const globalScore = globalAverage * 2;
            return { pillarAverages, globalScore };
        }

        function updateScoresDisplay() {
            if (!pillars || pillars.length === 0) return;

            const { pillarAverages, globalScore } = calculateAverages();
            globalScoreDisplay.textContent = `Note globale : ${globalScore.toFixed(1)} / 20`;

            const currentPillarAverage = pillarAverages[currentPillarIndex];
            pillarAverageScoreDisplay.textContent = `Moyenne Pilier : ${currentPillarAverage !== undefined && !isNaN(currentPillarAverage) ? currentPillarAverage.toFixed(1) : '-'} / 10`;
        }

        // --- Navigation ---
        function changePillar(direction) {
            if (!pillars || pillars.length === 0) return;
            currentPillarIndex += direction;
            // Boucle si on dépasse les limites
            if (currentPillarIndex < 0) {
                 currentPillarIndex = pillars.length - 1;
             } else if (currentPillarIndex >= pillars.length) {
                 currentPillarIndex = 0;
             }
            renderPillar();
        }

        function updateNavigationButtons() {
            const numPillars = pillars ? pillars.length : 0;
             // Les boutons sont toujours actifs s'il y a plus d'un pilier, car on boucle maintenant
            prevBtn.disabled = numPillars <= 1;
            nextBtn.disabled = numPillars <= 1;
        }

         // --- View Management ---
         function showInputView() {
             inputView.style.display = 'block';
             chartView.style.display = 'none';
             // S'assurer que la couleur de bordure est correcte au retour
             if (pillars.length > 0 && currentPillarIndex >= 0 && currentPillarIndex < pillars.length) {
                 const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
                 inputView.style.setProperty('--pillar-border-color', pillarColor);
             }
             // Redonne le focus à un élément pertinent si possible
              const focusableElement = inputView.querySelector('button:not(:disabled), input[type=range]');
              if (focusableElement) {
                  focusableElement.focus();
              }
         }

         function showChartView() {
             inputView.style.display = 'none';
             chartView.style.display = 'block';
             window.scrollTo({ top: 0, behavior: 'smooth' }); // Remonte en haut de la page pour voir le titre
             // Focus sur le bouton retour
             const returnBtn = chartView.querySelector('button');
             if(returnBtn) returnBtn.focus();
         }

        // --- Chart ---
        function renderChart() {
            if (!pillars || pillars.length === 0) {
                 if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
                 // radarChartCanvas.style.display = 'none'; // Inclus dans chartView cachée
                 return;
             }

            const { pillarAverages } = calculateAverages();
            const pillarGoalsAverages = pillars.map(pillar => {
                 if (!pillar.subPillars || pillar.subPillars.length === 0) return 0;
                 const sum = pillar.subPillars.reduce((acc, sub) => acc + (sub.goal || 0), 0);
                 return sum / pillar.subPillars.length;
            });
            const labels = pillars.map(p => p.name);

            // Récupération explicite des couleurs JUSTE AVANT le rendu
            const scoreBgColor = getCssVar('--chart-bg-color');
            const scoreBorderColor = getCssVar('--chart-border-color');
            const goalBgColor = getCssVar('--goal-bg-color');
            const goalBorderColor = getCssVar('--goal-border-color');
            const textColor = getCssVar('--text-color');
            const secondaryTextColor = getCssVar('--secondary-text-color');
            const gridColor = getCssVar('--grid-color');
            const containerBgColor = getCssVar('--container-bg');
            const tooltipBgColor = getCssVar('--tooltip-bg');

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Score Actuel', data: pillarAverages,
                        backgroundColor: scoreBgColor, borderColor: scoreBorderColor,
                        borderWidth: 2.5, pointBackgroundColor: scoreBorderColor, pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff', pointHoverBorderColor: scoreBorderColor,
                        pointRadius: 4, pointHoverRadius: 6
                    },
                     {
                        label: 'Objectif Moyen', data: pillarGoalsAverages,
                        backgroundColor: goalBgColor, borderColor: goalBorderColor,
                        borderWidth: 1.5, borderDash: [6, 3], pointBackgroundColor: goalBorderColor, pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff', pointHoverBorderColor: goalBorderColor,
                        pointRadius: 4, pointHoverRadius: 6
                    }
                ]
            };

            const chartOptions = {
                responsive: true, maintainAspectRatio: true,
                 scales: {
                    r: {
                        min: 0, max: 10,
                        ticks: { stepSize: 2, backdropColor: containerBgColor, color: secondaryTextColor },
                         pointLabels: { color: textColor, font: { size: 12 } },
                        grid: { color: gridColor }, angleLines: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top', labels: { color: textColor, usePointStyle: false, boxWidth: 20, padding: 20 }
                    },
                    tooltip: {
                        enabled: true, backgroundColor: tooltipBgColor, titleColor: textColor, bodyColor: textColor,
                        borderColor: gridColor, borderWidth: 1, padding: 10, cornerRadius: 4, usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.r !== null) { label += context.parsed.r.toFixed(1); }
                                return label;
                            }
                        }
                    }
                },
            };

            // radarChartCanvas.style.display = 'block'; // Géré par showChartView()
            const ctx = radarChartCanvas.getContext('2d');

            if (chartInstance) {
                chartInstance.data = chartData;
                chartInstance.options = chartOptions;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, { type: 'radar', data: chartData, options: chartOptions });
            }
        }

        // Fonction modifiée : calcule, rend chart, sauvegarde, PUIS change de vue
        function showChartAndSave() {
            if (!pillars || pillars.length === 0) {
                alert("Aucun pilier à afficher ou sauvegarder.");
                return;
            }
            // 1. Rendre/Mettre à jour le graphique (cela calcule aussi les moyennes)
            renderChart();

            // 2. Sauvegarder dans l'historique
            const { pillarAverages } = calculateAverages(); // Re-calculer juste pour la sauvegarde si besoin
            saveToHistory(pillarAverages);

            // 3. Changer de vue pour afficher le graphique
            showChartView();
        }


        // --- History Management ---
        function saveToHistory(averages) {
             const timestamp = Date.now();
             const entry = {
                id: `hist-${timestamp}-${Math.random().toString(36).substr(2, 5)}`,
                date: new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' }),
                timestamp: timestamp,
                scores: pillars.map((p, index) => ({
                    pillarId: p.id, pillarName: p.name,
                    average: (!isNaN(averages[index]) ? averages[index] : 0),
                    subPillars: (p.subPillars || []).map(sp => ({
                        subPillarId: sp.id, name: sp.name,
                        score: sp.score, note: sp.note, goal: sp.goal
                    }))
                }))
            };
            history.push(entry);
            history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            saveData();
            console.log("Évaluation sauvegardée:", entry.date);
        }

        function showHistory() {
            historyContent.innerHTML = '';
             if (history.length === 0) {
                historyContent.innerHTML = "<p>Aucun historique disponible.</p>";
                return;
            }

            const ul = document.createElement('ul');
            history.forEach((entry, index) => {
                if (!entry || !entry.scores) return;

                const li = document.createElement('li');
                li.className = 'history-entry';
                 const entryAverages = entry.scores.map(s => s.average);
                 const validEntryAverages = entryAverages.filter(avg => !isNaN(avg));
                 const entryGlobalScore = validEntryAverages.length > 0
                                        ? (validEntryAverages.reduce((sum, avg) => sum + avg, 0) / validEntryAverages.length * 2)
                                        : 0;

                let entryHTML = `<strong>${entry.date || 'Date inconnue'}</strong> (Score Global: ${entryGlobalScore.toFixed(1)}/20)<br>`;
                const prevEntry = history[index + 1];

                entryHTML += '<div class="history-scores">';
                entry.scores.forEach(currentScore => {
                    entryHTML += `${currentScore.pillarName || 'Pilier inconnu'}: ${currentScore.average !== undefined ? currentScore.average.toFixed(1) : '-'}`;
                     if (prevEntry && prevEntry.scores) {
                        const prevPillarScore = prevEntry.scores.find(ps => ps.pillarId === currentScore.pillarId);
                        if (prevPillarScore && prevPillarScore.average !== undefined && currentScore.average !== undefined) {
                            const diff = currentScore.average - prevPillarScore.average;
                            if (Math.abs(diff) > 0.01) {
                                const diffClass = diff > 0 ? 'positive' : 'negative';
                                const diffSign = diff > 0 ? '+' : '';
                                entryHTML += ` <span class="score-diff ${diffClass}" title="vs ${prevPillarScore.average.toFixed(1)} le ${prevEntry.date || ''}">(${diffSign}${diff.toFixed(1)})</span>`;
                            }
                        }
                    }
                    entryHTML += '<br>';
                });
                 entryHTML += '</div>';
                li.innerHTML = entryHTML;
                ul.appendChild(li);
            });
            historyContent.appendChild(ul);
        }

        function copyHistory() {
             if (history.length === 0) {
                 alert("L'historique est vide. Aucune donnée à copier.");
                 return;
             }
             const historyJson = JSON.stringify(history, null, 2);
             const coachingPrompt = `
Prompt pour l'IA de Coaching :

"Je te fournis l'historique (${history.length} ${history.length > 1 ? 'entrées' : 'entrée'}) des auto-évaluations d'un utilisateur via l'outil 'Roue de la Vie'. Chaque entrée contient la date, les scores moyens par pilier, et potentiellement des détails (score individuel, note, objectif) pour chaque sous-pilier à ce moment-là. Les données sont triées de la plus récente à la plus ancienne et sont fournies plus bas au format JSON.

Sur la base de ces données, je souhaite que tu :

1.  **Analyses les Tendances :** Identifie les tendances dans les scores moyens au fil du temps pour chaque pilier de vie. Note les améliorations ou les déclins significatifs, indépendamment de la fréquence des évaluations. Mets en évidence les piliers les plus dynamiques (en positif ou négatif).

2.  **Fournisse des Insights :** Donne des insights sur les domaines où l'utilisateur progresse bien (scores élevés, en hausse constante, ou atteignant/dépassant les objectifs fixés 'goal') et ceux qui nécessitent plus d'attention (scores bas, en baisse, ou loin des objectifs), en tenant compte de la fréquence variable des évaluations. Utilise les 'notes' si présentes pour affiner l'analyse.

3.  **Propose des Conseils Personnalisés :** En fonction des tendances, des écarts par rapport aux objectifs et des éventuelles notes, propose des conseils et des stratégies concrètes et personnalisées pour aider l'utilisateur à atteindre ses objectifs ou à améliorer sa satisfaction globale.

4.  **Suggère des Actions Concrètes :** Recommande 2-3 actions spécifiques et réalisables que l'utilisateur peut entreprendre avant sa prochaine évaluation pour améliorer ses scores dans les domaines identifiés comme prioritaires (ceux qui sont loin des objectifs ou en déclin).

5.  **Prépare un Résumé pour la Prochaine Évaluation :** Rédige un paragraphe court résumant les progrès clés (ou points de vigilance) depuis la *dernière* évaluation enregistrée (la plus récente dans les données fournies). Ce résumé doit être un encouragement et un point de focus pour sa prochaine auto-évaluation, quelle que soit la date à laquelle elle aura lieu.

Merci de fournir une analyse détaillée et des recommandations actionnables basées sur ces données pour aider l'utilisateur dans son parcours de développement personnel."

--- DONNÉES JSON DE L'HISTORIQUE ---
`;
             const textToCopy = coachingPrompt + historyJson;
             navigator.clipboard.writeText(textToCopy).then(() => {
                 alert(`Prompt de coaching détaillé et historique (${history.length} ${history.length > 1 ? 'entrées' : 'entrée'}) copiés dans le presse-papiers ! Collez-le dans votre IA favorite.`);
             }).catch(err => {
                 console.error("Erreur de copie automatique dans le presse-papiers: ", err);
                  alert("Erreur lors de la copie automatique. L'historique et le prompt ont été affichés dans la console (F12) pour que vous puissiez les copier manuellement.");
                  console.warn("--- Début du contenu à copier manuellement ---");
                  console.log(textToCopy);
                  console.warn("--- Fin du contenu à copier manuellement ---");
             });
        }

        function resetApp() {
            if (confirm("VRAIMENT réinitialiser TOUTE l'application ?\nConfiguration ET historique seront perdus.")) {
                 pillars = JSON.parse(JSON.stringify(defaultPillarsData));
                 history = [];
                 currentPillarIndex = 0;
                 if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
                 localStorage.removeItem('wheelOfLife_pillars');
                 localStorage.removeItem('wheelOfLife_history');
                 renderPillar();
                 showInputView(); // Assure qu'on retourne à la vue input
                 closeAllModals();
                 alert("Application réinitialisée.");
            }
        }

        // --- Modals (Générique & Note) ---
        function openModal(modalId) {
            if (modalId === 'historyPopup') { showHistory(); }
            else if (modalId === 'customizationPopup') { renderCustomizationForm(); }
            // Ne gère pas 'notePopup' ici, car il est spécifique

            const modalElement = document.getElementById(modalId);
            if(modalElement) {
                modalElement.style.display = 'block';
                overlay.style.display = 'block';
                 // Focus sur le premier élément focusable ou le bouton fermer
                const focusable = modalElement.querySelector('button, input:not([type=hidden]), textarea, select, [tabindex]:not([tabindex="-1"])');
                const closeButton = modalElement.querySelector('.popup-buttons button:last-of-type'); // Cibler le bouton Fermer/Annuler
                 if (focusable) focusable.focus();
                 else if (closeButton) closeButton.focus();
            } else {
                console.error("Modal non trouvée:", modalId);
            }
        }

        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if(modalElement) modalElement.style.display = 'none';

             // Si on ferme la popup de note, nettoie ses data-attributes
             if (modalId === 'notePopup') {
                 saveNoteBtn.removeAttribute('data-pillar-id');
                 saveNoteBtn.removeAttribute('data-subpillar-id');
             }

            const anyModalOpen = Array.from(document.querySelectorAll('.popup')).some(m => m.style.display === 'block');
            if (!anyModalOpen) {
                 overlay.style.display = 'none';
            }
        }

         function closeAllModals() {
             document.querySelectorAll('.popup').forEach(modal => closeModal(modal.id)); // Utilise closeModal pour gérer le nettoyage éventuel
             // overlay.style.display = 'none'; // Géré par closeModal
         }

         // --- Note Popup Functions ---
         function openNotePopup(pillarId, subPillarId) {
             const subPillar = findSubPillar(pillarId, subPillarId);
             if (!subPillar) {
                 console.error("Sous-pilier non trouvé pour la note:", pillarId, subPillarId);
                 alert("Erreur : Impossible d'ouvrir la note pour ce sous-pilier.");
                 return;
             }

             notePopupSubPillarName.textContent = subPillar.name;
             notePopupTextarea.value = subPillar.note || ""; // Charge la note existante

             // Stocke les IDs pour la sauvegarde
             saveNoteBtn.setAttribute('data-pillar-id', pillarId);
             saveNoteBtn.setAttribute('data-subpillar-id', subPillarId);

             notePopup.style.display = 'block';
             overlay.style.display = 'block';
             notePopupTextarea.focus(); // Focus sur le textarea
         }

         function saveNoteFromPopup() {
             const pillarId = saveNoteBtn.getAttribute('data-pillar-id');
             const subPillarId = saveNoteBtn.getAttribute('data-subpillar-id');
             const newNote = notePopupTextarea.value;

             if (pillarId && subPillarId) {
                 updateNote(pillarId, subPillarId, newNote); // Appelle la fonction de mise à jour existante
                 closeModal('notePopup');
             } else {
                 console.error("IDs manquants pour la sauvegarde de la note.");
                 alert("Erreur lors de la sauvegarde de la note.");
             }
         }

        // --- Customization ---
         function renderCustomizationForm() {
             tempCustomPillars = JSON.parse(JSON.stringify(pillars));
             customizationContent.innerHTML = '';

             if (!tempCustomPillars || tempCustomPillars.length === 0) {
                customizationContent.innerHTML = "<p>Aucun pilier à personnaliser.</p>";
                return;
             }

             tempCustomPillars.forEach((pillar) => {
                 const pillarSection = document.createElement('div');
                 pillarSection.className = 'customization-section';
                 pillarSection.innerHTML = `
                    <h4>Pilier:</h4>
                    <div class="customization-item">
                        <input type="text" value="${pillar.name || ''}" id="edit-pillar-${pillar.id}" aria-label="Nom du pilier ${pillar.name || ''}">
                        <button class="icon-button danger-button" onclick="deletePillarTemp('${pillar.id}')" aria-label="Supprimer le pilier ${pillar.name || ''}">${deleteIcon}</button>
                    </div>
                    <h5>Sous-piliers :</h5>`;
                const subPillarList = document.createElement('div');
                if (pillar.subPillars && pillar.subPillars.length > 0) {
                    pillar.subPillars.forEach((subPillar) => {
                         const subPillarItem = document.createElement('div');
                         subPillarItem.className = 'customization-item';
                         subPillarItem.innerHTML = `
                            <input type="text" value="${subPillar.name || ''}" id="edit-subpillar-${subPillar.id}" aria-label="Nom du sous-pilier ${subPillar.name || ''}">
                            <button class="icon-button danger-button" onclick="deleteSubPillarTemp('${pillar.id}', '${subPillar.id}')" aria-label="Supprimer le sous-pilier ${subPillar.name || ''}">${deleteIcon}</button>
                         `;
                         subPillarList.appendChild(subPillarItem);
                     });
                } else {
                     subPillarList.innerHTML = "<p style='font-size:0.9em; font-style:italic;'>Aucun sous-pilier.</p>";
                }
                 pillarSection.appendChild(subPillarList);
                 customizationContent.appendChild(pillarSection);
             });
         }

        function saveCustomization() {
             let structureChanged = false;
             const originalPillarsString = JSON.stringify(pillars);

             tempCustomPillars.forEach(pillar => {
                 const nameInput = document.getElementById(`edit-pillar-${pillar.id}`);
                 if (nameInput && pillar.name !== nameInput.value.trim() && nameInput.value.trim() !== "") {
                    pillar.name = nameInput.value.trim();
                 }
                 if (pillar.subPillars) {
                     pillar.subPillars.forEach(subPillar => {
                         const subNameInput = document.getElementById(`edit-subpillar-${subPillar.id}`);
                          if (subNameInput && subPillar.name !== subNameInput.value.trim() && subNameInput.value.trim() !== "") {
                             subPillar.name = subNameInput.value.trim();
                         }
                     });
                     // Filtre les sous-piliers sans nom (probablement supprimés ou vidés)
                     pillar.subPillars = pillar.subPillars.filter(sp => sp.name && sp.name.trim() !== "");
                 }
             });

             // Filtre les piliers sans nom OU sans sous-piliers
              tempCustomPillars = tempCustomPillars.filter(p => p.name && p.name.trim() !== "" && p.subPillars && p.subPillars.length > 0);

             const tempPillarsString = JSON.stringify(tempCustomPillars);
             if (originalPillarsString !== tempPillarsString) {
                 pillars = JSON.parse(tempPillarsString); // Applique la structure filtrée et renommée
                 structureChanged = true;
                 saveData();
                 if (currentPillarIndex >= pillars.length) {
                     currentPillarIndex = Math.max(0, pillars.length - 1);
                 }
                 renderPillar();
                 // Si le chart view est actif, le mettre à jour aussi (au cas où on y retourne)
                  if (chartView.style.display === 'block') {
                     renderChart();
                  }
                  console.log("Personnalisation sauvegardée.");
             } else {
                 console.log("Aucun changement détecté dans la personnalisation.");
             }

             closeModal('customizationPopup');
         }

         function deletePillarTemp(pillarId) {
             const pillarName = tempCustomPillars.find(p=>p.id === pillarId)?.name || 'ce pilier';
             if (confirm(`Supprimer "${pillarName}" et ses sous-piliers de la personnalisation en cours ?`)) {
                 tempCustomPillars = tempCustomPillars.filter(p => p.id !== pillarId);
                 renderCustomizationForm(); // Re-render la popup
             }
         }

         function deleteSubPillarTemp(pillarId, subPillarId) {
              const pillar = tempCustomPillars.find(p => p.id === pillarId);
              const subPillarName = pillar?.subPillars?.find(sp => sp.id === subPillarId)?.name || 'ce sous-pilier';
              if (confirm(`Supprimer "${subPillarName}" de la personnalisation en cours ?`)) {
                 if (pillar && pillar.subPillars) {
                     pillar.subPillars = pillar.subPillars.filter(sp => sp.id !== subPillarId);
                 }
                 renderCustomizationForm(); // Re-render la popup
              }
         }

        // --- Theme ---
        function setupTheme() {
            const currentTheme = localStorage.getItem('wheelOfLife_theme') || 'light';
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeCheckbox.checked = true;
            } else {
                document.body.classList.remove('dark-theme');
                 themeCheckbox.checked = false;
            }
             // Met à jour le graphique s'il est visible (dans chartView)
              if (chartInstance && chartView.style.display === 'block') {
                 setTimeout(() => { renderChart(); }, 50);
             }
        }

        function toggleTheme() {
            const isDark = themeCheckbox.checked;
            localStorage.setItem('wheelOfLife_theme', isDark ? 'dark' : 'light');
            setupTheme();
        }

        // --- Export / Import ---
        function exportData() {
             const dataToExport = { pillars: pillars, history: history };
             const dataStr = JSON.stringify(dataToExport, null, 2);
             const dataBlob = new Blob([dataStr], { type: 'application/json' });
             const url = URL.createObjectURL(dataBlob);
             const link = document.createElement('a');
             link.href = url;
             const timestamp = new Date().toISOString().slice(0, 10);
             link.download = `roue-de-la-vie-export-${timestamp}.json`;
             document.body.appendChild(link); link.click(); document.body.removeChild(link);
             URL.revokeObjectURL(url);
             alert("Données exportées.");
        }

        function importData(event) {
             const file = event.target.files[0];
             if (!file || !file.name.endsWith('.json')) { alert("Veuillez sélectionner un fichier .json valide."); event.target.value = null; return; }
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const importedData = JSON.parse(e.target.result);
                     // Validation plus souple : vérifie juste si pillars existe, même s'il est vide. History est optionnel.
                      if (!importedData || !importedData.hasOwnProperty('pillars')) { throw new Error("Format de fichier invalide. La clé 'pillars' est manquante."); }
                     if (!confirm("Importer ce fichier écrasera les données actuelles. Continuer ?")) { event.target.value = null; return; }

                     // Migre/valide les piliers importés. Utilise un tableau vide si pillars est null/undefined
                     pillars = migrateDataStructure(importedData.pillars || []);
                     // Valide l'historique. Utilise un tableau vide si history est manquant ou invalide.
                     history = Array.isArray(importedData.history) ? importedData.history : [];
                     history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                     // Vérifie si des piliers valides existent après l'import/migration
                      if (!Array.isArray(pillars) || pillars.length === 0) {
                          alert("Attention: Le fichier importé ne contenait aucun pilier valide ou la structure était incorrecte. Réinitialisation aux piliers par défaut.");
                          pillars = JSON.parse(JSON.stringify(defaultPillarsData)); // Fallback aux défauts si l'import ne donne rien de valide
                      }

                     currentPillarIndex = 0;
                     saveData();
                     closeAllModals();
                     event.target.value = null;
                     if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
                     renderPillar(); // Re-render l'UI principale avec les nouvelles données
                     showInputView(); // Assure qu'on est sur la vue input
                     alert("Données importées avec succès !");
                 } catch (error) {
                     console.error("Erreur importation:", error); alert(`Erreur importation: ${error.message}`); event.target.value = null;
                 }
             };
             reader.onerror = function() { alert("Erreur lecture fichier."); event.target.value = null; };
             reader.readAsText(file);
        }

        // --- Event Listeners ---
        function addEventListeners() {
            themeCheckbox.addEventListener('change', toggleTheme);
             document.addEventListener('keydown', function(event) {
                 if (event.key === 'Escape') {
                      // Priorité : fermer la popup de note si elle est ouverte
                      if (notePopup.style.display === 'block') {
                          closeModal('notePopup');
                      } else { // Sinon, fermer les autres popups
                          closeAllModals();
                      }
                 }
             });
             // Ajouter d'autres listeners si besoin
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
