<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Roue de la Vie Interactive</title>
    <style>
        :root {
            --bg-color: #f4f4f4; --container-bg: white; --text-color: #2c3e50; --secondary-text-color: #34495e; --primary-color: #3498db; --primary-hover-color: #2980b9; --disabled-color: #bdc3c7; --slider-track-color: #dfe6e9; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.2); --chart-border-color: #3498db; --goal-bg-color: rgba(231, 76, 60, 0.1); --goal-border-color: #e74c3c; --danger-color: #e74c3c; --danger-hover-color: #c0392b; --shadow-color: rgba(0, 0, 0, 0.1); --focus-ring-color: #74b9ff; --grid-color: #dbe4e9; --tooltip-bg: rgba(255, 255, 255, 0.95); --pillar-border-color: transparent; --pillar-border-width: 10px;
            --pillar-color-0: #e74c3c; --pillar-color-1: #e67e22; --pillar-color-2: #f1c40f; --pillar-color-3: #2ecc71; --pillar-color-4: #3498db; --pillar-color-5: #1abc9c; --pillar-color-6: #9b59b6; --pillar-color-7: #34495e;
        }
        body.dark-theme {
            --bg-color: #2c3e50; --container-bg: #34495e; --text-color: #ecf0f1; --secondary-text-color: #bdc3c7; --primary-color: #3498db; --primary-hover-color: #5dade2; --disabled-color: #7f8c8d; --slider-track-color: #7f8c8d; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.3); --chart-border-color: #5dade2; --goal-bg-color: rgba(241, 150, 138, 0.2); --goal-border-color: #f1948a; --danger-color: #e74c3c; --danger-hover-color: #f1948a; --shadow-color: rgba(0, 0, 0, 0.3); --focus-ring-color: #a9cce3; --grid-color: #566573; --tooltip-bg: rgba(44, 62, 80, 0.95);
            --pillar-color-0: #c0392b; --pillar-color-1: #d35400; --pillar-color-2: #f39c12; --pillar-color-3: #27ae60; --pillar-color-4: #2980b9; --pillar-color-5: #16a085; --pillar-color-6: #8e44ad; --pillar-color-7: #7f8c8d;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; touch-action: manipulation; }
        .main-view { max-width: 700px; margin: 0 auto; background: var(--container-bg); color: var(--text-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s, color 0.3s, border-left-color 0.3s; }
        #inputView { border-left: var(--pillar-border-width) solid var(--pillar-border-color); padding-left: calc(30px - var(--pillar-border-width)); }
        #chartView { display: none; text-align: center; }
        h1, h2, h3 { text-align: center; color: var(--text-color); } h1 { font-size: 2.5rem; font-weight: 700; margin: 20px 0; } h3 { font-size: 1.5rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;} h4 { margin-top: 15px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1.1rem;} h5 { margin-top: 10px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1rem;}
        .logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; cursor: pointer; }
        #globalScore { font-size: 1.6rem; font-weight: 600; margin-bottom: 10px; text-align: center; } #pillarAverageScore { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--secondary-text-color); }
        .pillar { margin-bottom: 25px; } .sub-pillar { margin: 20px 0; padding: 15px; border: 1px solid var(--slider-track-color); border-radius: 8px; background-color: var(--bg-color); transition: background-color 0.3s; } .sub-pillar-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px; } .sub-pillar label { flex-grow: 1; font-size: 1.1rem; color: var(--secondary-text-color); display: flex; align-items: center; gap: 8px; } .sub-pillar-controls { display: flex; align-items: center; gap: 10px; width: 60%; }
        input[type="range"] { flex-grow: 1; margin-left: 10px; -webkit-appearance: none; appearance: none; height: 10px; background: var(--slider-track-color); border-radius: 5px; outline: none; transition: background 0.3s; cursor: pointer; box-shadow: inset 0 1px 3px var(--shadow-color); } input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); } input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; border: none; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); } input[type="range"]::-webkit-slider-thumb:hover, input[type="range"]::-moz-range-thumb:hover { background: var(--primary-hover-color); transform: scale(1.1); } input[type="range"]:focus::-webkit-slider-thumb, input[type="range"]:focus::-moz-range-thumb { outline: 2px solid var(--focus-ring-color); outline-offset: 2px; }
        .slider-value { font-size: 1.1rem; font-weight: bold; min-width: 25px; text-align: right; }
        .sub-pillar-details { margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; } .detail-group { display: flex; align-items: center; gap: 5px; } .detail-group label { font-size: 0.9rem; color: var(--secondary-text-color); flex-grow: 0; } .detail-group input[type="number"] { padding: 5px 8px; border-radius: 4px; border: 1px solid var(--slider-track-color); background-color: var(--container-bg); color: var(--text-color); font-size: 0.9rem; width: 50px; } .note-button { background: none; border: none; padding: 3px; margin-left: 5px; cursor: pointer; color: var(--secondary-text-color); line-height: 0; } .note-button:hover { color: var(--primary-color); } .note-button svg { width: 18px; height: 18px; vertical-align: middle; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button, .button-like { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-align: center; transition: background-color 0.3s, transform 0.1s; text-decoration: none; display: inline-block; } button:disabled { background-color: var(--disabled-color); cursor: not-allowed; transform: none; } button:hover:not(:disabled), .button-like:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); } button:active:not(:disabled), .button-like:active { transform: translateY(0); } button:focus-visible, .button-like:focus-visible { outline: 3px solid var(--focus-ring-color); outline-offset: 2px; } .danger-button { background-color: var(--danger-color); } .danger-button:hover:not(:disabled) { background-color: var(--danger-hover-color); } .icon-button { background: none; border: none; padding: 2px; cursor: pointer; color: var(--secondary-text-color); } .icon-button:hover { color: var(--primary-color); } .icon-button svg { width: 16px; height: 16px; vertical-align: middle; } .danger-button.icon-button:hover { color: var(--danger-color); }
        #radarChart { max-width: 100%; margin-top: 10px; background-color: var(--container-bg); border-radius: 8px; display: block; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; } #overlay:not([style*="display: flex"]) { display: none; }
        .popup { position: relative; background: var(--container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); max-width: 90%; max-height: 85vh; overflow-y: auto; width: 600px; z-index: 1000; flex-shrink: 0; display: none; }
        .popup h3, .popup h4 { margin-top: 0; text-align: center; padding-right: 35px; min-height: 1.5em; margin-right: 5px; } .popup-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        #notePopup textarea { width: 100%; min-height: 150px; margin-top: 15px; padding: 10px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; resize: vertical; box-sizing: border-box; } #notePopup #notePopupSubPillarName { font-weight: bold; color: var(--primary-color); }
        .popup-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; line-height: 1; padding: 0 5px; color: var(--secondary-text-color); cursor: pointer; transition: color 0.2s; z-index: 1001; } .popup-close-btn:hover { color: var(--danger-color); }
        #historyContent { margin-top: 15px; } #historyContent ul { list-style: none; padding: 0; } #historyContent li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--slider-track-color); } #historyContent li:last-child { border-bottom: none; } .history-entry strong { font-size: 1.1em; } .history-scores { margin-top: 5px; font-size: 0.9em; } .score-diff { margin-left: 5px; font-size: 0.8em; } .score-diff.positive { color: #2ecc71; font-weight: bold;} .score-diff.negative { color: var(--danger-color); font-weight: bold; }
        .history-scroll-container { margin-bottom: 10px; } #historyScrollToBottomBtn svg { width: 24px; height: 24px; vertical-align: middle; } #historyScrollToBottomBtn:hover { color: var(--primary-hover-color); background-color: var(--slider-track-color); border-radius: 50%; padding: 4px; }
        #historyPopup .popup-buttons { flex-wrap: nowrap; overflow-x: auto; }
        #compareControls { margin-top: 15px; }
        .customization-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--slider-track-color); } .customization-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; } .customization-item input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); }
        .pillar-nav { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .pillar-nav-button { background-color: var(--slider-track-color); color: var(--text-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 0.9rem; }
        .pillar-nav-button.active { background-color: var(--primary-color); color: white; }
        .pillar-nav-button:hover:not(.active) { background-color: var(--primary-hover-color); color: white; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; position: absolute; top: 15px; right: 15px; z-index: 5; } .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; } .theme-switch input { display:none; } .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; } .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; } input:checked + .slider { background-color: var(--primary-color); } input:checked + .slider:before { transform: translateX(26px); }
        #helpPopup ul { margin-top: 15px; padding-left: 20px; } #helpPopup li { margin-bottom: 8px; }
        .hidden { display: none; } .text-center { text-align: center; } .mt-1 { margin-top: 10px; } .mt-2 { margin-top: 20px; } .mb-2 { margin-bottom: 20px; } .w-100 { width: 100%; }
        .loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); z-index: 1000; }
        .notification { position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; }
        @media (max-width: 768px) { body { padding: 10px; } .main-view { padding: 15px; } #inputView { padding-left: calc(15px - var(--pillar-border-width)); } h1 { font-size: 1.8rem; } .sub-pillar-header { flex-direction: column; align-items: stretch; gap: 8px; } .sub-pillar-controls { width: 100%; margin-top: 5px;} input[type="range"] { margin-left: 0; width: 100%; } .sub-pillar label { font-size: 1rem; } .popup-buttons { flex-direction: column; gap: 10px; } button, .button-like { width: 100%; } #historyPopup .popup-buttons { flex-direction: row; justify-content: center; flex-wrap: wrap; } #historyPopup .popup-buttons button, #historyPopup .popup-buttons .button-like { width: auto; flex-grow: 0; flex-shrink: 0; margin-bottom: 5px; } .popup { width: 90%; padding: 20px; } .theme-switch-wrapper { position: static; justify-content: center; margin: 15px 0 5px; order: -1; } .detail-group { flex-basis: calc(50% - 8px); } .detail-group:has(.note-button) { flex-basis: auto; } h3 { font-size: 1.3rem; } #notePopup textarea { min-height: 100px; } .popup-close-btn { font-size: 1.6rem; top: 8px; right: 10px; } .popup h3, .popup h4 { padding-right: 30px; } }
        @media (max-width: 480px) { .detail-group { flex-basis: 100%; } h1 { font-size: 1.6rem; } h3 { flex-direction: column; gap: 5px; } }
        @media (prefers-color-scheme: dark) { body:not(.light-theme) { --bg-color: #2c3e50; --container-bg: #34495e; --text-color: #ecf0f1; --secondary-text-color: #bdc3c7; --primary-color: #3498db; --primary-hover-color: #5dade2; --disabled-color: #7f8c8d; --slider-track-color: #7f8c8d; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.3); --chart-border-color: #5dade2; --goal-bg-color: rgba(241, 150, 138, 0.2); --goal-border-color: #f1948a; --danger-color: #e74c3c; --danger-hover-color: #f1948a; --shadow-color: rgba(0, 0, 0, 0.3); --focus-ring-color: #a9cce3; --grid-color: #566573; --tooltip-bg: rgba(44, 62, 80, 0.95); --pillar-color-0: #c0392b; --pillar-color-1: #d35400; --pillar-color-2: #f39c12; --pillar-color-3: #27ae60; --pillar-color-4: #2980b9; --pillar-color-5: #16a085; --pillar-color-6: #8e44ad; --pillar-color-7: #7f8c8d; } }
    </style>
</head>
<body>
    <div class="theme-switch-wrapper">
        <span aria-hidden="true">‚òÄÔ∏è</span>
        <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" aria-label="Changer de th√®me (clair/sombre)">
            <span class="slider round"></span>
        </label>
        <span aria-hidden="true">üåô</span>
    </div>

    <div id="loadingMessage" class="loading-message">Chargement...</div>
    <div id="notification" class="notification"></div>

    <div id="inputView" class="main-view">
        <img src="logo.png" alt="Logo de La Roue de la Vie" class="logo" id="appLogo" onerror="this.style.display='none'; this.alt='Logo indisponible'" aria-describedby="logoDescription">
        <p id="logoDescription" class="hidden">Logo de l'application La Roue de la Vie, repr√©sentant un cercle avec des ic√¥nes symbolisant diff√©rents aspects de la vie.</p>
        <h1>La Roue de la Vie</h1>
        <div id="pillarNavigation" class="pillar-nav" role="navigation" aria-label="Navigation entre les piliers"></div>
        <div id="globalScore" aria-live="polite">Note globale : - / 20</div>
        <div id="pillarDisplay"></div>
        <div id="pillarAverageScore" aria-live="polite">Moyenne Pilier : - / 10</div>
        <div class="nav-buttons">
            <button id="prevBtn" onclick="changePillar(-1)" aria-label="Aller au pilier pr√©c√©dent">Pr√©c√©dent</button>
            <button id="nextBtn" onclick="changePillar(1)" aria-label="Aller au pilier suivant">Suivant</button>
        </div>
        <button id="showChartBtn" onclick="showChartAndSave()" class="w-100 mt-2" aria-label="Afficher le graphique et sauvegarder l'√©valuation">Afficher la Roue & Sauvegarder</button>
        <div class="mt-2 text-center" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button id="personalizeBtn" onclick="openModal('customizationPopup')" aria-label="Ouvrir les options de personnalisation" style="display: none;">Personnaliser</button>
            <button onclick="openModal('helpPopup')" aria-label="Ouvrir l'aide">Aide</button>
        </div>
    </div>

    <div id="chartView" class="main-view">
        <h2>Votre Roue de la Vie</h2>
        <canvas id="radarChart" aria-label="Graphique radar des scores de la roue de la vie"></canvas>
        <button onclick="openModal('historyPopup')" class="w-100 mt-2 mb-2" aria-label="Ouvrir l'historique des √©valuations">Historique</button>
        <button onclick="showInputView()" class="w-100 mb-2" aria-label="Revenir √† la saisie des notes">Retour au Menu</button>
    </div>

    <div id="overlay" onclick="closeAllModals()">
        <div id="historyPopup" class="popup" role="dialog" aria-labelledby="historyTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('historyPopup')" class="popup-close-btn" aria-label="Fermer la fen√™tre d'historique">√ó</button>
            <h3 id="historyTitle">Historique des √©valuations</h3>
            <div class="history-scroll-container text-center">
                <button id="historyScrollToBottomBtn" class="icon-button" onclick="historyScrollToBottom()" aria-label="Aller aux boutons en bas" title="Aller aux boutons en bas" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11,4H13V16L18.5,10.5L19.92,11.92L12,19.84L4.08,11.92L5.5,10.5L11,16V4Z" /></svg>
                </button>
            </div>
            <div id="historyContent"></div>
            <div id="compareControls" class="mt-1 text-center" style="display: none;">
                <button id="compareBtn" onclick="compareSelectedEntries()" disabled aria-label="Comparer les √©valuations s√©lectionn√©es">Comparer</button>
            </div>
            <div class="popup-buttons">
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button id="importBtn" onclick="document.getElementById('importFile').click()" aria-label="Importer des donn√©es depuis un fichier JSON" style="display: none;">Importer</button>
                <button onclick="exportData()" class="button-like" style="display: none;">Exporter Tout (JSON)</button>
                <button onclick="copyHistory()" aria-label="Copier l'historique et prompt pour analyse IA">Copier pour IA</button>
                <button onclick="resetApp()" class="danger-button" aria-label="R√©initialiser toutes les donn√©es de l'application">Tout R√©initialiser</button>
                <button onclick="closeModal('historyPopup')" aria-label="Fermer la fen√™tre d'historique">Fermer</button>
            </div>
        </div>

        <div id="customizationPopup" class="popup" role="dialog" aria-labelledby="customizationTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('customizationPopup')" class="popup-close-btn" aria-label="Fermer la fen√™tre de personnalisation">√ó</button>
            <h3 id="customizationTitle">Personnaliser les Piliers</h3>
            <div id="customizationContent"></div>
            <p style="font-size: 0.9em; color: var(--secondary-text-color);">Note : L'ajout de nouveaux piliers/sous-piliers n'est pas support√©...</p>
            <div class="popup-buttons">
                <button onclick="saveCustomization()" aria-label="Sauvegarder les changements de personnalisation">Sauvegarder & Fermer</button>
                <button onclick="closeModal('customizationPopup')" aria-label="Annuler et fermer la fen√™tre de personnalisation">Annuler</button>
            </div>
        </div>

        <div id="helpPopup" class="popup" role="dialog" aria-labelledby="helpTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('helpPopup')" class="popup-close-btn" aria-label="Fermer la fen√™tre d'aide">√ó</button>
            <h3 id="helpTitle">Aide - La Roue de la Vie</h3>
            <p>La Roue de la Vie est un outil d'auto-√©valuation qui vous aide √† visualiser l'√©quilibre dans diff√©rents domaines de votre vie.</p>
            <ul>
                <li>Naviguez entre les "Piliers" avec "Pr√©c√©dent" / "Suivant" ou utilisez la barre de navigation rapide au-dessus des scores.</li>
                <li>Notez chaque "Sous-Pilier" de 1 (bas) √† 10 (haut) avec le curseur.</li>
                <li>Cliquez sur l'ic√¥ne <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em; height:1em; vertical-align: -0.125em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> pour ajouter une note d√©taill√©e.</li>
                <li>D√©finissez un objectif optionnel (1-10) pour chaque sous-pilier.</li>
                <li>Cliquez sur "Afficher la Roue & Sauvegarder" pour voir le graphique et enregistrer l'√©valuation.</li>
                <li>Depuis le graphique, utilisez "Retour au Menu" ou "Historique" pour voir les √©valuations pass√©es.</li>
                <li>Dans "Historique", cochez deux entr√©es et cliquez sur "Comparer" pour un graphique comparatif.</li>
                <li><span id="helpPersonalizeSection" style="display: none;">"Personnaliser" (premium) permet de renommer ou supprimer des piliers/sous-piliers.<br></span></li>
                <li><span id="helpImportSection" style="display: none;">"Importer" (premium, depuis l'historique) permet de charger des donn√©es JSON.<br></span></li>
                <li>L'activation du mode Premium sera possible prochainement sous condition.</li>
                <li>Utilisez l'interrupteur (‚òÄÔ∏è/üåô) pour changer de th√®me.</li>
                <li>Exportez vos donn√©es via "Copier pour IA".</li>
                <li>L'application fonctionne hors ligne gr√¢ce √† la sauvegarde locale.</li>
            </ul>
            <div class="popup-buttons">
                <button onclick="closeModal('helpPopup')" aria-label="Fermer la fen√™tre d'aide">Fermer</button>
            </div>
        </div>

        <div id="notePopup" class="popup" role="dialog" aria-labelledby="notePopupTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('notePopup')" class="popup-close-btn" aria-label="Fermer la fen√™tre de note">√ó</button>
            <h4 id="notePopupTitle">Ajouter/Modifier une Note pour <span id="notePopupSubPillarName"></span></h4>
            <textarea id="notePopupTextarea" placeholder="√âcrivez vos r√©flexions, d√©tails, contexte ici..." aria-label="Champ pour ajouter ou modifier une note"></textarea>
            <div class="popup-buttons">
                <button id="saveNoteBtn" onclick="saveNoteFromPopup()" aria-label="Sauvegarder la note">Sauvegarder</button>
                <button onclick="closeModal('notePopup')" aria-label="Annuler et fermer la fen√™tre de note">Annuler</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        // Ic√¥nes SVG r√©utilisables
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`;
        const noteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>`;

        // Donn√©es par d√©faut des piliers
        const defaultPillarsData = [
            { id: "sante", name: "Sant√©", subPillars: [
                { id: "sante-phy", name: "Physique", score: 5, note: "", goal: 10 },
                { id: "sante-men", name: "Mental", score: 5, note: "", goal: 10 },
                { id: "sante-som", name: "Sommeil", score: 5, note: "", goal: 10 },
                { id: "sante-nut", name: "Nutrition", score: 5, note: "", goal: 10 },
                { id: "sante-ene", name: "√ânergie", score: 5, note: "", goal: 10 }
            ]},
            { id: "famille", name: "Famille", subPillars: [
                { id: "fam-pro", name: "Proches", score: 5, note: "", goal: 10 },
                { id: "fam-com", name: "Communication", score: 5, note: "", goal: 10 },
                { id: "fam-tmp", name: "Temps pass√©", score: 5, note: "", goal: 10 },
                { id: "fam-sou", name: "Soutien", score: 5, note: "", goal: 10 },
                { id: "fam-har", name: "Harmonie", score: 5, note: "", goal: 10 }
            ]},
            { id: "finances", name: "Finances", subPillars: ["Revenus", "√âpargne", "D√©penses", "Investissements", "S√©curit√©"].map((n, i) => ({ id: `fin-${i}`, name: n, score: 5, note: "", goal: 10 })) },
            { id: "carriere", name: "Carri√®re", subPillars: ["Satisfaction", "Progression", "√âquilibre", "Comp√©tences", "Reconnaissance"].map((n, i) => ({ id: `car-${i}`, name: n, score: 5, note: "", goal: 10 })) },
            { id: "loisirs", name: "Loisirs", subPillars: ["Temps libre", "Passions", "D√©tente", "Cr√©ativit√©", "Social"].map((n, i) => ({ id: `loi-${i}`, name: n, score: 5, note: "", goal: 10 })) },
            { id: "devperso", name: "D√©veloppement perso", subPillars: ["Apprentissage", "Objectifs", "Confiance", "R√©silience", "Clart√©"].map((n, i) => ({ id: `dev-${i}`, name: n, score: 5, note: "", goal: 10 })) },
            { id: "relations", name: "Relations sociales", subPillars: ["Amis", "R√©seau", "√âcoute", "Partage", "Qualit√©"].map((n, i) => ({ id: `rel-${i}`, name: n, score: 5, note: "", goal: 10 })) },
            { id: "cadrevie", name: "Cadre de vie", subPillars: ["Logement", "Environnement", "Organisation", "Confort", "Esth√©tique"].map((n, i) => ({ id: `cad-${i}`, name: n, score: 5, note: "", goal: 10 })) }
        ];

        // Variables globales
        let pillars = [];
        let history = [];
        let currentPillarIndex = 0;
        let chartInstance = null;
        let isPremium = false;
        let longPressTimer = null;
        const PREMIUM_PRESS_DURATION = 10000;
        const pillarColors = [
            'var(--pillar-color-0)', 'var(--pillar-color-1)', 'var(--pillar-color-2)', 'var(--pillar-color-3)',
            'var(--pillar-color-4)', 'var(--pillar-color-5)', 'var(--pillar-color-6)', 'var(--pillar-color-7)'
        ];

        // R√©f√©rences DOM
        const inputView = document.getElementById('inputView');
        const chartView = document.getElementById('chartView');
        const pillarDisplay = document.getElementById('pillarDisplay');
        const globalScoreDisplay = document.getElementById('globalScore');
        const pillarAverageScoreDisplay = document.getElementById('pillarAverageScore');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const radarChartCanvas = document.getElementById('radarChart');
        const historyContent = document.getElementById('historyContent');
        const overlay = document.getElementById('overlay');
        const themeCheckbox = document.getElementById('theme-checkbox');
        const customizationContent = document.getElementById('customizationContent');
        const showChartBtn = document.getElementById('showChartBtn');
        const notePopup = document.getElementById('notePopup');
        const notePopupSubPillarName = document.getElementById('notePopupSubPillarName');
        const notePopupTextarea = document.getElementById('notePopupTextarea');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const historyPopup = document.getElementById('historyPopup');
        const historyScrollBtn = document.getElementById('historyScrollToBottomBtn');
        const personalizeBtn = document.getElementById('personalizeBtn');
        const importBtn = document.getElementById('importBtn');
        const appLogo = document.getElementById('appLogo');
        const loadingMessage = document.getElementById('loadingMessage');
        const notification = document.getElementById('notification');

        // Utilitaires
        function getCssVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function generateId(prefix = 'item') {
            return `${prefix.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`;
        }

        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // Fonction de d√©bouncing pour limiter les appels fr√©quents
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Initialisation de l'application
        function initializeApp() {
            try {
                loadData();
                setupTheme();
                updatePremiumUI();
                if (pillars.length > 0) {
                    renderPillar();
                    showInputView();
                } else {
                    handleNoPillars();
                }
                addEventListeners();
                showNotification("Application charg√©e avec succ√®s. Fonctionne hors ligne !");
            } catch (error) {
                console.error("Erreur lors de l'initialisation :", error);
                showNotification("Erreur lors du chargement. Veuillez recharger la page.", 5000);
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        function handleNoPillars() {
            inputView.style.display = 'block';
            chartView.style.display = 'none';
            pillarDisplay.innerHTML = "<p class='text-center'>Aucun pilier d√©fini. Veuillez recharger l'application.</p>";
            globalScoreDisplay.textContent = `Note globale : - / 20`;
            pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            showChartBtn.disabled = true;
            inputView.style.setProperty('--pillar-border-color', 'transparent');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function loadData() {
            const storedPillars = localStorage.getItem('wheelOfLife_pillars');
            const storedHistory = localStorage.getItem('wheelOfLife_history');
            try {
                const parsedPillars = storedPillars ? JSON.parse(storedPillars) : null;
                pillars = parsedPillars && Array.isArray(parsedPillars) && parsedPillars.length > 0 ? migrateDataStructure(parsedPillars) : JSON.parse(JSON.stringify(defaultPillarsData));
            } catch (e) {
                console.error("Erreur lors du chargement des piliers :", e);
                pillars = JSON.parse(JSON.stringify(defaultPillarsData));
                localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars));
                showNotification("Donn√©es des piliers corrompues. R√©initialisation aux valeurs par d√©faut.");
            }
            try {
                const parsedHistory = storedHistory ? JSON.parse(storedHistory) : [];
                history = Array.isArray(parsedHistory) ? parsedHistory : [];
                history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            } catch (e) {
                console.error("Erreur lors du chargement de l'historique :", e);
                history = [];
                localStorage.setItem('wheelOfLife_history', JSON.stringify(history));
                showNotification("Historique corrompu. R√©initialisation.");
            }
            if (!Array.isArray(pillars) || pillars.length === 0) {
                pillars = JSON.parse(JSON.stringify(defaultPillarsData));
                localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars));
            }
            currentPillarIndex = 0;
            const storedPremium = localStorage.getItem('wheelOfLife_premiumStatus');
            isPremium = storedPremium === 'true';
        }

        function migrateDataStructure(loadedPillars) {
            if (!Array.isArray(loadedPillars)) return [];
            return loadedPillars.map((p, pIdx) => {
                const pillarBase = p || {};
                return {
                    id: pillarBase.id || generateId(pillarBase.name || `pillar-${pIdx}`),
                    name: pillarBase.name || `Pilier ${pIdx + 1}`,
                    subPillars: Array.isArray(pillarBase.subPillars) ? pillarBase.subPillars.map((sp, spIdx) => {
                        const subPillarBase = typeof sp === 'string' ? { name: sp } : (sp || {});
                        return {
                            id: subPillarBase.id || generateId((pillarBase.id || `p${pIdx}`) + '-' + (subPillarBase.name || `sub-${spIdx}`)),
                            name: subPillarBase.name || `Sous-pilier ${spIdx + 1}`,
                            score: (subPillarBase.score !== undefined && !isNaN(parseInt(subPillarBase.score))) ? parseInt(subPillarBase.score) : 5,
                            note: subPillarBase.note || "",
                            goal: (subPillarBase.goal !== undefined && !isNaN(parseInt(subPillarBase.goal))) ? parseInt(subPillarBase.goal) : 7
                        };
                    }) : []
                };
            }).filter(p => p.name && p.id);
        }

        function saveData() {
            try {
                localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars));
                localStorage.setItem('wheelOfLife_history', JSON.stringify(history));
            } catch (e) {
                console.error("Erreur lors de la sauvegarde :", e);
                showNotification("Erreur : Impossible de sauvegarder les donn√©es.");
            }
        }

        function savePremiumStatus() {
            localStorage.setItem('wheelOfLife_premiumStatus', isPremium);
        }

        function activatePremium() {
            if (isPremium) return;
            isPremium = true;
            savePremiumStatus();
            updatePremiumUI();
            showNotification("Mode Premium activ√© ! Fonctionnalit√©s suppl√©mentaires d√©bloqu√©es.");
        }

        function updatePremiumUI() {
            if (personalizeBtn) personalizeBtn.style.display = isPremium ? 'inline-block' : 'none';
            const helpPersonalize = document.getElementById('helpPersonalizeSection');
            const helpImport = document.getElementById('helpImportSection');
            if (helpPersonalize) helpPersonalize.style.display = isPremium ? 'list-item' : 'none';
            if (helpImport) helpImport.style.display = isPremium ? 'list-item' : 'none';
        }

        function handleLogoPressStart(event) {
            event.preventDefault();
            clearTimeout(longPressTimer);
            longPressTimer = setTimeout(activatePremium, PREMIUM_PRESS_DURATION);
        }

        function handleLogoPressEnd() {
            clearTimeout(longPressTimer);
        }

        // Rendu des piliers
        function renderPillar() {
            if (!pillars || pillars.length === 0) {
                handleNoPillars();
                return;
            }
            if (currentPillarIndex < 0 || currentPillarIndex >= pillars.length) {
                currentPillarIndex = 0;
            }
            const pillar = pillars[currentPillarIndex];
            const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
            inputView.style.setProperty('--pillar-border-color', pillarColor);

            const navContainer = document.getElementById('pillarNavigation');
            navContainer.innerHTML = pillars.map((p, idx) => `
                <button class="pillar-nav-button ${idx === currentPillarIndex ? 'active' : ''}"
                        onclick="currentPillarIndex = ${idx}; renderPillar()"
                        aria-label="Aller au pilier ${p.name}"
                        aria-current="${idx === currentPillarIndex ? 'true' : 'false'}">
                    ${p.name}
                </button>
            `).join('');

            let pillarHTML = `<h3 id="pillar-title"><span>${pillar.name}</span> (${currentPillarIndex + 1}/${pillars.length})</h3>`;
            if (!pillar.subPillars || pillar.subPillars.length === 0) {
                pillarHTML += "<p class='text-center'>Ce pilier n'a pas de sous-piliers.</p>";
            } else {
                pillar.subPillars.forEach((subPillar) => {
                    const displayScore = (subPillar.score !== undefined && !isNaN(subPillar.score)) ? subPillar.score : 5;
                    const displayGoal = (subPillar.goal !== undefined && !isNaN(subPillar.goal)) ? subPillar.goal : 7;
                    pillarHTML += `
                        <div class="sub-pillar" id="subpillar-div-${subPillar.id}">
                            <div class="sub-pillar-header">
                                <label for="range-${subPillar.id}" id="label-${subPillar.id}"><span>${subPillar.name}</span></label>
                                <div class="sub-pillar-controls">
                                    <input type="range" id="range-${subPillar.id}" min="1" max="10" value="${displayScore}" oninput="updateScore('${pillar.id}', '${subPillar.id}', this.value, true)" aria-labelledby="label-${subPillar.id}" aria-valuemin="1" aria-valuemax="10" aria-valuenow="${displayScore}">
                                    <output class="slider-value" for="range-${subPillar.id}">${displayScore}</output>
                                </div>
                            </div>
                            <div class="sub-pillar-details">
                                <div class="detail-group">
                                    <label for="goal-${subPillar.id}">Objectif :</label>
                                    <input type="number" id="goal-${subPillar.id}" min="1" max="10" value="${displayGoal}" onchange="updateGoal('${pillar.id}', '${subPillar.id}', this.value)">
                                </div>
                                <div class="detail-group">
                                    <button class="note-button" onclick="openNotePopup('${pillar.id}', '${subPillar.id}')" aria-label="Ajouter ou modifier une note pour ${subPillar.name}">${noteIcon}</button>
                                </div>
                            </div>
                        </div>`;
                });
            }
            pillarDisplay.innerHTML = pillarHTML;
            updateNavigationButtons();
            updateScoresDisplay();
            showChartBtn.disabled = false;
        }

        function findSubPillar(pillarId, subPillarId) {
            const pillar = pillars.find(p => p.id === pillarId);
            if (!pillar || !Array.isArray(pillar.subPillars)) return null;
            return pillar.subPillars.find(sp => sp.id === subPillarId);
        }

        const debouncedUpdateScoresDisplay = debounce(updateScoresDisplay, 100);
        const debouncedSaveData = debounce(saveData, 300);

        function updateScore(pillarId, subPillarId, value, fromInput = false) {
            const score = parseInt(value);
            if (isNaN(score) || score < 1 || score > 10) return;
            const subPillar = findSubPillar(pillarId, subPillarId);
            if (subPillar) {
                subPillar.score = score;
                if (fromInput) {
                    const output = document.querySelector(`output[for='range-${subPillarId}']`);
                    if (output) output.textContent = score;
                    const rangeInput = document.getElementById(`range-${subPillarId}`);
                    if (rangeInput) rangeInput.setAttribute('aria-valuenow', score);
                }
                debouncedUpdateScoresDisplay();
                debouncedSaveData();
            }
        }

        function updateNote(pillarId, subPillarId, value) {
            const subPillar = findSubPillar(pillarId, subPillarId);
            if (subPillar) {
                subPillar.note = value.trim();
                debouncedSaveData();
            }
        }

        function updateGoal(pillarId, subPillarId, value) {
            const goal = parseInt(value);
            const input = document.getElementById(`goal-${subPillarId}`);
            const subPillar = findSubPillar(pillarId, subPillarId);
            if (subPillar) {
                if (!isNaN(goal) && goal >= 1 && goal <= 10) {
                    subPillar.goal = goal;
                    debouncedSaveData();
                } else {
                    if (input) input.value = subPillar.goal !== undefined ? subPillar.goal : 7;
                    showNotification("L'objectif doit √™tre entre 1 et 10.");
                }
            }
        }

        function calculateAverages() {
            const pillarAverages = pillars.map(pillar => {
                if (!pillar.subPillars || pillar.subPillars.length === 0) return 0;
                const sum = pillar.subPillars.reduce((acc, sub) => acc + (sub.score || 0), 0);
                return sum / pillar.subPillars.length;
            });
            const validAverages = pillarAverages.filter(avg => !isNaN(avg));
            const globalAverage = validAverages.length > 0 ? validAverages.reduce((sum, avg) => sum + avg, 0) / validAverages.length : 0;
            const globalScore = globalAverage * 2;
            return { pillarAverages, globalScore };
        }

        function updateScoresDisplay() {
            if (!pillars || pillars.length === 0) return;
            const { pillarAverages, globalScore } = calculateAverages();
            globalScoreDisplay.textContent = `Note globale : ${globalScore.toFixed(1)} / 20`;
            const currentPillarAverage = pillarAverages[currentPillarIndex];
            pillarAverageScoreDisplay.textContent = `Moyenne Pilier : ${currentPillarAverage !== undefined && !isNaN(currentPillarAverage) ? currentPillarAverage.toFixed(1) : '-'} / 10`;
        }

        function changePillar(direction) {
            if (!pillars || pillars.length === 0) return;
            currentPillarIndex += direction;
            if (currentPillarIndex < 0) {
                currentPillarIndex = pillars.length - 1;
            } else if (currentPillarIndex >= pillars.length) {
                currentPillarIndex = 0;
            }
            renderPillar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateNavigationButtons() {
            const numPillars = pillars ? pillars.length : 0;
            prevBtn.disabled = numPillars <= 1;
            nextBtn.disabled = numPillars <= 1;
        }

        function historyScrollToBottom() {
            if (historyPopup) {
                historyPopup.scrollTo({ top: historyPopup.scrollHeight, behavior: 'smooth' });
            }
        }

        function showInputView() {
            inputView.style.display = 'block';
            chartView.style.display = 'none';
            if (pillars.length > 0 && currentPillarIndex >= 0 && currentPillarIndex < pillars.length) {
                const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
                inputView.style.setProperty('--pillar-border-color', pillarColor);
            } else {
                inputView.style.setProperty('--pillar-border-color', 'transparent');
            }
        }

        function showChartView() {
            inputView.style.display = 'none';
            chartView.style.display = 'block';
            renderChart();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const returnBtn = chartView.querySelector('button[onclick="showInputView()"]');
            if (returnBtn) returnBtn.focus();
        }

        function renderChart() {
            if (!pillars || pillars.length === 0) {
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                return;
            }
            const { pillarAverages } = calculateAverages();
            const pillarGoalsAverages = pillars.map(pillar => {
                if (!pillar.subPillars || pillar.subPillars.length === 0) return 0;
                const sum = pillar.subPillars.reduce((acc, sub) => acc + (sub.goal || 0), 0);
                return sum / pillar.subPillars.length;
            });
            const labels = pillars.map(p => p.name);
            const scoreBgColor = getCssVar('--chart-bg-color');
            const scoreBorderColor = getCssVar('--chart-border-color');
            const goalBgColor = getCssVar('--goal-bg-color');
            const goalBorderColor = getCssVar('--goal-border-color');
            const textColor = getCssVar('--text-color');
            const secondaryTextColor = getCssVar('--secondary-text-color');
            const gridColor = getCssVar('--grid-color');
            const containerBgColor = getCssVar('--container-bg');
            const tooltipBgColor = getCssVar('--tooltip-bg');
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Score Actuel',
                        data: pillarAverages,
                        backgroundColor: scoreBgColor,
                        borderColor: scoreBorderColor,
                        borderWidth: 2.5,
                        pointBackgroundColor: scoreBorderColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: scoreBorderColor,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Objectif Moyen',
                        data: pillarGoalsAverages,
                        backgroundColor: goalBgColor,
                        borderColor: goalBorderColor,
                        borderWidth: 1.5,
                        borderDash: [6, 3],
                        pointBackgroundColor: goalBorderColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: goalBorderColor,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            };
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    r: {
                        min: 0,
                        max: 10,
                        ticks: { stepSize: 2, backdropColor: containerBgColor, color: secondaryTextColor },
                        pointLabels: { color: textColor, font: { size: 12 } },
                        grid: { color: gridColor },
                        angleLines: { color: gridColor }
                    }
                },
                plugins: {
                    legend: { position: 'top', labels: { color: textColor, usePointStyle: false, boxWidth: 20, padding: 20 } },
                    tooltip: {
                        enabled: true,
                        backgroundColor: tooltipBgColor,
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: gridColor,
                        borderWidth: 1,
                        padding: 10,
                        cornerRadius: 4,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.r !== null) label += context.parsed.r.toFixed(1);
                                return label;
                            }
                        }
                    }
                },
                animation: { duration: 0 }
            };
            const ctx = radarChartCanvas.getContext('2d');
            if (chartInstance) {
                chartInstance.data = chartData;
                chartInstance.options = chartOptions;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, { type: 'radar', data: chartData, options: chartOptions });
            }
        }

        function showChartAndSave() {
            if (!pillars || pillars.length === 0) {
                showNotification("Aucun pilier √† afficher ou sauvegarder.");
                return;
            }
            const { pillarAverages } = calculateAverages();
            saveToHistory(pillarAverages);
            showChartView();
            showNotification("√âvaluation sauvegard√©e avec succ√®s.");
        }

        function saveToHistory(averages) {
            const timestamp = Date.now();
            const twentyFourHoursInMillis = 24 * 60 * 60 * 1000;
            const newEntry = {
                id: `hist-${timestamp}-${Math.random().toString(36).substr(2, 5)}`,
                date: new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' }),
                timestamp: timestamp,
                scores: pillars.map((p, index) => ({
                    pillarId: p.id,
                    pillarName: p.name,
                    average: (!isNaN(averages[index]) ? averages[index] : 0),
                    subPillars: (p.subPillars || []).map(sp => ({
                        subPillarId: sp.id,
                        name: sp.name,
                        score: sp.score,
                        note: sp.note,
                        goal: sp.goal
                    }))
                }))
            };
            history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const lastEntry = history.length > 0 ? history[0] : null;
            if (lastEntry && (timestamp - (lastEntry.timestamp || 0)) < twentyFourHoursInMillis) {
                console.log("Remplacement de l'entr√©e r√©cente datant de moins de 24h.");
                history[0] = newEntry;
            } else {
                console.log("Ajout d'une nouvelle entr√©e √† l'historique.");
                history.push(newEntry);
                history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }
            saveData();
        }

        function showHistory() {
            historyContent.innerHTML = '';
            if (history.length === 0) {
                historyContent.innerHTML = "<p>Aucun historique disponible.</p>";
                if (historyScrollBtn) historyScrollBtn.style.display = 'none';
                document.getElementById('compareControls').style.display = 'none';
                return;
            }
            const ul = document.createElement('ul');
            history.forEach((entry, index) => {
                if (!entry || !entry.scores) return;
                const li = document.createElement('li');
                li.className = 'history-entry';
                const entryAverages = entry.scores.map(s => s.average);
                const validEntryAverages = entryAverages.filter(avg => !isNaN(avg));
                const entryGlobalScore = validEntryAverages.length > 0 ? (validEntryAverages.reduce((sum, avg) => sum + avg, 0) / validEntryAverages.length * 2) : 0;
                let entryHTML = `<input type="checkbox" class="history-compare-checkbox" data-index="${index}" onchange="updateCompareControls()" aria-label="S√©lectionner ${entry.date} pour comparaison"> <strong>${entry.date || 'Date inconnue'}</strong> (Score Global: ${entryGlobalScore.toFixed(1)}/20)<br>`;
                const prevEntry = history[index + 1];
                entryHTML += '<div class="history-scores">';
                entry.scores.forEach(currentScore => {
                    entryHTML += `${currentScore.pillarName || 'Pilier inconnu'}: ${currentScore.average !== undefined ? currentScore.average.toFixed(1) : '-'}`;
                    if (prevEntry && prevEntry.scores) {
                        const prevPillarScore = prevEntry.scores.find(ps => ps.pillarId === currentScore.pillarId);
                        if (prevPillarScore && prevPillarScore.average !== undefined && currentScore.average !== undefined) {
                            const diff = currentScore.average - prevPillarScore.average;
                            if (Math.abs(diff) > 0.01) {
                                const diffClass = diff > 0 ? 'positive' : 'negative';
                                const diffSign = diff > 0 ? '+' : '';
                                entryHTML += ` <span class="score-diff ${diffClass}" title="vs ${prevPillarScore.average.toFixed(1)} le ${prevEntry.date || ''}">(${diffSign}${diff.toFixed(1)})</span>`;
                            }
                        }
                    }
                    entryHTML += '<br>';
                });
                entryHTML += '</div>';
                li.innerHTML = entryHTML;
                ul.appendChild(li);
            });
            historyContent.appendChild(ul);
            document.getElementById('compareControls').style.display = 'block';
            updateCompareControls();
            if (historyPopup && historyScrollBtn) {
                setTimeout(() => {
                    if (document.getElementById('historyPopup')) {
                        if (historyPopup.scrollHeight > historyPopup.clientHeight) {
                            historyScrollBtn.style.display = 'inline-block';
                        } else {
                            historyScrollBtn.style.display = 'none';
                        }
                    }
                }, 100);
            }
        }

        function updateCompareControls() {
            const selected = document.querySelectorAll('.history-compare-checkbox:checked');
            document.getElementById('compareBtn').disabled = selected.length !== 2;
        }

        function compareSelectedEntries() {
            const selected = Array.from(document.querySelectorAll('.history-compare-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
            if (selected.length !== 2) return;
            const entries = [history[selected[0]], history[selected[1]]];
            closeModal('historyPopup');
            showChartView();
            renderComparisonChart(entries);
        }

        function renderComparisonChart(entries) {
            const labels = pillars.map(p => p.name);
            const datasets = entries.map((entry, idx) => {
                const averages = entry.scores.map(s => s.average);
                return {
                    label: `√âvaluation ${entry.date}`,
                    data: averages,
                    backgroundColor: idx === 0 ? 'rgba(52, 152, 219, 0.2)' : 'rgba(231, 76, 60, 0.2)',
                    borderColor: idx === 0 ? '#3498db' : '#e74c3c',
                    borderWidth: 2,
                    pointBackgroundColor: idx === 0 ? '#3498db' : '#e74c3c',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: idx === 0 ? '#3498db' : '#e74c3c',
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            const ctx = radarChartCanvas.getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 10,
                            ticks: { stepSize: 2, backdropColor: getCssVar('--container-bg'), color: getCssVar('--secondary-text-color') },
                            pointLabels: { color: getCssVar('--text-color'), font: { size: 12 } },
                            grid: { color: getCssVar('--grid-color') },
                            angleLines: { color: getCssVar('--grid-color') }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: getCssVar('--text-color'), usePointStyle: false, boxWidth: 20, padding: 20 } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: getCssVar('--tooltip-bg'),
                            titleColor: getCssVar('--text-color'),
                            bodyColor: getCssVar('--text-color'),
                            borderColor: getCssVar('--grid-color'),
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 4,
                            usePointStyle: true
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        function copyHistory() {
            if (history.length === 0) {
                showNotification("L'historique est vide.");
                return;
            }
            const historyJson = JSON.stringify(history
, null, 2);
            const prompt = `Voici mon historique de la Roue de la Vie en JSON. Pouvez-vous m'aider √† analyser mes progr√®s, identifier mes points faibles, et me donner des conseils pour m'am√©liorer ? Donn√©es : ${historyJson}`;
            navigator.clipboard.writeText(prompt).then(() => {
                showNotification("Historique et prompt copi√©s dans le presse-papiers !");
            }).catch(err => {
                console.error("Erreur lors de la copie :", err);
                showNotification("Erreur lors de la copie. Veuillez r√©essayer.");
            });
        }

        function exportData() {
            const data = {
                pillars: pillars,
                history: history,
                premiumStatus: isPremium
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wheel_of_life_export_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification("Donn√©es export√©es avec succ√®s.");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.json')) {
                showNotification("Veuillez s√©lectionner un fichier JSON.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData || typeof importedData !== 'object') throw new Error("Donn√©es invalides.");
                    if (importedData.pillars && Array.isArray(importedData.pillars)) {
                        pillars = migrateDataStructure(importedData.pillars);
                    }
                    if (importedData.history && Array.isArray(importedData.history)) {
                        history = importedData.history;
                        history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    }
                    if (importedData.premiumStatus !== undefined) {
                        isPremium = !!importedData.premiumStatus;
                        savePremiumStatus();
                        updatePremiumUI();
                    }
                    saveData();
                    currentPillarIndex = 0;
                    renderPillar();
                    showHistory();
                    showNotification("Donn√©es import√©es avec succ√®s.");
                } catch (err) {
                    console.error("Erreur lors de l'importation :", err);
                    showNotification("Erreur lors de l'importation. Fichier invalide.");
                }
            };
            reader.onerror = function() {
                showNotification("Erreur lors de la lecture du fichier.");
            };
            reader.readAsText(file);
        }

        function resetApp() {
            if (!confirm("√ätes-vous s√ªr de vouloir r√©initialiser toutes les donn√©es ? Cette action est irr√©versible.")) return;
            pillars = JSON.parse(JSON.stringify(defaultPillarsData));
            history = [];
            isPremium = false;
            savePremiumStatus();
            saveData();
            currentPillarIndex = 0;
            updatePremiumUI();
            renderPillar();
            showHistory();
            showNotification("Application r√©initialis√©e avec succ√®s.");
        }

        function openModal(modalId) {
            closeAllModals();
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.style.display = 'block';
            overlay.style.display = 'flex';
            if (modalId === 'historyPopup') {
                showHistory();
            } else if (modalId === 'customizationPopup') {
                renderCustomizationForm();
            }
            modal.setAttribute('aria-hidden', 'false');
            const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.style.display = 'none';
            overlay.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            const lastFocused = document.activeElement.closest('#inputView, #chartView') ? document.activeElement : null;
            if (lastFocused) lastFocused.focus();
            else if (inputView.style.display === 'block') {
                document.getElementById('prevBtn').focus();
            } else {
                document.querySelector('#chartView button').focus();
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.popup').forEach(modal => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            });
            overlay.style.display = 'none';
        }

        function openNotePopup(pillarId, subPillarId) {
            const subPillar = findSubPillar(pillarId, subPillarId);
            if (!subPillar) return;
            notePopupSubPillarName.textContent = subPillar.name;
            notePopupTextarea.value = subPillar.note || '';
            saveNoteBtn.dataset.pillarId = pillarId;
            saveNoteBtn.dataset.subPillarId = subPillarId;
            openModal('notePopup');
        }

        function saveNoteFromPopup() {
            const pillarId = saveNoteBtn.dataset.pillarId;
            const subPillarId = saveNoteBtn.dataset.subPillarId;
            if (!pillarId || !subPillarId) return;
            updateNote(pillarId, subPillarId, notePopupTextarea.value);
            closeModal('notePopup');
            showNotification("Note sauvegard√©e avec succ√®s.");
        }

        function renderCustomizationForm() {
            customizationContent.innerHTML = '';
            pillars.forEach((pillar, pillarIndex) => {
                const section = document.createElement('div');
                section.className = 'customization-section';
                section.innerHTML = `<h4>${pillar.name}</h4>`;
                const pillarItem = document.createElement('div');
                pillarItem.className = 'customization-item';
                pillarItem.innerHTML = `
                    <input type="text" value="${pillar.name}" data-pillar-index="${pillarIndex}" class="custom-pillar-name" aria-label="Nom du pilier ${pillar.name}">
                    <button class="icon-button danger-button" onclick="deletePillar(${pillarIndex})" aria-label="Supprimer le pilier ${pillar.name}">${deleteIcon}</button>
                `;
                section.appendChild(pillarItem);
                pillar.subPillars.forEach((subPillar, subIndex) => {
                    const subItem = document.createElement('div');
                    subItem.className = 'customization-item';
                    subItem.innerHTML = `
                        <input type="text" value="${subPillar.name}" data-pillar-index="${pillarIndex}" data-sub-index="${subIndex}" class="custom-subpillar-name" aria-label="Nom du sous-pilier ${subPillar.name}">
                        <button class="icon-button danger-button" onclick="deleteSubPillar(${pillarIndex}, ${subIndex})" aria-label="Supprimer le sous-pilier ${subPillar.name}">${deleteIcon}</button>
                    `;
                    section.appendChild(subItem);
                });
                customizationContent.appendChild(section);
            });
        }

        function saveCustomization() {
            const pillarInputs = document.querySelectorAll('.custom-pillar-name');
            const subPillarInputs = document.querySelectorAll('.custom-subpillar-name');
            pillarInputs.forEach(input => {
                const index = parseInt(input.dataset.pillarIndex);
                const newName = input.value.trim();
                if (newName && index >= 0 && index < pillars.length) {
                    pillars[index].name = newName;
                }
            });
            subPillarInputs.forEach(input => {
                const pillarIndex = parseInt(input.dataset.pillarIndex);
                const subIndex = parseInt(input.dataset.subIndex);
                const newName = input.value.trim();
                if (newName && pillarIndex >= 0 && pillarIndex < pillars.length && subIndex >= 0 && subIndex < pillars[pillarIndex].subPillars.length) {
                    pillars[pillarIndex].subPillars[subIndex].name = newName;
                }
            });
            saveData();
            renderPillar();
            closeModal('customizationPopup');
            showNotification("Personnalisation sauvegard√©e avec succ√®s.");
        }

        function deletePillar(pillarIndex) {
            if (pillars.length <= 1) {
                showNotification("Vous devez conserver au moins un pilier.");
                return;
            }
            if (!confirm(`Voulez-vous vraiment supprimer le pilier "${pillars[pillarIndex].name}" ?`)) return;
            pillars.splice(pillarIndex, 1);
            history = history.map(entry => {
                if (!entry.scores) return entry;
                entry.scores.splice(pillarIndex, 1);
                return entry;
            });
            if (currentPillarIndex >= pillars.length) {
                currentPillarIndex = pillars.length - 1;
            }
            saveData();
            renderPillar();
            renderCustomizationForm();
            showNotification("Pilier supprim√© avec succ√®s.");
        }

        function deleteSubPillar(pillarIndex, subIndex) {
            if (pillars[pillarIndex].subPillars.length <= 1) {
                showNotification("Vous devez conserver au moins un sous-pilier par pilier.");
                return;
            }
            if (!confirm(`Voulez-vous vraiment supprimer le sous-pilier "${pillars[pillarIndex].subPillars[subIndex].name}" ?`)) return;
            pillars[pillarIndex].subPillars.splice(subIndex, 1);
            history = history.map(entry => {
                if (!entry.scores || !entry.scores[pillarIndex]) return entry;
                entry.scores[pillarIndex].subPillars.splice(subIndex, 1);
                return entry;
            });
            saveData();
            renderPillar();
            renderCustomizationForm();
            showNotification("Sous-pilier supprim√© avec succ√®s.");
        }

        function setupTheme() {
            const savedTheme = localStorage.getItem('wheelOfLife_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeCheckbox.checked = true;
            } else if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeCheckbox.checked = false;
            } else {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                    themeCheckbox.checked = true;
                }
            }
            themeCheckbox.addEventListener('change', toggleTheme);
        }

        function toggleTheme() {
            if (themeCheckbox.checked) {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
                localStorage.setItem('wheelOfLife_theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
                localStorage.setItem('wheelOfLife_theme', 'light');
            }
            if (chartInstance) renderChart();
        }

        function addEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAllModals();
            });
            if (appLogo) {
                appLogo.addEventListener('mousedown', handleLogoPressStart);
                appLogo.addEventListener('touchstart', handleLogoPressStart);
                appLogo.addEventListener('mouseup', handleLogoPressEnd);
                appLogo.addEventListener('touchend', handleLogoPressEnd);
                appLogo.addEventListener('mouseleave', handleLogoPressEnd);
                appLogo.addEventListener('touchcancel', handleLogoPressEnd);
            }
            const navButtons = document.querySelectorAll('#pillarNavigation button');
            navButtons.forEach(button => {
                button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        button.click();
                    }
                });
            });
        }

        // Lancer l'application
        initializeApp();
    </script>
</body>
</html>
