<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Roue de la Vie Interactive - Tableau de Bord</title>
    <style>
        /* --- Base & Variables --- */
        :root {
            --bg-color: #f4f4f4; --container-bg: white; --text-color: #2c3e50; --secondary-text-color: #34495e; --primary-color: #3498db; --primary-hover-color: #2980b9; --disabled-color: #bdc3c7; --slider-track-color: #dfe6e9; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.2); --chart-border-color: #3498db; --goal-bg-color: rgba(231, 76, 60, 0.1); --goal-border-color: #e74c3c; --danger-color: #e74c3c; --danger-hover-color: #c0392b; --shadow-color: rgba(0, 0, 0, 0.1); --focus-ring-color: #74b9ff; --grid-color: #dbe4e9; --tooltip-bg: rgba(52, 73, 94, 0.95); --tooltip-text-color: white; --pillar-border-color: transparent; --pillar-border-width: 10px; --help-icon-color: #7f8c8d; --help-icon-hover-color: var(--primary-color); --action-key-color: #f39c12; --ai-suggestion-bg: rgba(46, 204, 113, 0.08); --dashboard-item-bg: #ffffff; --dashboard-item-border: #e0e0e0; --ritual-done-color: var(--secondary-text-color);

            --pillar-color-0: #e74c3c; --pillar-color-1: #e67e22; --pillar-color-2: #f1c40f; --pillar-color-3: #2ecc71; --pillar-color-4: #3498db; --pillar-color-5: #1abc9c; --pillar-color-6: #9b59b6; --pillar-color-7: #34495e;
        }
        body.dark-theme {
            --bg-color: #2c3e50; --container-bg: #34495e; --text-color: #ecf0f1; --secondary-text-color: #bdc3c7; --primary-color: #3498db; --primary-hover-color: #5dade2; --disabled-color: #7f8c8d; --slider-track-color: #7f8c8d; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.3); --chart-border-color: #5dade2; --goal-bg-color: rgba(241, 150, 138, 0.2); --goal-border-color: #f1948a; --danger-color: #e74c3c; --danger-hover-color: #f1948a; --shadow-color: rgba(0, 0, 0, 0.3); --focus-ring-color: #a9cce3; --grid-color: #566573; --tooltip-bg: rgba(236, 240, 241, 0.95); --tooltip-text-color: #2c3e50; --help-icon-color: #95a5a6; --help-icon-hover-color: var(--primary-color); --action-key-color: #f1c40f; --ai-suggestion-bg: rgba(39, 174, 96, 0.15); --dashboard-item-bg: #3f5870; --dashboard-item-border: #566573; --ritual-done-color: var(--secondary-text-color);

            --pillar-color-0: #c0392b; --pillar-color-1: #d35400; --pillar-color-2: #f39c12; --pillar-color-3: #27ae60; --pillar-color-4: #2980b9; --pillar-color-5: #16a085; --pillar-color-6: #8e44ad; --pillar-color-7: #7f8c8d;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; touch-action: manipulation; }

        /* --- Layout & Containers --- */
        .main-view { max-width: 700px; margin: 20px auto; background: var(--container-bg); color: var(--text-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s, color 0.3s, border-left-color 0.3s; }
        #inputView { border-left: var(--pillar-border-width) solid var(--pillar-border-color); padding-left: calc(30px - var(--pillar-border-width)); display: none; } /* Cach√© par d√©faut */
        #chartView { display: none; text-align: center; }
        #dashboardView { display: none; } /* Cach√© par d√©faut, affich√© par JS */
         #welcomeView { display: block; } /* Affich√© par d√©faut */

        /* --- Typography & Headings --- */
        h1, h2, h3 { text-align: center; color: var(--text-color); }
        h1 { font-size: 2.2rem; font-weight: 700; margin: 20px 0; }
        h2 { font-size: 1.8rem; margin-bottom: 20px;}
        h3 { font-size: 1.5rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h4 { margin-top: 15px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1.1rem;}
        h5 { margin-top: 10px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1rem;}
        h6 { margin-top: 8px; margin-bottom: 3px; color: var(--primary-color); font-size: 0.95rem; font-weight: bold;}

        /* --- Logo & Scores --- */
        .logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; cursor: pointer; }
        #globalScore { font-size: 1.6rem; font-weight: 600; margin-bottom: 10px; text-align: center; }
        #pillarAverageScore { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--secondary-text-color); }

        /* --- Input View Specific --- */
        .pillar-actions { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px; flex-wrap: wrap; }
        .pillar-actions button { padding: 6px 12px; font-size: 0.9rem; background-color: var(--slider-track-color); color: var(--text-color); }
        .pillar-actions button:hover:not(:disabled) { background-color: var(--primary-hover-color); color: white; }
        .pillar { margin-bottom: 25px; }
        .sub-pillar { margin: 20px 0; padding: 15px; border: 1px solid var(--slider-track-color); border-radius: 8px; background-color: var(--bg-color); transition: background-color 0.3s; }
        .sub-pillar-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .sub-pillar label { flex-grow: 1; font-size: 1.1rem; color: var(--secondary-text-color); display: flex; align-items: center; gap: 8px; min-width: 150px; }
        .sub-pillar-controls { display: flex; align-items: center; gap: 10px; width: 100%; /* Prend toute la largeur */ flex-grow: 1; min-width: 250px;} /* Ajust√© pour mobile first */
        @media (min-width: 600px) { /* Appliquer l'ancien style sur √©cran plus large */
            .sub-pillar-controls { width: 60%; }
        }
        input[type="range"] { flex-grow: 1; margin-left: 10px; -webkit-appearance: none; appearance: none; height: 10px; background: var(--slider-track-color); border-radius: 5px; outline: none; transition: background 0.3s; cursor: pointer; box-shadow: inset 0 1px 3px var(--shadow-color); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; border: none; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); }
        input[type="range"]::-webkit-slider-thumb:hover, input[type="range"]::-moz-range-thumb:hover { transform: scale(1.1); }
        input[type="range"]:focus { outline: 2px solid var(--focus-ring-color); outline-offset: 4px; }
        .slider-value { font-size: 1.1rem; font-weight: bold; min-width: 25px; text-align: right; }
        .sub-pillar-details { margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .detail-group { display: flex; align-items: center; gap: 5px; }
        .detail-group label { font-size: 0.9rem; color: var(--secondary-text-color); flex-grow: 0; }
        .detail-group input[type="number"] { padding: 5px 8px; border-radius: 4px; border: 1px solid var(--slider-track-color); background-color: var(--container-bg); color: var(--text-color); font-size: 0.9rem; width: 50px; text-align: center; }
        .note-button { background: none; border: none; padding: 3px; margin-left: 5px; cursor: pointer; color: var(--secondary-text-color); line-height: 0; }
        .note-button:hover { color: var(--primary-color); }
        .note-button svg { width: 18px; height: 18px; vertical-align: middle; }
        
        /* --- Pillar Navigation (Style Ic√¥nes Carr√©es Arrondies) --- */
        .pillar-nav {
            display: flex;
            justify-content: center;
            gap: 8px; /* Espacement entre boutons */
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .pillar-nav-button {
            /* Couleurs Inactives */
            background-color: var(--slider-track-color); /* Gris clair */
            color: var(--secondary-text-color); /* Ic√¥ne gris fonc√© */

            /* Forme et Taille */
            border-radius: 6px; /* Coins arrondis */
            width: 42px;
            height: 42px;
            padding: 0; /* Pas de padding interne */

            /* Centrage Ic√¥ne */
            display: inline-flex;
            align-items: center;
            justify-content: center;

            /* Autres */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 1px 2px var(--shadow-color);
            line-height: 1; /* Pour le '?' fallback */
            font-size: 1.5rem; /* Pour le '?' fallback */
        }

        .pillar-icon-button svg {
            width: 22px; /* Ajuster la taille de l'ic√¥ne */
            height: 22px;
            fill: currentColor; /* H√©rite la couleur du bouton */
        }

        .pillar-nav-button.active {
            /* Couleurs Actives */
            background-color: var(--primary-color); /* Bleu */
            color: white; /* Ic√¥ne blanche */
            box-shadow: 0 2px 4px var(--shadow-color);
            /* Optionnel: l√©ger grossissement */
            /* transform: scale(1.05); */
        }

        .pillar-nav-button:hover:not(.active) {
            background-color: #d0d6db; /* Gris l√©g√®rement plus fonc√© au survol */
            color: var(--text-color); /* Ic√¥ne un peu plus fonc√©e */
            transform: translateY(-1px);
        }

        /* Ajustement Media Query */
        @media (max-width: 480px) {
             .pillar-nav { gap: 6px; }
             .pillar-nav-button { width: 38px; height: 38px; border-radius: 5px;}
             .pillar-icon-button svg { width: 18px; height: 18px; }
        }



        /* --- Dashboard View --- */
        #dashboardContent { margin-top: 20px; }
        .dashboard-item { background-color: var(--dashboard-item-bg); border: 1px solid var(--dashboard-item-border); border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 5px var(--shadow-color); }
        .dashboard-item h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.2rem; color: var(--primary-color); }
        .dashboard-item .score-info { font-size: 0.95rem; color: var(--secondary-text-color); margin-bottom: 15px; }
        .dashboard-item h5 { font-size: 1rem; color: var(--secondary-text-color); margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid var(--slider-track-color); padding-bottom: 4px; }
        .dashboard-item ul { list-style: none; padding-left: 0; margin: 0; }
        .dashboard-item li { margin-bottom: 8px; font-size: 0.95rem; }
        .dashboard-ritual-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .dashboard-ritual-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary-color); flex-shrink: 0; cursor: pointer; }
        .dashboard-ritual-item label { flex-grow: 1; cursor: pointer; transition: color 0.2s, text-decoration 0.2s; }
        .dashboard-ritual-item input[type="checkbox"]:checked + label { color: var(--ritual-done-color); text-decoration: line-through; }
        #dashboard-actions { margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        #noDashboardItems { text-align: center; color: var(--secondary-text-color); margin-top: 30px; }


        /* --- Buttons --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button, .button-like { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-align: center; transition: background-color 0.3s, transform 0.1s; text-decoration: none; display: inline-block; }
        button:disabled { background-color: var(--disabled-color); cursor: not-allowed; transform: none; }
        button:hover:not(:disabled), .button-like:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); }
        button:active:not(:disabled), .button-like:active { transform: translateY(0); }
        button:focus-visible, .button-like:focus-visible { outline: 3px solid var(--focus-ring-color); outline-offset: 2px; }
        .danger-button { background-color: var(--danger-color); }
        .danger-button:hover:not(:disabled) { background-color: var(--danger-hover-color); }
        .icon-button { background: none; border: none; padding: 2px; cursor: pointer; color: var(--secondary-text-color); }
        .icon-button:hover { color: var(--primary-color); }
        .icon-button svg { width: 16px; height: 16px; vertical-align: middle; }
        .danger-button.icon-button:hover { color: var(--danger-color); }

        /* --- Chart --- */
        #radarChart { max-width: 100%; margin-top: 10px; background-color: var(--container-bg); border-radius: 8px; display: block; }

        /* --- Modals (Popups) --- */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #overlay:not([style*="display: flex"]) { display: none; }
        .popup { position: relative; background: var(--container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); max-width: 90%; max-height: 85vh; overflow-y: auto; width: 600px; z-index: 1000; flex-shrink: 0; display: none; }
        .popup h3, .popup h4 { margin-top: 0; text-align: center; padding-right: 35px; min-height: 1.5em; margin-right: 5px; }
        .popup textarea { width: 100%; margin-top: 10px; padding: 10px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; resize: vertical; box-sizing: border-box; }
        .popup-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .popup-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; line-height: 1; padding: 0 5px; color: var(--secondary-text-color); cursor: pointer; transition: color 0.2s; z-index: 1001; }
        .popup-close-btn:hover { color: var(--danger-color); }

        /* --- Note Popup Specific --- */
        #notePopup textarea#notePopupTextarea { min-height: 100px; }
        #notePopup #notePopupSubPillarName { font-weight: bold; color: var(--primary-color); }
        .action-key-checkbox { margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        .action-key-checkbox label { font-size: 0.9rem; color: var(--secondary-text-color); }
        .action-key-checkbox input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--action-key-color); }
        #aiSuggestionsDisplay { margin-top: 20px; border-top: 1px solid var(--slider-track-color); padding-top: 15px; background-color: var(--ai-suggestion-bg); border-radius: 0 0 8px 8px; padding: 10px 15px; }
        #aiSuggestionsDisplay h5 { margin-top: 0; margin-bottom: 10px; text-align: center;}
        #aiSuggestionsDisplay ul { list-style: disc; padding-left: 25px; margin: 5px 0 10px; }
        #aiSuggestionsDisplay li { margin-bottom: 4px; font-size: 0.9em; }

        /* --- AI Import & Review Popups --- */
         #aiImportPopup textarea { min-height: 150px; }
         #reviewSuggestionsPopup .suggestion-group { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--slider-track-color);}
         #reviewSuggestionsPopup .suggestion-group:last-child { border-bottom: none; margin-bottom: 0; }
         #reviewSuggestionsPopup h5 { font-size: 1.1rem; margin-bottom: 10px; color: var(--primary-color); }
         #reviewSuggestionsPopup h6 { font-size: 0.9rem; color: var(--secondary-text-color); margin-top: 10px; margin-bottom: 5px; }
         #reviewSuggestionsPopup ul { list-style: none; padding-left: 0; }
         #reviewSuggestionsPopup li { margin-bottom: 5px; display: flex; align-items: flex-start; gap: 8px; }
         #reviewSuggestionsPopup input[type="checkbox"] { margin-top: 3px; flex-shrink: 0; accent-color: var(--primary-color); } /* Match ritual checkbox */
         #reviewSuggestionsPopup label { font-size: 0.9em; }

        /* --- History & Action Key Popups --- */
        #historyContent, #actionKeysContent { margin-top: 15px; }
        #historyContent ul, #actionKeysContent ul { list-style: none; padding: 0; }
        #historyContent li, #actionKeysContent li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--slider-track-color); }
        #historyContent li:last-child, #actionKeysContent li:last-child { border-bottom: none; }
        .history-entry strong, .action-key-entry strong { font-size: 1.1em; }
        .history-scores, .action-key-note { margin-top: 5px; font-size: 0.9em; color: var(--secondary-text-color); }
        .action-key-note { white-space: pre-wrap; }
        .action-key-link { font-size: 0.8em; color: var(--primary-color); text-decoration: none; }
        .action-key-link:hover { text-decoration: underline; }
        .score-diff { margin-left: 5px; font-size: 0.8em; }
        .score-diff.positive { color: #2ecc71; font-weight: bold;}
        .score-diff.negative { color: var(--danger-color); font-weight: bold; }
        .history-scroll-container { margin-bottom: 10px; }
        #historyScrollToBottomBtn svg { width: 24px; height: 24px; vertical-align: middle; }
        #historyScrollToBottomBtn:hover { color: var(--primary-hover-color); background-color: var(--slider-track-color); border-radius: 50%; padding: 4px; }
        #historyPopup .popup-buttons { flex-wrap: wrap; overflow-x: auto; padding-bottom: 10px; justify-content: center; }
        #compareControls { margin-top: 15px; }
        .mini-trend-graph { margin-bottom: 20px; padding: 15px; border: 1px solid var(--slider-track-color); border-radius: 8px; background-color: var(--bg-color); }
        .mini-trend-graph h5 { margin-top: 0; text-align: center; color: var(--secondary-text-color);}
        .trend-bars { display: flex; justify-content: space-around; align-items: flex-end; height: 60px; padding: 0 10px; }
        .trend-bar-item { display: flex; flex-direction: column; align-items: center; flex-basis: 0; flex-grow: 1; max-width: 50px; }
        .trend-bar { width: 70%; background-color: var(--primary-color); border-radius: 3px 3px 0 0; transition: height 0.3s ease-out; position: relative; }
        .trend-bar span { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--secondary-text-color); white-space: nowrap; }
        .trend-bar-item .bar-value { font-size: 0.8rem; margin-top: 3px; font-weight: bold; }

        /* --- Customization Popup --- */
        .customization-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--slider-track-color); }
        .customization-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .customization-item input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); min-width: 150px; }


        /* --- Theme Switch --- */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; position: absolute; top: 15px; right: 15px; z-index: 5; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- Help Popup --- */
        #helpPopup ul { margin-top: 15px; padding-left: 20px; }
        #helpPopup li { margin-bottom: 8px; }
        #helpPopup ol { margin-top: 5px; padding-left: 20px; }
        #helpPopup ol li { margin-bottom: 5px; font-size: 0.95em; }
        #helpPopup h5 { margin-top: 15px; font-size: 1.05em; }


        /* --- Tooltips & Help Icons --- */
        .help-icon { display: inline-block; margin-left: 5px; color: var(--help-icon-color); cursor: help; position: relative; font-weight: bold; font-size: 0.9em; border: 1px solid var(--help-icon-color); border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; transition: color 0.2s, border-color 0.2s; }
        .help-icon:hover, .help-icon:focus { color: var(--help-icon-hover-color); border-color: var(--help-icon-hover-color); outline: none; }
        .tooltiptext { visibility: hidden; width: 220px; background-color: var(--tooltip-bg); color: var(--tooltip-text-color); text-align: left; font-size: 0.85rem; font-weight: normal; border-radius: 6px; padding: 8px 10px; position: absolute; z-index: 10; bottom: 135%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--tooltip-bg) transparent transparent transparent; }
        .help-icon:hover .tooltiptext, .help-icon:focus .tooltiptext { visibility: visible; opacity: 1; }
        h3 .help-icon { line-height: 16px; }
        label .help-icon { line-height: 16px; vertical-align: middle; }

        /* --- Utility Classes --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-2 { margin-bottom: 20px; }
        .w-100 { width: 100%; }

        /* --- Loading & Notifications --- */
        .loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); z-index: 1000; }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; box-shadow: 0 2px 8px var(--shadow-color); }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-view { padding: 15px; }
            #inputView { padding-left: calc(15px - var(--pillar-border-width)); }
            h1 { font-size: 1.8rem; }
            h3 { font-size: 1.3rem; }
            /* Input view adjustments */
            .sub-pillar-header { flex-direction: column; align-items: stretch; gap: 8px; }
            .sub-pillar-controls { width: 100%; margin-top: 5px;} /* Force full width */
            input[type="range"] { margin-left: 0; width: 100%; }
            .sub-pillar label { font-size: 1rem; }
            .pillar-nav { gap: 5px; }
            .pillar-nav-button { padding: 4px 8px; font-size: 0.8rem; }
            .pillar-actions { margin-bottom: 15px; }
            /* Dashboard adjustments */
             .dashboard-item { padding: 10px 15px; }
             .dashboard-item h4 { font-size: 1.1rem; }
             .dashboard-item h5 { font-size: 0.95rem; }
             .dashboard-item li { font-size: 0.9rem; }
             #dashboard-actions button { font-size: 0.9rem; padding: 10px 15px; }
             /* Popup adjustments */
            .popup-buttons { flex-direction: column; gap: 10px; }
            button, .button-like { width: 100%; }
            #historyPopup .popup-buttons { flex-direction: row; justify-content: center; flex-wrap: wrap; }
            #historyPopup .popup-buttons button, #historyPopup .popup-buttons .button-like { width: auto; flex-grow: 0; flex-shrink: 0; margin-bottom: 5px; }
            .popup { width: 95%; padding: 20px; max-height: 90vh; }
            #notePopup textarea#notePopupTextarea { min-height: 80px; }
            #aiImportPopup textarea { min-height: 120px; }
            #reviewSuggestionsPopup li { font-size: 0.85em; }
            .popup-close-btn { font-size: 1.6rem; top: 8px; right: 10px; }
            .popup h3, .popup h4 { padding-right: 30px; }
            .theme-switch-wrapper { position: static; justify-content: center; margin: 15px 0 5px; order: -1; }
            .detail-group { flex-basis: calc(50% - 8px); }
            .detail-group:has(.note-button) { flex-basis: auto; }
            .tooltiptext { width: 180px; margin-left: -90px; bottom: 140%; }
        }
        @media (max-width: 480px) {
             h1 { font-size: 1.6rem; }
             h3 { flex-direction: column; gap: 5px; }
             /* Specific button adjustments */
             #inputView .mt-2.text-center button,
             #chartView .mt-2.mb-2 button,
             #dashboard-actions button {
                 font-size: 0.9rem;
                 padding: 10px 15px; /* Consistent padding */
             }
             .detail-group { flex-basis: 100%; }
             .pillar-nav-button { flex-basis: calc(33% - 4px); text-align: center; }
             .pillar-actions button { font-size: 0.85rem; padding: 5px 10px; }
             .trend-bar span { font-size: 0.7rem; }
        }
        @media (prefers-color-scheme: dark) {
             body:not(.light-theme) { /* Styles dark theme d√©finis plus haut */ }
        }
    </style>
</head>
<body>

<!-- FIN PARTIE 1/3 -->

<!-- DEBUT PARTIE 2/3 -->
<!-- DEBUT PARTIE 2/3 (CORRIG√âE) -->

	<!-- Welcome View -->
	<div id="welcomeView" class="main-view" style="display: none;"> <!-- Cach√© par d√©faut -->
        <img src="logo.png" alt="La Roue de la Vie Interactive" class="logo" id="appLogo">
		<h2>Bienvenue sur la Roue de la Vie Interactive !</h2>
		<p style="text-align: center; font-size: 1.1em; color: var(--secondary-text-color); margin-bottom: 25px;">
			Visualisez votre √©quilibre, d√©finissez vos objectifs et suivez vos progr√®s.
		</p>
        <p>Cet outil vous aide √† √©valuer votre satisfaction dans diff√©rents domaines de vie, √† identifier o√π vous souhaitez progresser et √† suivre les actions que vous entreprenez.</p>
        <h5>Comment √ßa marche ?</h5>
        <ol>
            <li>√âvaluez chaque domaine de 1 √† 10 ("√âvaluer / Modifier").</li>
            <li>D√©finissez un objectif pour chaque domaine.</li>
            <li>Utilisez l'IA (optionnel) pour obtenir des suggestions ("Copier pour Objectifs IA" puis "Importer Suggs. IA").</li>
            <li>S√©lectionnez les suggestions qui vous conviennent lors de la Revue.</li>
            <li>Suivez vos rituels quotidiens sur votre "Tableau de Bord".</li>
        </ol>
		<p style="margin-top: 25px; font-style: italic; color: var(--secondary-text-color);">Vos donn√©es sont stock√©es uniquement dans votre navigateur.</p>
		<div class="text-center mt-2">
			<button onclick="startAppFlow()" class="button-like" style="padding: 15px 30px; font-size: 1.1em;">Commencer</button>
		</div>
	</div>

    <!-- Theme Switch -->
    <div class="theme-switch-wrapper">
        <span aria-hidden="true">‚òÄÔ∏è</span>
        <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" aria-label="Changer de th√®me (clair/sombre)">
            <span class="slider round"></span>
        </label>
        <span aria-hidden="true">üåô</span>
    </div>

    <!-- Loading Message & Notifications -->
    <div id="loadingMessage" class="loading-message">Chargement...</div>
    <div id="notification" class="notification"></div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="main-view" style="display: none;">
        <h2>Tableau de Bord - Actions en Cours</h2>
        <div id="dashboardContent">
            <!-- Contenu g√©n√©r√© par renderDashboard() sera ins√©r√© ici -->
        </div>
        <!-- ***** CORRECTION : noDashboardItems EST MAINTENANT ICI ***** -->
        <p id="noDashboardItems" style="display: none;">Aucun domaine n√©cessitant une action d√©fini pour le moment. Allez dans "√âvaluer/Modifier" pour d√©finir des objectifs inf√©rieurs √† votre score actuel et activer des objectifs/rituels via l'import et la revue IA.</p>
        <!-- ********************************************************** -->
        <div id="dashboard-actions">
            <button onclick="resetDailyRituals()" aria-label="R√©initialiser le suivi des rituels quotidiens">R√©initialiser Rituels du Jour</button>
            <button onclick="showInputView(0)" aria-label="Acc√©der √† l'√©valuation compl√®te">√âvaluer / Modifier</button>
            <button onclick="showChartView()" aria-label="Voir le graphique et l'historique">Graphique & Historique</button>
        </div>
    </div>


    <!-- Input View -->
    <div id="inputView" class="main-view" style="display: none;">
         <div id="inputViewHeader" style="text-align: center; margin-bottom: 20px;">
             <h2>√âvaluation D√©taill√©e</h2>
             <div id="pillarNavigation" class="pillar-nav" role="navigation" aria-label="Navigation entre les piliers"></div>
             <div id="globalScore" aria-live="polite">Note globale : - / 20</div>
         </div>

        <div id="pillarDisplay">
            <!-- Contenu g√©n√©r√© par renderPillar() -->
        </div>

        <div id="pillarAverageScore" aria-live="polite">Moyenne Pilier : - / 10</div>

        <div class="nav-buttons">
            <button id="prevBtn" onclick="changePillar(-1)" aria-label="Pilier pr√©c√©dent">Pr√©c√©dent</button>
            <button id="nextBtn" onclick="changePillar(1)" aria-label="Pilier suivant">Suivant</button>
        </div>

        <button id="showChartBtn" onclick="showChartAndSave()" class="w-100 mt-2" aria-label="Sauvegarder et voir graphique">Sauvegarder & Voir Graphique</button>

        <div class="mt-2 text-center" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button onclick="showDashboardView()" aria-label="Retourner au tableau de bord">Retour Tableau de Bord</button>
            <button id="copyForAIGoalsBtn" onclick="copyDataForAIGoals()" aria-label="Copier donn√©es pour objectifs IA">Copier pour Objectifs IA</button>
            <button onclick="openModal('aiImportPopup')" aria-label="Importer suggestions IA">Importer Suggs. IA</button>
            <button id="personalizeBtn" onclick="openModal('customizationPopup')" aria-label="Options personnalisation" style="display: none;">Personnaliser</button>
            <button onclick="openModal('helpPopup')" aria-label="Ouvrir l'aide">Aide</button>
        </div>
    </div>

    <!-- Chart View -->
    <div id="chartView" class="main-view" style="display: none;">
        <h2>Votre Roue de la Vie</h2>
        <canvas id="radarChart" aria-label="Graphique radar des scores"></canvas>
        <div class="mt-2 mb-2" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
             <button onclick="showDashboardView()" aria-label="Retourner au tableau de bord">Retour Tableau de Bord</button>
             <button onclick="openModal('historyPopup')" aria-label="Ouvrir historique">Historique</button>
             <button onclick="showInputView(currentPillarIndex)" aria-label="Retourner √† l'√©valuation">Retour √âvaluation</button>
        </div>
    </div>

    <!-- Overlay & Modals Container -->
    <div id="overlay" onclick="closeAllModals()">

        <!-- History Popup -->
        <div id="historyPopup" class="popup" role="dialog" aria-labelledby="historyTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('historyPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h3 id="historyTitle">Historique des √©valuations</h3>
            <div class="history-scroll-container text-center">
                <button id="historyScrollToBottomBtn" class="icon-button" onclick="historyScrollToBottom()" title="Aller aux boutons" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11,4H13V16L18.5,10.5L19.92,11.92L12,19.84L4.08,11.92L5.5,10.5L11,16V4Z" /></svg>
                </button>
            </div>
             <div id="miniTrendGraphContainer"></div>
            <div id="historyContent"></div>
            <div id="compareControls" class="mt-1 text-center" style="display: none;">
                <button id="compareBtn" onclick="compareSelectedEntries()" disabled>Comparer (2)</button>
            </div>
            <div class="popup-buttons">
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button id="importBtn" onclick="document.getElementById('importFile').click()" style="display: none;">Importer</button>
                <button onclick="exportData()" class="button-like" style="display: none;">Exporter Tout (JSON)</button>
                <button onclick="openModal('actionKeysPopup')">Voir Actions Cl√©s</button>
                <button onclick="copyHistory()">Copier Historique pour IA</button>
                <button onclick="resetApp()" class="danger-button">Tout R√©initialiser</button>
                <button onclick="closeModal('historyPopup')">Fermer</button>
            </div>
        </div>

        <!-- Customization Popup -->
        <div id="customizationPopup" class="popup" role="dialog" aria-labelledby="customizationTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('customizationPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h3 id="customizationTitle">Renommer Piliers / Sous-Piliers</h3>
            <div id="customizationContent"></div>
            <p style="font-size: 0.9em; color: var(--secondary-text-color);">Note : Seul le renommage est support√© via cette interface.</p>
            <div class="popup-buttons">
                <button onclick="saveCustomization()">Sauvegarder & Fermer</button>
                <button onclick="closeModal('customizationPopup')">Annuler</button>
            </div>
        </div>

        <!-- Help Popup -->
        <div id="helpPopup" class="popup" role="dialog" aria-labelledby="helpTitle" aria-modal="true" onclick="event.stopPropagation()">
             <button onclick="closeModal('helpPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
             <h3 id="helpTitle">Aide - La Roue de la Vie</h3>
             <p>√âvaluez votre vie, d√©finissez des objectifs, et suivez vos actions.</p>
             <h5>Flux Principal :</h5>
             <ol>
                 <li>**Tableau de Bord :** Vue principale. Affiche les domaines √† travailler (score < objectif) avec vos objectifs/rituels *activ√©s*. Suivez ici vos rituels quotidiens.</li>
                 <li>**√âvaluer / Modifier :** √âvaluation d√©taill√©e (1-10) et d√©finition des objectifs (1-10) pour chaque sous-pilier.</li>
                 <li>**Copier pour Objectifs IA :** G√©n√®re un prompt pour votre IA. Demande des objectifs SMART et rituels en format JSON.</li>
                 <li>**Importer Suggs. IA :** Collez la r√©ponse JSON de l'IA ici.</li>
                 <li>**Revue Suggestions IA (Automatique) :** Popup pour choisir les suggestions IA √† *activer*. Seules les suggestions activ√©es appara√Ætront sur le tableau de bord.</li>
                 <li>**Sauvegarder & Voir Graphique :** Enregistre l'√©valuation et affiche le graphique.</li>
                 <li>**Graphique & Historique :** Visualisation, comparaison, gestion historique.</li>
             </ol>
             <h5>Autres :</h5>
             <ul>
                 <li>**Note (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em; height:1em; vertical-align: -0.125em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>) :** Vos r√©flexions. Affiche aussi les suggestions IA brutes (non-activ√©es). Marquer comme "Action Cl√©".</li>
                 <li>**Indices (?) :** D√©tails sur les domaines.</li>
                 <li>**Actions rapides :** Appliquer "Objectif 10" ou "Notes √† 5" √† un pilier.</li>
                 <li>**Th√®me (‚òÄÔ∏è/üåô) :** Clair / Sombre.</li>
                 <li>**Premium :** Renommage, Import/Export complet.</li>
             </ul>
             <div class="popup-buttons"> <button onclick="closeModal('helpPopup')">Fermer</button> </div>
        </div>

        <!-- Note Popup -->
        <div id="notePopup" class="popup" role="dialog" aria-labelledby="notePopupTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('notePopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h4 id="notePopupTitle">Note & Suggestions pour <span id="notePopupSubPillarName"></span></h4>
            <textarea id="notePopupTextarea" placeholder="Vos r√©flexions..." aria-label="Note personnelle"></textarea>
            <div class="action-key-checkbox">
                 <input type="checkbox" id="notePopupActionKey">
                 <label for="notePopupActionKey">Marquer comme Action Cl√©</label>
            </div>
            <div id="aiSuggestionsDisplay" style="margin-top: 20px; display: none;">
                 <h5>Suggestions IA (Brutes - Non Activ√©es) :</h5>
                 <div id="aiGoalsList" style="display: none;"><h6>Objectifs Sugg√©r√©s :</h6><ul></ul></div>
                 <div id="aiRitualsList" style="margin-top: 10px; display: none;"><h6>Rituels Sugg√©r√©s :</h6><ul></ul></div>
                 <p style="font-size: 0.8em; color: var(--secondary-text-color); margin-top: 10px;">Utilisez l'Import et la Revue pour activer celles qui vous conviennent.</p>
             </div>
            <div class="popup-buttons">
                <button id="saveNoteBtn" onclick="saveNoteFromPopup()">Sauvegarder Note</button>
                <button onclick="closeModal('notePopup')">Fermer</button>
            </div>
        </div>

        <!-- Action Keys Popup -->
        <div id="actionKeysPopup" class="popup" role="dialog" aria-labelledby="actionKeysTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('actionKeysPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h3 id="actionKeysTitle">Vos Actions Cl√©s</h3>
            <div id="actionKeysContent"></div>
             <p style="font-size: 0.85em; color: var(--secondary-text-color); margin-top:15px;">Notes marqu√©es.</p>
            <div class="popup-buttons"> <button onclick="closeModal('actionKeysPopup')">Fermer</button> </div>
        </div>

        <!-- AI Import Popup -->
        <div id="aiImportPopup" class="popup" role="dialog" aria-labelledby="aiImportTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('aiImportPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h3 id="aiImportTitle">Importer Suggestions IA</h3>
            <p>Collez ici la r√©ponse JSON de l'IA.</p>
            <textarea id="aiImportTextarea" placeholder="Collez le JSON ici..." aria-label="Zone pour coller JSON"></textarea>
            <div class="popup-buttons">
                <button onclick="importAIGeneratedData()">Importer & Ouvrir Revue</button>
                <button onclick="closeModal('aiImportPopup')">Annuler</button>
            </div>
        </div>

        <!-- Review Suggestions Popup -->
        <div id="reviewSuggestionsPopup" class="popup" role="dialog" aria-labelledby="reviewSuggestionsTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('reviewSuggestionsPopup')" class="popup-close-btn" aria-label="Fermer">√ó</button>
            <h3 id="reviewSuggestionsTitle">Revue & Activation Suggestions IA</h3>
            <p>Cochez les objectifs/rituels √† activer sur votre tableau de bord.</p>
            <div id="reviewSuggestionsContent">
                <!-- Contenu g√©n√©r√© par renderReviewSuggestionsModal() -->
            </div>
            <div class="popup-buttons">
                <button onclick="saveSelectedSuggestions()">Valider et Activer S√©lection</button>
                <button onclick="closeModal('reviewSuggestionsPopup')">Annuler</button>
            </div>
        </div>

    </div> <!-- Fin #overlay -->

<!-- FIN PARTIE 2/3 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        // --- Constants & Icons ---
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`;
        const noteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>`;
        const helpIcon = `<span class="help-icon" aria-hidden="true" tabindex="0">?</span>`;

        // --- Default Data Structure ---
        const defaultSubPillarStructure = {
            id: "", name: "", score: 5, note: "", goal: 10, isAction: false,
            aiGoals: [], aiRituals: [], // Suggestions brutes
            activeGoals: [], // Objectifs s√©lectionn√©s
            activeRituals: [], // Rituels s√©lectionn√©s [{ text: string, completed: boolean }]
            tooltip: ""
        };
		function createDefaultSubPillar(id, name, tooltip = "") {
			// Utilise JSON.parse/stringify pour une copie profonde garantie de la structure
			const structureCopy = JSON.parse(JSON.stringify(defaultSubPillarStructure));
			// Applique ensuite les valeurs sp√©cifiques
			structureCopy.id = id;
			structureCopy.name = name;
			structureCopy.tooltip = tooltip;
			return structureCopy;
		}

        // Default pillar/sub-pillar data (COMPLET)
        // Default pillar/sub-pillar data (AVEC LES IC√îNES SP√âCIFIQUES DE L'IMAGE)
        const defaultPillarsData = [
             { id: "sante", name: "Sant√©", tooltip: "Bien-√™tre physique et mental g√©n√©ral.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Sant√©</title><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35M16,5V9H8V5H16M15,6H13V8H15V6M11,6H9V8H11V6Z" /></svg>`, // Coeur avec ECG
               subPillars: [ createDefaultSubPillar("sante-phy", "Physique", "..."), createDefaultSubPillar("sante-men", "Mental", "..."), createDefaultSubPillar("sante-som", "Sommeil", "..."), createDefaultSubPillar("sante-nut", "Nutrition", "..."), createDefaultSubPillar("sante-ene", "√ânergie", "...") ]
             },
             { id: "famille", name: "Famille", tooltip: "Relations avec les membres de la famille proche.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Famille</title><path d="M16 17V19H2V17S2 13 9 13 16 17 16 17M12.5 7.5A3.5 3.5 0 1 0 9 11A3.5 3.5 0 0 0 12.5 7.5M15.94 13A5.32 5.32 0 0 1 18 17V19H22V17S22 13.37 15.94 13M15 7.5A3.5 3.5 0 1 0 11.5 11A3.5 3.5 0 0 0 15 7.5Z" /></svg>`, // Groupe de 3 personnes
               subPillars: [ createDefaultSubPillar("fam-pro", "Proches", "..."), createDefaultSubPillar("fam-com", "Communication", "..."), createDefaultSubPillar("fam-tmp", "Temps pass√©", "..."), createDefaultSubPillar("fam-sou", "Soutien", "..."), createDefaultSubPillar("fam-har", "Harmonie", "...") ]
             },
             { id: "finances", name: "Finances", tooltip: "Gestion de l'argent et s√©curit√© financi√®re.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Finances</title><path d="M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19A7,7 0 0,1 5,12A7,7 0 0,1 12,5M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M13,10H11V11H10V13H11V14H13V13H14V11H13V10M12,7.5A1.5,1.5 0 0,1 13.5,9A1.5,1.5 0 0,1 12,10.5A1.5,1.5 0 0,1 10.5,9A1.5,1.5 0 0,1 12,7.5M12,13.5A1.5,1.5 0 0,1 13.5,15A1.5,1.5 0 0,1 12,16.5A1.5,1.5 0 0,1 10.5,15A1.5,1.5 0 0,1 12,13.5Z" /></svg>`, // Stack de pi√®ces g√©n√©rique
               subPillars: [ createDefaultSubPillar("fin-0", "Revenus", "..."), createDefaultSubPillar("fin-1", "√âpargne", "..."), createDefaultSubPillar("fin-2", "D√©penses", "..."), createDefaultSubPillar("fin-3", "Investissements", "..."), createDefaultSubPillar("fin-4", "S√©curit√©", "...") ]
             },
             { id: "carriere", name: "Carri√®re", tooltip: "Travail, profession, activit√© principale.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Carri√®re</title><path d="M20,6C20,4.9 19.1,4 18,4H6C4.9,4 4,4.9 4,6V8H20V6M4,18V9H20V18A2,2 0 0,1 18,20H6A2,2 0 0,1 4,18M14,13H10V15H14V13Z" /></svg>`, // Mallette simple
               subPillars: [ createDefaultSubPillar("car-0", "Satisfaction", "..."), createDefaultSubPillar("car-1", "Progression", "..."), createDefaultSubPillar("car-2", "√âquilibre", "..."), createDefaultSubPillar("car-3", "Comp√©tences", "..."), createDefaultSubPillar("car-4", "Reconnaissance", "...") ]
             },
             { id: "loisirs", name: "Loisirs", tooltip: "Activit√©s de d√©tente, passions et temps libre.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Loisirs</title><path d="M16.5,9L13.5,12L16.5,15H22V9M9,16.5V22H15V16.5L12,13.5M7.5,9H2V15H7.5L10.5,12M15,7.5V2H9V7.5L12,10.5L15,7.5Z" /></svg>`, // Manette abstraite
               subPillars: [ createDefaultSubPillar("loi-0", "Temps libre", "..."), createDefaultSubPillar("loi-1", "Passions", "..."), createDefaultSubPillar("loi-2", "D√©tente", "..."), createDefaultSubPillar("loi-3", "Cr√©ativit√©", "..."), createDefaultSubPillar("loi-4", "Social", "...") ]
             },
             { id: "devperso", name: "D√©veloppement perso", tooltip: "Croissance personnelle, apprentissage et objectifs.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>D√©veloppement Personnel</title><path d="M9,10V12H7V10H9M13,10V12H11V10H13M17,10V12H15V10H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12C22,11.5 22,11 21.9,10.5L20.1,10.6C20,11 20,11.5 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.8,4 13.5,4.1 14.2,4.4L15.6,2.9C14.5,2.3 13.3,2 12,2M19.5,6.5L21.6,5.4C21.3,4.6 20.9,3.8 20.5,3.1L18.7,4.2C19.1,5 19.4,5.7 19.5,6.5M17.6,8.9L19.2,7.7C19.2,7.9 19.1,8.1 19.1,8.4C18.9,9.1 18.6,9.9 18.2,10.6L16.4,9.5C16.8,8.8 17.3,8.5 17.6,8.9Z" /></svg>`, // Cerveau abstrait
               subPillars: [ createDefaultSubPillar("dev-0", "Apprentissage", "..."), createDefaultSubPillar("dev-1", "Objectifs", "..."), createDefaultSubPillar("dev-2", "Confiance", "..."), createDefaultSubPillar("dev-3", "R√©silience", "..."), createDefaultSubPillar("dev-4", "Clart√©", "...") ]
             },
             { id: "relations", name: "Relations sociales", tooltip: "Liens avec les amis, coll√®gues, communaut√©.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Relations Sociales</title><path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M12,14C14.67,14 17,14.89 17,16V17H7V16C7,14.89 9.33,14 12,14Z" /></svg>`, // Groupe simple
               subPillars: [ createDefaultSubPillar("rel-0", "Amis", "..."), createDefaultSubPillar("rel-1", "R√©seau", "..."), createDefaultSubPillar("rel-2", "√âcoute", "..."), createDefaultSubPillar("rel-3", "Partage", "..."), createDefaultSubPillar("rel-4", "Qualit√©", "...") ]
             },
             { id: "cadrevie", name: "Cadre de vie", tooltip: "Environnement mat√©riel et organisationnel.",
               iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><title>Cadre de vie</title><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>`, // Maison simple
               subPillars: [ createDefaultSubPillar("cad-0", "Logement", "..."), createDefaultSubPillar("cad-1", "Environnement", "..."), createDefaultSubPillar("cad-2", "Organisation", "..."), createDefaultSubPillar("cad-3", "Confort", "..."), createDefaultSubPillar("cad-4", "Esth√©tique", "...") ]
             }
        ];

<!-- FIN PARTIE 2/3 -->

<!-- DEBUT PARTIE 3/3 -->

        // --- Global Variables ---
        let pillars = [];
        let history = [];
        let currentPillarIndex = 0;
        let chartInstance = null;
        let isPremium = false;
        let longPressTimer = null;
        const PREMIUM_PRESS_DURATION = 10000; // 10 seconds
        const pillarColors = ['var(--pillar-color-0)', 'var(--pillar-color-1)', 'var(--pillar-color-2)', 'var(--pillar-color-3)', 'var(--pillar-color-4)', 'var(--pillar-color-5)', 'var(--pillar-color-6)', 'var(--pillar-color-7)'];
        const MINI_TREND_COUNT = 7;
        let suggestionsToReview = []; // Pour stocker temporairement les suggestions √† reviewer

        // --- DOM References (Assurez-vous que tous les IDs existent dans le HTML) ---
		const welcomeView = document.getElementById('welcomeView');
        const dashboardView = document.getElementById('dashboardView');
        const dashboardContent = document.getElementById('dashboardContent');
        const noDashboardItems = document.getElementById('noDashboardItems');
        const inputView = document.getElementById('inputView');
        const chartView = document.getElementById('chartView');
        const pillarDisplay = document.getElementById('pillarDisplay');
        const globalScoreDisplay = document.getElementById('globalScore');
        const pillarAverageScoreDisplay = document.getElementById('pillarAverageScore');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const radarChartCanvas = document.getElementById('radarChart');
        const historyContent = document.getElementById('historyContent');
        const overlay = document.getElementById('overlay');
        const themeCheckbox = document.getElementById('theme-checkbox');
        const customizationContent = document.getElementById('customizationContent');
        const showChartBtn = document.getElementById('showChartBtn');
        const notePopup = document.getElementById('notePopup');
        const notePopupSubPillarName = document.getElementById('notePopupSubPillarName');
        const notePopupTextarea = document.getElementById('notePopupTextarea');
        const notePopupActionKeyCheckbox = document.getElementById('notePopupActionKey');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const historyPopup = document.getElementById('historyPopup');
        const historyScrollBtn = document.getElementById('historyScrollToBottomBtn');
        const personalizeBtn = document.getElementById('personalizeBtn');
        const importBtn = document.getElementById('importBtn');
        const appLogo = document.getElementById('appLogo');
        const loadingMessage = document.getElementById('loadingMessage');
        const notification = document.getElementById('notification');
        const actionKeysPopup = document.getElementById('actionKeysPopup');
        const actionKeysContent = document.getElementById('actionKeysContent');
        const miniTrendGraphContainer = document.getElementById('miniTrendGraphContainer');
        const aiImportPopup = document.getElementById('aiImportPopup');
        const aiImportTextarea = document.getElementById('aiImportTextarea');
        const aiSuggestionsDisplay = document.getElementById('aiSuggestionsDisplay');
        const aiGoalsListContainer = document.getElementById('aiGoalsList');
        const aiRitualsListContainer = document.getElementById('aiRitualsList');
        const reviewSuggestionsPopup = document.getElementById('reviewSuggestionsPopup');
        const reviewSuggestionsContent = document.getElementById('reviewSuggestionsContent');


        // --- Utility Functions ---
        function getCssVar(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
        function generateId(prefix = 'item') { return `${prefix.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`; }
        function showNotification(message, duration = 3000) { notification.textContent = message; notification.style.display = 'block'; if (notification.timer) clearTimeout(notification.timer); notification.timer = setTimeout(() => { notification.style.display = 'none'; }, duration); }
        function debounce(func, wait) { let timeout; return function (...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }

        // --- Core Application Logic ---

        function initializeApp() {
            try {
                loadData();
                setupTheme();
                updatePremiumUI();
                const welcomeDismissed = localStorage.getItem('wheelOfLife_welcomeDismissed') === 'true';
                if (!welcomeDismissed) {
                    showWelcomeView();
                } else {
                    showDashboardView(); // Afficher Dashboard par d√©faut si accueil pass√©
                }
                addEventListeners();
                window.addEventListener('load', () => showNotification("Application charg√©e et pr√™te hors ligne !"));
            } catch (error) { console.error("Erreur init:", error); /* ... gestion ... */ }
            finally { loadingMessage.style.display = 'none'; }
        }

        function handleNoPillars() {
             inputView.style.display = 'block'; // Afficher au moins la vue input m√™me si vide
             chartView.style.display = 'none';
             dashboardView.style.display = 'none';
             welcomeView.style.display = 'none';
             pillarDisplay.innerHTML = "<p class='text-center'>Aucun pilier d√©fini. R√©initialisez ou rechargez.</p>";
             globalScoreDisplay.textContent = `Note globale : - / 20`;
             pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
             prevBtn.disabled = true; nextBtn.disabled = true; showChartBtn.disabled = true;
             inputView.style.setProperty('--pillar-border-color', 'transparent');
             if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
        }

        function loadData() {
            const storedPillars = localStorage.getItem('wheelOfLife_pillars');
            const storedHistory = localStorage.getItem('wheelOfLife_history');
            try {
                const parsedPillars = storedPillars ? JSON.parse(storedPillars) : null;
                pillars = parsedPillars && Array.isArray(parsedPillars) && parsedPillars.length > 0
                          ? migrateDataStructure(parsedPillars)
                          : JSON.parse(JSON.stringify(defaultPillarsData)); // Utilise la copie profonde des d√©fauts
            } catch (e) { console.error("Erreur chargement piliers:", e); pillars = JSON.parse(JSON.stringify(defaultPillarsData)); localStorage.removeItem('wheelOfLife_pillars'); showNotification("Donn√©es piliers corrompues. R√©initialisation."); }
            try {
                const parsedHistory = storedHistory ? JSON.parse(storedHistory) : [];
                history = Array.isArray(parsedHistory) ? parsedHistory.filter(entry => entry && entry.date && entry.timestamp && Array.isArray(entry.scores)) : [];
                history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            } catch (e) { console.error("Erreur chargement historique:", e); history = []; localStorage.removeItem('wheelOfLife_history'); showNotification("Historique corrompu. R√©initialisation."); }
            if (!Array.isArray(pillars) || pillars.length === 0) { console.warn("Pillars invalides apr√®s chargement, for√ßage d√©fauts."); pillars = JSON.parse(JSON.stringify(defaultPillarsData)); }
            currentPillarIndex = 0;
            isPremium = localStorage.getItem('wheelOfLife_premiumStatus') === 'true';
        }

        function migrateDataStructure(loadedPillars) {
             if (!Array.isArray(loadedPillars)) return JSON.parse(JSON.stringify(defaultPillarsData));

             // ***** AJOUTER CES LIGNES CI-DESSOUS *****
             const defaultMap = new Map();
             defaultPillarsData.forEach(dp => {
                 const subMap = new Map();
                 // Assure-toi que createDefaultSubPillar est bien d√©fini AVANT migrateDataStructure
                 dp.subPillars.forEach(dsp => subMap.set(dsp.id, createDefaultSubPillar(dsp.id, dsp.name, dsp.tooltip)));
                 defaultMap.set(dp.id, { pillar: dp, subPillars: subMap });
             });
             // ***** FIN DES LIGNES √Ä AJOUTER *****

             return loadedPillars.map((p, pIdx) => {
                 const pillarBase = p || {};
                 // Utilise defaultMap ici (cette partie devrait d√©j√† exister)
                 const defaultPillarData = defaultMap.get(pillarBase.id)?.pillar || defaultPillarsData[pIdx] || { name: `Pilier ${pIdx+1}`, id: generateId(`pillar-${pIdx}`), tooltip: "", subPillars: [] };
                 const defaultSubPillarsMap = defaultMap.get(pillarBase.id)?.subPillars || new Map();

                 return {
                    // ... le reste de la logique de mapping/migration ...
                     id: pillarBase.id || defaultPillarData.id,
                     name: pillarBase.name || defaultPillarData.name,
                     tooltip: pillarBase.tooltip || defaultPillarData.tooltip,
                     iconSvg: pillarBase.iconSvg || defaultPillarData.iconSvg || `<svg>...</svg>`, // Garder l'ic√¥ne

                     subPillars: Array.isArray(pillarBase.subPillars) ? pillarBase.subPillars.map((sp, spIdx) => {
                        // ... la logique interne pour chaque sous-pilier reste la m√™me ...
                        const subPillarBase = typeof sp === 'string' ? { name: sp } : (sp || {});
                        const defaultSubPillarData = defaultSubPillarsMap.get(subPillarBase.id) || defaultPillarData.subPillars?.[spIdx] || createDefaultSubPillar("temp-id", "temp-name");
                        // ... etc ... (le reste de la fonction est inchang√©)
                        const loadedActiveGoals = Array.isArray(subPillarBase.activeGoals) ? subPillarBase.activeGoals.filter(g => typeof g === 'string') : [];
						const loadedActiveRituals = Array.isArray(subPillarBase.activeRituals)
							? subPillarBase.activeRituals
								.map(r => (typeof r === 'object' && r !== null && typeof r.text === 'string') ? { text: r.text, completed: !!r.completed } : null)
								.filter(r => r !== null)
							: [];
						const loadedAiGoals = Array.isArray(subPillarBase.aiGoals) ? subPillarBase.aiGoals.filter(g => typeof g === 'string') : [];
						const loadedAiRituals = Array.isArray(subPillarBase.aiRituals) ? subPillarBase.aiRituals.filter(r => typeof r === 'string') : [];


						const migratedSubPillar = {
							...createDefaultSubPillar(
								 subPillarBase.id || defaultSubPillarData.id || generateId('migrated-sub'),
								 subPillarBase.name || defaultSubPillarData.name || `Sous-Pilier ${spIdx + 1}`,
								 subPillarBase.tooltip || defaultSubPillarData.tooltip
							),
							score: (subPillarBase.score !== undefined && !isNaN(parseInt(subPillarBase.score))) ? parseInt(subPillarBase.score) : defaultSubPillarData.score,
							goal: (subPillarBase.goal !== undefined && !isNaN(parseInt(subPillarBase.goal))) ? parseInt(subPillarBase.goal) : defaultSubPillarData.goal,
							isAction: typeof subPillarBase.isAction === 'boolean' ? subPillarBase.isAction : defaultSubPillarData.isAction,
							note: typeof subPillarBase.note === 'string' ? subPillarBase.note : defaultSubPillarData.note,
							aiGoals: loadedAiGoals,
							aiRituals: loadedAiRituals,
							activeGoals: loadedActiveGoals,
							activeRituals: loadedActiveRituals
						};
						return migratedSubPillar;
                     }) : (defaultPillarData.subPillars ? JSON.parse(JSON.stringify(defaultPillarData.subPillars)) : [])
                 };
             }).filter(p => p.name && p.id);
        }


        const debouncedSaveData = debounce(saveData, 500);
        function saveData() { try { localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars)); localStorage.setItem('wheelOfLife_history', JSON.stringify(history)); } catch (e) { /* ... gestion erreur ... */ } }

        // --- Premium Handling ---
        function savePremiumStatus() { localStorage.setItem('wheelOfLife_premiumStatus', isPremium); }
        function activatePremium() { if (isPremium) return; isPremium = true; savePremiumStatus(); updatePremiumUI(); showNotification("Mode Premium activ√© !", 4000); }
        function updatePremiumUI() { const displayValue = isPremium ? 'inline-block' : 'none'; if (personalizeBtn) personalizeBtn.style.display = displayValue; if (importBtn) importBtn.style.display = displayValue; const exportBtn = document.querySelector('button[onclick="exportData()"]'); if (exportBtn) exportBtn.style.display = displayValue; /* ... aide ... */ }
        function handleLogoPressStart(event) { event.preventDefault(); clearTimeout(longPressTimer); if (appLogo) appLogo.style.filter = 'brightness(0.8)'; longPressTimer = setTimeout(activatePremium, PREMIUM_PRESS_DURATION); }
        function handleLogoPressEnd() { clearTimeout(longPressTimer); if (appLogo) appLogo.style.filter = 'brightness(1)'; }

        // --- Pillar Rendering & Interaction (Input View) ---
        // --- Pillar Rendering & Interaction (Input View) ---
        function renderPillar() {
             if (!pillars || pillars.length === 0) { handleNoPillars(); return; }
             if (currentPillarIndex < 0 || currentPillarIndex >= pillars.length) currentPillarIndex = 0;
             const pillar = pillars[currentPillarIndex];
             const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
             inputView.style.setProperty('--pillar-border-color', pillarColor);

             // ***** LIGNE CORRIG√âE CI-DESSOUS *****
             const navContainer = document.getElementById('pillarNavigation');
             navContainer.innerHTML = pillars.map((p, idx) => `
                 <button class="pillar-nav-button pillar-icon-button ${idx === currentPillarIndex ? 'active' : ''}"
                         onclick="navigateToPillar(${idx})"
                         aria-label="Aller au pilier ${p.name}"
                         title="${p.name}"
                         aria-current="${idx === currentPillarIndex ? 'true' : 'false'}">
                     ${p.iconSvg || '?'}
                 </button>
             `).join('');
             // ************************************

             const createTooltip = (text) => text ? `<span class="help-icon" aria-hidden="true" tabindex="0">?<span class="tooltiptext">${text}</span></span>` : '';
             let pillarHTML = `<h3 id="pillar-title"><span>${pillar.name}</span>${createTooltip(pillar.tooltip)}<span style="font-weight:normal; font-size: 0.8em; margin-left: auto;">(${currentPillarIndex + 1}/${pillars.length})</span></h3><div class="pillar-actions"><button onclick="applyPlusOneGoalToPillar('${pillar.id}')" aria-label="Appliquer l'objectif 'Score + 1' (max 10) √† tous les sous-piliers de ${pillar.name}">Objectif +1 pour tous</button><button onclick="resetPillarScores('${pillar.id}', 5)">Notes √† 5</button></div>`;
             if (!pillar.subPillars || pillar.subPillars.length === 0) { pillarHTML += "<p class='text-center'>Pas de sous-piliers.</p>"; }
             else { pillar.subPillars.forEach((sp) => { const score = sp.score ?? 5; const goal = sp.goal ?? 10; pillarHTML += `<div class="sub-pillar" id="subpillar-div-${sp.id}"><div class="sub-pillar-header"><label for="range-${sp.id}" id="label-${sp.id}"><span>${sp.name}</span>${createTooltip(sp.tooltip)}</label><div class="sub-pillar-controls"><input type="range" id="range-${sp.id}" min="1" max="10" value="${score}" oninput="updateScore('${pillar.id}', '${sp.id}', this.value, true)" aria-labelledby="label-${sp.id} slider-value-${sp.id}" aria-valuemin="1" aria-valuemax="10" aria-valuenow="${score}"><output class="slider-value" id="slider-value-${sp.id}" for="range-${sp.id}">${score}</output></div></div><div class="sub-pillar-details"><div class="detail-group"><label for="goal-${sp.id}">Objectif:</label><input type="number" id="goal-${sp.id}" min="1" max="10" value="${goal}" onchange="updateGoal('${pillar.id}', '${sp.id}', this.value)" aria-label="Objectif pour ${sp.name}"></div><div class="detail-group"><button class="note-button" onclick="openNotePopup('${pillar.id}', '${sp.id}')" aria-label="Note & Suggestions pour ${sp.name}">${noteIcon}</button></div></div></div>`; }); }
             pillarDisplay.innerHTML = pillarHTML;
             updateNavigationButtons(); updateScoresDisplay(); showChartBtn.disabled = false;
        }
        function findSubPillar(pillarId, subPillarId) { const p = pillars.find(p => p.id === pillarId); return p?.subPillars?.find(sp => sp.id === subPillarId) || null; }
        const debouncedUpdateScoresDisplay = debounce(updateScoresDisplay, 150);
        function updateScore(pillarId, subPillarId, value, fromInput = false) { const score = parseInt(value); if (isNaN(score) || score < 1 || score > 10) return; const sp = findSubPillar(pillarId, subPillarId); if (sp) { sp.score = score; if (fromInput) { document.getElementById(`slider-value-${subPillarId}`).textContent = score; document.getElementById(`range-${subPillarId}`).setAttribute('aria-valuenow', score); } debouncedUpdateScoresDisplay(); debouncedSaveData(); } }
        function updateNote(pillarId, subPillarId, noteValue, isActionValue) { const sp = findSubPillar(pillarId, subPillarId); if (sp) { sp.note = noteValue.trim(); sp.isAction = !!isActionValue; debouncedSaveData(); } }
        function updateGoal(pillarId, subPillarId, value) { const goal = parseInt(value); const input = document.getElementById(`goal-${subPillarId}`); const sp = findSubPillar(pillarId, subPillarId); if (sp) { if (!isNaN(goal) && goal >= 1 && goal <= 10) { sp.goal = goal; debouncedSaveData(); } else { if (input) input.value = sp.goal ?? 10; showNotification("L'objectif doit √™tre entre 1 et 10.", 3000); } } }
        function applyGoalToAllSubPillars(pillarId, goalValue) { const p = pillars.find(p => p.id === pillarId); if (!p?.subPillars) return; let changed = false; p.subPillars.forEach(sp => { if (sp.goal !== goalValue) { sp.goal = goalValue; const input = document.getElementById(`goal-${sp.id}`); if (input) input.value = goalValue; changed = true; } }); if (changed) { debouncedSaveData(); showNotification(`Objectif ${goalValue} appliqu√© √† "${p.name}".`); } else { showNotification(`Objectifs d√©j√† √† ${goalValue}.`); } }
		
		// NOUVEAU: Appliquer Objectif = Score + 1 (max 10) √† un pilier
        function applyPlusOneGoalToPillar(pillarId) {
            const pillar = pillars.find(p => p.id === pillarId);
            if (!pillar || !Array.isArray(pillar.subPillars)) {
                console.error(`Pilier non trouv√© pour +1 objectif: ${pillarId}`);
                showNotification("Erreur: Pilier non trouv√©.", 3000);
                return;
            }

            let changed = false;
            pillar.subPillars.forEach(sp => {
                // Utilise le score actuel, ou 5 si non d√©fini (devrait l'√™tre mais s√©curit√©)
                const currentScore = sp.score ?? 5;
                // Objectif actuel, ou 10 si non d√©fini
                const currentGoal = sp.goal ?? 10;

                // Calcule le nouvel objectif : score + 1, mais plafonn√© √† 10
                const targetGoal = Math.min(currentScore + 1, 10);

                // Met √† jour seulement si le nouvel objectif est diff√©rent de l'actuel
                if (targetGoal !== currentGoal) {
                    sp.goal = targetGoal; // Met √† jour le mod√®le de donn√©es

                    // Met √† jour l'input num√©rique dans l'interface utilisateur
                    const goalInput = document.getElementById(`goal-${sp.id}`);
                    if (goalInput) {
                        goalInput.value = targetGoal;
                    } else {
                         console.warn(`Input d'objectif non trouv√© pour le sous-pilier ${sp.id}`);
                     }
                    changed = true;
                }
            });

            if (changed) {
                debouncedSaveData(); // Sauvegarde les donn√©es si des changements ont eu lieu
                showNotification(`Objectifs mis √† jour √† "Score + 1" (max 10) pour "${pillar.name}".`);
            } else {
                showNotification(`Aucun objectif √† mettre √† jour pour "${pillar.name}" (Score + 1 d√©j√† atteint ou score = 10).`);
            }
        }

		
		function resetPillarScores(pillarId, scoreValue) { const p = pillars.find(p => p.id === pillarId); if (!p?.subPillars) return; let changed = false; p.subPillars.forEach(sp => { if (sp.score !== scoreValue) { sp.score = scoreValue; const range = document.getElementById(`range-${sp.id}`); const output = document.getElementById(`slider-value-${sp.id}`); if (range) { range.value = scoreValue; range.setAttribute('aria-valuenow', scoreValue); } if (output) output.textContent = scoreValue; changed = true; } }); if (changed) { debouncedUpdateScoresDisplay(); debouncedSaveData(); showNotification(`Notes r√©initialis√©es √† ${scoreValue} pour "${p.name}".`); } else { showNotification(`Notes d√©j√† √† ${scoreValue}.`); } }
        function calculateAverages() { if (!pillars || pillars.length === 0) return { pillarAverages: [], globalScore: 0 }; const pillarAverages = pillars.map(p => { if (!p.subPillars || p.subPillars.length === 0) return NaN; const validScores = p.subPillars.map(s => s.score).filter(s => typeof s === 'number' && !isNaN(s)); if (validScores.length === 0) return NaN; return validScores.reduce((a, b) => a + b, 0) / validScores.length; }); const validPillarAverages = pillarAverages.filter(avg => !isNaN(avg)); const globalAverage = validPillarAverages.length > 0 ? validPillarAverages.reduce((a, b) => a + b, 0) / validPillarAverages.length : 0; return { pillarAverages, globalScore: globalAverage * 2 }; }
        function updateScoresDisplay() { if (!pillars || pillars.length === 0) { globalScoreDisplay.textContent = `Note globale : - / 20`; pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`; return; } const { pillarAverages, globalScore } = calculateAverages(); globalScoreDisplay.textContent = `Note globale : ${globalScore.toFixed(1)} / 20`; const currentAvg = pillarAverages[currentPillarIndex]; pillarAverageScoreDisplay.textContent = `Moyenne Pilier : ${!isNaN(currentAvg) ? currentAvg.toFixed(1) : '-'} / 10`; }
        function navigateToPillar(index) { if (index === currentPillarIndex || index < 0 || index >= pillars.length) return; currentPillarIndex = index; renderPillar(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function changePillar(direction) { if (!pillars || pillars.length <= 1) return; let newIndex = currentPillarIndex + direction; if (newIndex < 0) newIndex = pillars.length - 1; else if (newIndex >= pillars.length) newIndex = 0; navigateToPillar(newIndex); }
        function updateNavigationButtons() { const num = pillars ? pillars.length : 0; prevBtn.disabled = num <= 1; nextBtn.disabled = num <= 1; }

        // --- Dashboard Rendering & Interaction ---
        function renderDashboard() {
            dashboardContent.innerHTML = ''; // Clear previous content
            let hasItems = false;

            console.log("Rendering dashboard..."); // DEBUG

            if (!pillars || pillars.length === 0) {
                console.warn("renderDashboard called with no pillars loaded.");
                // Fallback: Assurer que le message 'aucun item' s'affiche si pas de piliers
                 const noItemsEl = document.getElementById('noDashboardItems');
                 if (noItemsEl) {
                     noItemsEl.style.display = 'block';
                 } else {
                      console.error("Element #noDashboardItems not found even when no pillars!");
                 }
                return; // Sortir si pas de piliers
            }


            pillars.forEach(pillar => {
                pillar.subPillars.forEach((sp) => {
                    const score = sp.score ?? NaN;
                    const goal = sp.goal ?? NaN;

                    // Condition: Score d√©fini, Objectif d√©fini, Score < Objectif ET (objectifs actifs OU rituels actifs)
                    if (!isNaN(score) && !isNaN(goal) && score < goal &&
                        (Array.isArray(sp.activeGoals) && sp.activeGoals.length > 0 || Array.isArray(sp.activeRituals) && sp.activeRituals.length > 0))
                    {
                        hasItems = true;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'dashboard-item';

                        let itemHTML = `<h4>${pillar.name} > ${sp.name}</h4>`;
                        itemHTML += `<div class="score-info">Score: ${score}/10 (Objectif: ${goal}/10)</div>`;

                        // Afficher Objectifs Actifs
                        if (Array.isArray(sp.activeGoals) && sp.activeGoals.length > 0) {
                            itemHTML += `<h5>Objectifs Actifs :</h5><ul>`;
                            sp.activeGoals.forEach(goalText => {
                                itemHTML += `<li>${goalText}</li>`;
                            });
                            itemHTML += `</ul>`;
                        }

                        // Afficher Rituels Actifs avec Checkbox
                        if (Array.isArray(sp.activeRituals) && sp.activeRituals.length > 0) {
                            itemHTML += `<h5>Rituels Actifs :</h5><ul>`;
                            sp.activeRituals.forEach((ritual, index) => {
                                const checkboxId = `ritual-${sp.id}-${index}`;
                                // Assurer que ritual.text existe et completed est bien un bool√©en
                                const ritualText = (typeof ritual === 'object' && ritual !== null && typeof ritual.text === 'string') ? ritual.text : String(ritual); // Fallback si ancien format
                                const isCompleted = (typeof ritual === 'object' && ritual !== null) ? !!ritual.completed : false;

                                itemHTML += `<li class="dashboard-ritual-item">
                                    <input type="checkbox" id="${checkboxId}"
                                           data-pillar-id="${pillar.id}" data-subpillar-id="${sp.id}" data-ritual-index="${index}"
                                           onchange="toggleRitualCompletion(this)" ${isCompleted ? 'checked' : ''}>
                                    <label for="${checkboxId}">${ritualText}</label>
                                </li>`;
                            });
                            itemHTML += `</ul>`;
                        }

                        itemDiv.innerHTML = itemHTML;
                        dashboardContent.appendChild(itemDiv);
                    }
                });
            });

            // --- Modification Cl√© : Cibler l'√©l√©ment ICI ---
            const noItemsElement = document.getElementById('noDashboardItems');
             console.log("End of renderDashboard. hasItems:", hasItems, "Element #noDashboardItems:", noItemsElement); // DEBUG

            if (noItemsElement) {
                 // Appliquer le style final ici, apr√®s toute manipulation du DOM
                 noItemsElement.style.display = hasItems ? 'none' : 'block';
                 console.log("Setting #noDashboardItems display to:", hasItems ? 'none' : 'block'); // DEBUG
            } else {
                 // Si l'√©l√©ment n'est TOUJOURS pas trouv√©, il y a un probl√®me plus profond
                 console.error("CRITICAL: Element #noDashboardItems could not be found in the DOM after rendering dashboard content!");
                 // Peut-√™tre afficher une notification d'erreur syst√©mique ?
                 // showNotification("Erreur interne: Impossible d'afficher l'√©tat du tableau de bord.", 5000);
            }
        }
		
        function toggleRitualCompletion(checkbox) { const pId = checkbox.dataset.pillarId; const spId = checkbox.dataset.subpillarId; const rIdx = parseInt(checkbox.dataset.ritualIndex); const sp = findSubPillar(pId, spId); if (sp?.activeRituals?.[rIdx]) { sp.activeRituals[rIdx].completed = checkbox.checked; debouncedSaveData(); } else { console.error("Rituel non trouv√© pour toggle"); } }
        function resetDailyRituals() { let changed = false; pillars.forEach(p => p.subPillars.forEach(sp => sp.activeRituals.forEach(r => { if (r.completed) { r.completed = false; changed = true; } }))); if (changed) { saveData(); renderDashboard(); showNotification("Suivi rituels r√©initialis√©."); } else { showNotification("Aucun rituel compl√©t√©."); } }

        // --- View Switching ---
        function showView(viewId) { [welcomeView, dashboardView, inputView, chartView].forEach(v => v.style.display = (v.id === viewId) ? 'block' : 'none'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function showWelcomeView() { showView('welcomeView'); }
        function showDashboardView() { showView('dashboardView'); renderDashboard(); }
        function showInputView(pillarIndexToShow = 0) { currentPillarIndex = (pillarIndexToShow >= 0 && pillarIndexToShow < pillars.length) ? pillarIndexToShow : 0; showView('inputView'); if (pillars.length > 0) renderPillar(); else handleNoPillars(); }
        function showChartView() { showView('chartView'); renderChart(); }
        function startAppFlow() { localStorage.setItem('wheelOfLife_welcomeDismissed', 'true'); showDashboardView(); }

        // --- Chart Rendering ---
        function renderChart(comparisonData = null) { const ctx = radarChartCanvas.getContext('2d'); /* ... le reste de la logique Chart.js (longue mais inchang√©e) ... */ if (chartInstance) { chartInstance.destroy(); chartInstance = null; } /* ... options, data, new Chart(...) ... */ const themeTextColor=getCssVar('--text-color'),themeSecondaryTextColor=getCssVar('--secondary-text-color'),themeGridColor=getCssVar('--grid-color'),themeContainerBgColor=getCssVar('--container-bg'),themeTooltipBgColor=getCssVar('--tooltip-bg');const commonOptions={responsive:!0,maintainAspectRatio:!0,scales:{r:{min:0,max:10,ticks:{stepSize:2,backdropColor:themeContainerBgColor,color:themeSecondaryTextColor,font:{size:10}},pointLabels:{color:themeTextColor,font:{size:11}},grid:{color:themeGridColor},angleLines:{color:themeGridColor}}},plugins:{legend:{position:'top',labels:{color:themeTextColor,usePointStyle:!0,boxWidth:10,padding:15,font:{size:11}}},tooltip:{enabled:!0,backgroundColor:themeTooltipBgColor,titleColor:themeTextColor,bodyColor:themeTextColor,borderColor:themeGridColor,borderWidth:1,padding:10,cornerRadius:4,usePointStyle:!0,callbacks:{label:context=>`${context.dataset.label||""}: ${context.parsed.r!==null?context.parsed.r.toFixed(1):"-"}`}}},animation:{duration:0},elements:{line:{borderWidth:2.5},point:{radius:4,hoverRadius:6,pointStyle:'circle'}}};let chartData,chartOptions={...commonOptions};if(comparisonData){chartData={labels:comparisonData.labels,datasets:comparisonData.datasets.map((dataset,index)=>({...dataset,backgroundColor:index===0?getCssVar('--chart-bg-color'):getCssVar('--goal-bg-color'),borderColor:index===0?getCssVar('--chart-border-color'):getCssVar('--goal-border-color'),pointBackgroundColor:index===0?getCssVar('--chart-border-color'):getCssVar('--goal-border-color'),pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:index===0?getCssVar('--chart-border-color'):getCssVar('--goal-border-color')}))};chartOptions.plugins.legend.labels.usePointStyle=!0}else{if(!pillars||pillars.length===0){if(chartInstance){chartInstance.destroy();chartInstance=null}return}const {pillarAverages}=calculateAverages();const pillarGoalsAverages=pillars.map(p=>{if(!p.subPillars||p.subPillars.length===0)return NaN;const validGoals=p.subPillars.map(s=>s.goal).filter(g=>typeof g==='number'&&!isNaN(g));if(validGoals.length===0)return NaN;return validGoals.reduce((a,b)=>a+b,0)/validGoals.length});const labels=pillars.map(p=>p.name);const scoreBgColor=getCssVar('--chart-bg-color'),scoreBorderColor=getCssVar('--chart-border-color'),goalBgColor=getCssVar('--goal-bg-color'),goalBorderColor=getCssVar('--goal-border-color');chartData={labels:labels,datasets:[{label:'Score Actuel',data:pillarAverages.map(avg=>isNaN(avg)?0:avg),backgroundColor:scoreBgColor,borderColor:scoreBorderColor,pointBackgroundColor:scoreBorderColor,pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:scoreBorderColor},{label:'Objectif Moyen',data:pillarGoalsAverages.map(avg=>isNaN(avg)?0:avg),backgroundColor:goalBgColor,borderColor:goalBorderColor,borderWidth:1.5,borderDash:[6,3],pointBackgroundColor:goalBorderColor,pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:goalBorderColor,pointRadius:3,pointHoverRadius:5}]};chartOptions.plugins.legend.labels.usePointStyle=!1}if(chartInstance){chartInstance.data=chartData;chartInstance.options=chartOptions;chartInstance.update('none')}else{chartInstance=new Chart(ctx,{type:'radar',data:chartData,options:chartOptions})}}

        // --- History Management ---
        function showChartAndSave() { if (!pillars || pillars.length === 0) { showNotification("Aucun pilier."); return; } const { pillarAverages } = calculateAverages(); saveToHistory(pillarAverages); showChartView(); showNotification("√âvaluation sauvegard√©e."); }
        function saveToHistory(currentAverages) { const ts=Date.now(),hr24=864e5;const scoresData=pillars.map((p,idx)=>({pillarId:p.id,pillarName:p.name,average:(!isNaN(currentAverages[idx])?currentAverages[idx]:0),subPillars:JSON.parse(JSON.stringify(p.subPillars||[]))}));const newEntry={id:`hist-${ts}-${Math.random().toString(36).substr(2,5)}`,date:new Date(ts).toLocaleString('fr-FR',{dateStyle:'short',timeStyle:'short'}),timestamp:ts,scores:scoresData};history.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));const lastEntry=history[0]||null;if(lastEntry&&(ts-(lastEntry.timestamp||0))<hr24){history[0]=newEntry}else{history.push(newEntry);history.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0))}const MAX_HISTORY=100;if(history.length>MAX_HISTORY)history=history.slice(0,MAX_HISTORY);saveData(); }
        function showHistory() { historyContent.innerHTML='';miniTrendGraphContainer.innerHTML='';if(history.length===0){historyContent.innerHTML="<p>Aucun historique.</p>";if(historyScrollBtn)historyScrollBtn.style.display='none';document.getElementById('compareControls').style.display='none';return}renderMiniTrendGraph();const ul=document.createElement('ul');history.forEach((entry,idx)=>{if(!entry?.scores)return;const li=document.createElement('li');li.className='history-entry';const entryAvgs=entry.scores.map(s=>s.average).filter(a=>!isNaN(a));const globalScore=entryAvgs.length>0?(entryAvgs.reduce((a,b)=>a+b,0)/entryAvgs.length*2):0;const prevEntry=history[idx+1];let html=`<div style="display:flex;align-items:baseline;gap:10px;margin-bottom:5px;"><input type="checkbox" class="history-compare-checkbox" data-index="${idx}" onchange="updateCompareControls()" aria-label="S√©lectionner ${entry.date}"><strong >${entry.date||'?'}</strong><span style="font-size:0.9em;color:var(--secondary-text-color);">(Global: ${globalScore.toFixed(1)}/20)</span></div><div class="history-scores">`;entry.scores.forEach(cs=>{html+=`${cs.pillarName||'?'}: ${cs.average!==undefined?cs.average.toFixed(1):'-'}`;if(prevEntry?.scores){const ps=prevEntry.scores.find(s=>s.pillarId===cs.pillarId);if(ps&&ps.average!==undefined&&cs.average!==undefined){const diff=cs.average-ps.average;if(Math.abs(diff)>0.05){const diffClass=diff>0?'positive':'negative',diffSign=diff>0?'+':'';html+=` <span class="score-diff ${diffClass}" title="vs ${ps.average.toFixed(1)} le ${prevEntry.date||''}"><!---->(<!---->${diffSign}${diff.toFixed(1)}<!---->)<!----></span>`}}}html+='<br>'});html+='</div>';li.innerHTML=html;ul.appendChild(li)});historyContent.appendChild(ul);document.getElementById('compareControls').style.display='block';updateCompareControls();setTimeout(()=>{if(document.getElementById('historyPopup')){const isScrollable=historyPopup.scrollHeight>historyPopup.clientHeight;historyScrollBtn.style.display=isScrollable?'inline-block':'none'}},100)}
        function renderMiniTrendGraph() { if(history.length<2){miniTrendGraphContainer.innerHTML='';return}const trendData=history.slice(0,MINI_TREND_COUNT).reverse();const scores=trendData.map(e=>{const avgs=e.scores.map(s=>s.average).filter(a=>!isNaN(a));return avgs.length>0?(avgs.reduce((a,b)=>a+b,0)/avgs.length*2):0});const maxVal=20;let graphHTML=`<div class="mini-trend-graph"><h5>Tendance Globale (/20)</h5><div class="trend-bars">`;scores.forEach((score,idx)=>{const percHeight=maxVal>0?(score/maxVal*100):0,dateLabel=trendData[idx].date.split(',')[0];graphHTML+=`<div class="trend-bar-item" title="${trendData[idx].date}: ${score.toFixed(1)}/20"><div class="bar-value">${score.toFixed(1)}</div><div class="trend-bar" style="height:${percHeight}%;"><span>${dateLabel}</span></div></div>`});graphHTML+=`</div></div>`;miniTrendGraphContainer.innerHTML=graphHTML}
        function updateCompareControls() { const boxes=document.querySelectorAll('.history-compare-checkbox:checked');const btn=document.getElementById('compareBtn');if(btn)btn.disabled=boxes.length!==2 }
        function compareSelectedEntries() { const boxes=document.querySelectorAll('.history-compare-checkbox:checked');if(boxes.length!==2){showNotification("S√©lectionnez 2 √©valuations.");return}const indices=Array.from(boxes).map(cb=>parseInt(cb.dataset.index));if(indices.some(isNaN)||indices.some(idx=>idx<0||idx>=history.length)){showNotification("S√©lection invalide.");return}const entries=indices.map(i=>history[i]);if(entries.some(e=>!e?.scores)){showNotification("Donn√©es manquantes.");return}const currentLabels=pillars.map(p=>p.name);const datasets=entries.map(e=>{const data=currentLabels.map(lbl=>{const cp=pillars.find(p=>p.name===lbl);if(!cp)return 0;const hs=e.scores.find(s=>s.pillarId===cp.id);return hs?(hs.average||0):0});return{label:`√âval. ${e.date}`,data:data}});const chartData={labels:currentLabels,datasets:datasets};closeModal('historyPopup');showChartView();renderChart(chartData);showNotification(`Comparaison: ${entries[0].date} vs ${entries[1].date}.`)}

        // --- Action Keys Management ---
        function openActionKeysPopup() { renderActionKeys(); openModal('actionKeysPopup'); }
        function renderActionKeys() { actionKeysContent.innerHTML='';const actions=[];history.forEach(e=>{e?.scores?.forEach(ps=>{ps?.subPillars?.forEach(sp=>{if(sp.isAction&&sp.note)actions.push({date:e.date,pillarName:ps.pillarName,subPillarName:sp.name,note:sp.note})})})});if(actions.length===0){actionKeysContent.innerHTML='<p>Aucune action cl√©.</p><p style="font-size:0.9em;">Utilisez l\'ic√¥ne <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:0.9em;height:0.9em;vertical-align:-0.1em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg> puis cochez la case.</p>';return}const ul=document.createElement('ul');actions.forEach(a=>{const li=document.createElement('li');li.className='action-key-entry';li.innerHTML=`<strong>${a.pillarName} > ${a.subPillarName}</strong><span style="font-size:0.8em;color:var(--secondary-text-color);margin-left:5px;">(${a.date})</span><div class="action-key-note">${a.note}</div>`;ul.appendChild(li)});actionKeysContent.appendChild(ul)}

        // --- Import / Export / Reset ---
        function copyDataForAIGoals() { if(!pillars?.length){showNotification("Aucune donn√©e.");return}let subPillarsBelowGoal=[];pillars.forEach(p=>{p.subPillars?.forEach(sp=>{const s=sp.score??NaN,g=sp.goal??NaN;if(!isNaN(s)&&!isNaN(g)&&s<g)subPillarsBelowGoal.push({pillarId:p.id,subPillarId:sp.id,pillarName:p.name||'?',subPillarName:sp.name||'?',score:s,goal:g,note:sp.note||''})})});if(subPillarsBelowGoal.length===0){showNotification("Objectifs atteints !");return}const dataForPrompt=subPillarsBelowGoal;const formatInstruction=`\n\n--- FORMAT R√âPONSE JSON ATTENDU ---\nIMPORTANT: R√©pondez EXCLUSIVEMENT en JSON valide (tableau d'objets).\nChaque objet doit avoir EXACTEMENT les cl√©s:\n- "pillarId": (String) ID du pilier fourni.\n- "subPillarId": (String) ID du sous-pilier fourni.\n- "aiGoals": (Array of Strings) Vos objectifs SMART sugg√©r√©s.\n- "aiRituals": (Array of Strings) Vos rituels/habitudes concrets sugg√©r√©s.\n\nExemple:\n\`\`\`json\n[\n  {\n    "pillarId": "id_pilier",\n    "subPillarId": "id_sous_pilier",\n    "aiGoals": ["Objectif 1..."],\n    "aiRituals": ["Rituel 1..."]\n  }\n]\n\`\`\`\nNE RETOURNEZ QUE LE JSON.`;const aiPrompt=`Bonjour! Voici les domaines o√π mon score actuel est inf√©rieur √† mon objectif. 'pillarId' et 'subPillarId' sont des identifiants uniques.\n\nDonn√©es:\n\`\`\`json\n${JSON.stringify(dataForPrompt,null,2)}\n\`\`\`\n\nPour CHACUN de ces sous-piliers, merci de:\n1. D√©finir 1-3 objectifs SMART.\n2. Sugg√©rer 2-4 rituels/habitudes concrets.\n\n${formatInstruction}`;try{navigator.clipboard.writeText(aiPrompt).then(()=>{showNotification("Donn√©es & prompt copi√©s! Collez dans IA puis importez r√©ponse JSON.",6000)}).catch(err=>{console.error("Erreur copie:",err);showNotification("Erreur copie.",4000)})}catch(err){console.error("Erreur copie:",err);showNotification("Erreur copie.",4000)}}
        		
		// MODIFIED: Importer suggestions IA ET les sauvegarder directement
		function importAIGeneratedData() {
			const jsonString = aiImportTextarea.value.trim();
			if (!jsonString) { showNotification("Collez le JSON.", 3000); return; }

			try {
				const importedSuggestionsRaw = JSON.parse(jsonString);
				if (!Array.isArray(importedSuggestionsRaw)) throw new Error("JSON n'est pas un tableau.");

				let updatedCount = 0;
				let invalidCount = 0;
				// Stocker les IDs des sous-piliers mis √† jour pour la revue
				const updatedSubPillarIds = [];

				importedSuggestionsRaw.forEach(item => {
					if (item && typeof item.pillarId === 'string' && typeof item.subPillarId === 'string') {
						const subPillar = findSubPillar(item.pillarId, item.subPillarId);
						if (subPillar) {
							// Sauvegarde les suggestions brutes DANS le mod√®le de donn√©es
							subPillar.aiGoals = Array.isArray(item.aiGoals) ? item.aiGoals.filter(g => typeof g === 'string') : [];
							subPillar.aiRituals = Array.isArray(item.aiRituals) ? item.aiRituals.filter(r => typeof r === 'string') : [];
							updatedCount++;
							// Ajouter l'identifiant unique pour le retrouver lors de la revue
							updatedSubPillarIds.push({ pillarId: item.pillarId, subPillarId: item.subPillarId });
						} else {
							console.warn(`Sous-pilier non trouv√© pour import IA: PillarID=${item.pillarId}, SubPillarID=${item.subPillarId}`);
							// Pas d'incr√©mentation de invalidCount ici, juste non trouv√©
						}
					} else {
						console.warn("Format JSON import√© invalide ou IDs manquants ignor√©:", item);
						invalidCount++;
					}
				});

				aiImportTextarea.value = ''; // Vider le textarea

				if (updatedCount > 0) {
					saveData(); // <-- Sauvegarder les donn√©es AVEC les suggestions brutes
					closeModal('aiImportPopup');
					// Passer les IDs mis √† jour √† la fonction de revue
					renderReviewSuggestionsModal(updatedSubPillarIds);
					showNotification(`${updatedCount} sous-pilier(s) ont re√ßu de nouvelles suggestions IA. Pr√™t pour revue. ${invalidCount > 0 ? invalidCount + ' format(s) invalide(s).' : ''}`);
				} else {
					showNotification(`Aucune suggestion valide trouv√©e ou applicable dans le JSON fourni. ${invalidCount > 0 ? invalidCount + ' format(s) invalide(s).' : ''}`, 5000);
				}

			} catch (error) { console.error("Erreur import IA:", error); showNotification(`Erreur d'import: ${error.message}.`, 6000); }
		}
				
		 // MODIFIED: Lire depuis `pillars` bas√© sur les IDs fournis
 // MODIFIED: Lire depuis `pillars` bas√© sur les IDs fournis
		 function renderReviewSuggestionsModal(subPillarIdsToReview) {
			 reviewSuggestionsContent.innerHTML = ''; // Clear
			 if (!subPillarIdsToReview || subPillarIdsToReview.length === 0) {
				 reviewSuggestionsContent.innerHTML = '<p>Aucune nouvelle suggestion √† reviewer (ou erreur lors de l\'import).</p>';
				 openModal('reviewSuggestionsPopup');
				 return;
			 }

			 let html = '';
			 let hasContentToShow = false;

			 subPillarIdsToReview.forEach(ids => {
				 const subPillar = findSubPillar(ids.pillarId, ids.subPillarId);
				 if (!subPillar) {
					  console.warn(`SubPillar ${ids.subPillarId} non trouv√© pour la revue.`);
					  return; // Skip si le sous-pilier n'existe plus
				  }

				 // V√©rifier si ce sous-pilier a effectivement des suggestions brutes
				 const goalsToShow = subPillar.aiGoals || [];
				 const ritualsToShow = subPillar.aiRituals || [];

				 if (goalsToShow.length > 0 || ritualsToShow.length > 0) {
					 hasContentToShow = true;
					 const pillar = pillars.find(p => p.id === ids.pillarId);
					 html += `<div class="suggestion-group" data-pillar-id="${ids.pillarId}" data-subpillar-id="${ids.subPillarId}">`; // Ajout data-attributes pour saveSelectedSuggestions
					 html += `<h5>${subPillar.name} (Pilier: ${pillar ? pillar.name : '?'})</h5>`;

					 if (goalsToShow.length > 0) {
						 html += `<h6>Objectifs Sugg√©r√©s :</h6><ul>`;
						 goalsToShow.forEach((goal, goalIndex) => {
							 const inputId = `review-goal-${subPillar.id}-${goalIndex}`;
							 // V√©rifier si ce but est d√©j√† actif pour le pr√©-cocher
							 const isChecked = subPillar.activeGoals?.includes(goal);
							 html += `<li>
								 <input type="checkbox" id="${inputId}" data-type="goal" data-text="${encodeURIComponent(goal)}" ${isChecked ? 'checked' : ''}>
								 <label for="${inputId}">${goal}</label>
							 </li>`;
						 });
						 html += `</ul>`;
					 }

					 if (ritualsToShow.length > 0) {
						 html += `<h6>Rituels Sugg√©r√©s :</h6><ul>`;
						 ritualsToShow.forEach((ritual, ritualIndex) => {
							 const inputId = `review-ritual-${subPillar.id}-${ritualIndex}`;
							 // V√©rifier si ce rituel (bas√© sur le texte) est d√©j√† actif
							 const isChecked = subPillar.activeRituals?.some(r => r.text === ritual);
							 html += `<li>
								 <input type="checkbox" id="${inputId}" data-type="ritual" data-text="${encodeURIComponent(ritual)}" ${isChecked ? 'checked' : ''}>
								 <label for="${inputId}">${ritual}</label>
							 </li>`;
						 });
						 html += `</ul>`;
					 }
					 html += `</div>`;
				 }
			 });

			 if (!hasContentToShow) {
				  html = '<p>Aucune nouvelle suggestion √† reviewer pour les √©l√©ments import√©s.</p>';
			  }

			 reviewSuggestionsContent.innerHTML = html;
			 openModal('reviewSuggestionsPopup');
		 }

		// MODIFIED: Lire depuis le DOM du modal et mettre √† jour `pillars`
		function saveSelectedSuggestions() {
			const suggestionGroups = reviewSuggestionsContent.querySelectorAll('.suggestion-group');
			let updatedCount = 0;

			suggestionGroups.forEach(group => {
				const pillarId = group.dataset.pillarId;
				const subPillarId = group.dataset.subpillarId;
				const subPillar = findSubPillar(pillarId, subPillarId);

				if (subPillar) {
					let newActiveGoals = [];
					let newActiveRituals = [];
					let changed = false;

					// R√©cup√©rer les objectifs coch√©s pour ce groupe
					group.querySelectorAll('input[data-type="goal"]:checked').forEach(cb => {
						newActiveGoals.push(decodeURIComponent(cb.dataset.text));
					});

					// R√©cup√©rer les rituels coch√©s pour ce groupe
					group.querySelectorAll('input[data-type="ritual"]:checked').forEach(cb => {
						// Retrouver l'√©tat 'completed' pr√©c√©dent si le rituel existait d√©j√†
						const existingRitual = subPillar.activeRituals?.find(r => r.text === decodeURIComponent(cb.dataset.text));
						newActiveRituals.push({
							 text: decodeURIComponent(cb.dataset.text),
							 completed: existingRitual ? existingRitual.completed : false // Conserve l'√©tat si possible
						});
					});

					// Comparer avec les anciens pour voir s'il y a eu un changement
					 if (JSON.stringify(subPillar.activeGoals) !== JSON.stringify(newActiveGoals) ||
						 JSON.stringify(subPillar.activeRituals.map(r => r.text)) !== JSON.stringify(newActiveRituals.map(r => r.text))) { // Compare juste les textes des rituels pour d√©tecter changement structurel
						 changed = true;
					 }


					if(changed) {
						subPillar.activeGoals = newActiveGoals;
						subPillar.activeRituals = newActiveRituals;
						updatedCount++;
					}
				}
			});

			if (updatedCount > 0) {
				saveData(); // Sauvegarde imm√©diate apr√®s toutes les mises √† jour
				showNotification(`${updatedCount} sous-pilier(s) mis √† jour avec les objectifs/rituels activ√©s.`);
				closeModal('reviewSuggestionsPopup');
				showDashboardView(); // Afficher le tableau de bord mis √† jour
			} else {
				showNotification("Aucune modification apport√©e √† la s√©lection active.");
				closeModal('reviewSuggestionsPopup');
			}
		}


        function copyHistory() { if(history.length===0){showNotification("Historique vide.");return}try{const historyForAI=history.map(e=>({...e,scores:e.scores.map(s=>({...s,subPillars:s.subPillars.map(sp=>({id:sp.id,name:sp.name,score:sp.score,goal:sp.goal,isAction:sp.isAction,note:sp.note}))}))}));const json=JSON.stringify(historyForAI,null,2);const prompt=`Bonjour! Voici mon historique Roue de la Vie (JSON).\nPeux-tu analyser :\n1. Tendances ?\n2. Points forts/faibles r√©currents ?\n3. Pistes d'action bas√©es sur l'historique ?\n\nDonn√©es:\n\`\`\`json\n${json}\n\`\`\`\n\nMerci !`;navigator.clipboard.writeText(prompt).then(()=>showNotification("Historique & prompt copi√©s!",5000)).catch(err=>{console.error("Erreur copie:",err);showNotification("Erreur copie.",4000)})}catch(error){console.error("Erreur pr√©pa copie:",error);showNotification("Erreur pr√©pa copie.",4000)}}
        function exportData() { if(!isPremium){showNotification("Premium requis.");return}try{const data={pillars:pillars,history:history,premiumStatus:isPremium,exportTimestamp:new Date().toISOString()},json=JSON.stringify(data,null,2),blob=new Blob([json],{type:'application/json;charset=utf-8'}),url=URL.createObjectURL(blob),a=document.createElement('a'),dateStr=new Date().toISOString().slice(0,10);a.href=url;a.download=`roue_de_la_vie_export_${dateStr}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showNotification("Donn√©es export√©es.")}catch(error){console.error("Erreur export:",error);showNotification("Erreur export.",4000)}}
        function importData(event) { if(!isPremium){showNotification("Premium requis.");event.target.value='';return}const file=event.target.files[0];if(!file){showNotification("Aucun fichier.");return}if(!file.type.match('application/json')){showNotification("Fichier JSON requis.",4000);event.target.value='';return}const reader=new FileReader();reader.onload=function(e){try{const importedData=JSON.parse(e.target.result);if(!importedData||typeof importedData!=='object')throw new Error("Contenu invalide.");if(!confirm("Importer remplacera TOUT. Continuer?")){event.target.value='';return}if(importedData.pillars&&Array.isArray(importedData.pillars)){pillars=migrateDataStructure(importedData.pillars)}else{pillars=JSON.parse(JSON.stringify(defaultPillarsData));showNotification("Piliers non trouv√©s, r√©initialis√©s.")}if(importedData.history&&Array.isArray(importedData.history)){history=importedData.history.filter(entry=>entry&&entry.date&&entry.timestamp&&Array.isArray(entry.scores));history.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0))}else{history=[]}if(typeof importedData.premiumStatus==='boolean'){isPremium=importedData.premiumStatus;savePremiumStatus();updatePremiumUI()}saveData();currentPillarIndex=0;showDashboardView();showNotification("Donn√©es import√©es.")}catch(err){console.error("Erreur import:",err);showNotification(`Erreur import: ${err.message}.`,5000)}finally{event.target.value=''}};reader.onerror=function(){showNotification("Erreur lecture fichier.",4000);event.target.value=''};reader.readAsText(file)}
        function resetApp() { if(!confirm("ATTENTION: R√©initialiser TOUTES les donn√©es (config, historique, notes, rituels, premium)? IRR√âVERSIBLE."))return;localStorage.removeItem('wheelOfLife_pillars');localStorage.removeItem('wheelOfLife_history');localStorage.removeItem('wheelOfLife_premiumStatus');localStorage.removeItem('wheelOfLife_welcomeDismissed');window.location.reload()}

        // --- Modal Management ---
        function openModal(modalId) { closeAllModals();const modal=document.getElementById(modalId);if(!modal)return;if(modalId==='historyPopup')showHistory();else if(modalId==='customizationPopup'){if(!isPremium){showNotification("Premium requis.");return}renderCustomizationForm()}else if(modalId==='actionKeysPopup')renderActionKeys();else if(modalId==='aiImportPopup')aiImportTextarea.value='';overlay.style.display='flex';modal.style.display='block';modal.setAttribute('aria-hidden','false');const focusable=modal.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')[0];if(focusable)setTimeout(()=>focusable.focus(),50)}
        function closeModal(modalId) { const modal=document.getElementById(modalId);if(!modal||modal.style.display==='none')return;modal.style.display='none';modal.setAttribute('aria-hidden','true');const anyOpen=Array.from(document.querySelectorAll('.popup')).some(m=>m.style.display==='block');if(!anyOpen)overlay.style.display='none';/* Basic focus return? */}
        function closeAllModals() { document.querySelectorAll('.popup').forEach(m=>{if(m.style.display!=='none'){m.style.display='none';m.setAttribute('aria-hidden','true')}});if(overlay.style.display!=='none')overlay.style.display='none'}

        // --- Note Popup Logic ---
        function openNotePopup(pillarId, subPillarId) { const sp=findSubPillar(pillarId,subPillarId);if(!sp)return;notePopupSubPillarName.textContent=sp.name;notePopupTextarea.value=sp.note||'';notePopupActionKeyCheckbox.checked=sp.isAction||!1;const goalsUl=aiGoalsListContainer.querySelector('ul'),ritualsUl=aiRitualsListContainer.querySelector('ul');goalsUl.innerHTML='';ritualsUl.innerHTML='';let hasSuggestions=!1;if(sp.aiGoals?.length>0){sp.aiGoals.forEach(g=>{const li=document.createElement('li');li.textContent=g;goalsUl.appendChild(li)});aiGoalsListContainer.style.display='block';hasSuggestions=!0}else{aiGoalsListContainer.style.display='none'}if(sp.aiRituals?.length>0){sp.aiRituals.forEach(r=>{const li=document.createElement('li');li.textContent=r;ritualsUl.appendChild(li)});aiRitualsListContainer.style.display='block';hasSuggestions=!0}else{aiRitualsListContainer.style.display='none'}aiSuggestionsDisplay.style.display=hasSuggestions?'block':'none';saveNoteBtn.dataset.pillarId=pillarId;saveNoteBtn.dataset.subPillarId=subPillarId;openModal('notePopup');setTimeout(()=>notePopupTextarea.focus(),50)}
        function saveNoteFromPopup() { const pId=saveNoteBtn.dataset.pillarId,spId=saveNoteBtn.dataset.subPillarId;if(!pId||!spId){showNotification("Erreur sauvegarde.",4000);return}updateNote(pId,spId,notePopupTextarea.value,notePopupActionKeyCheckbox.checked);closeModal('notePopup');showNotification("Note sauvegard√©e.")}

        // --- Customization Logic (Premium) ---
        function renderCustomizationForm() { customizationContent.innerHTML='';if(!pillars?.length){customizationContent.innerHTML="<p>Aucun pilier.</p>";return}pillars.forEach((p,pIdx)=>{const section=document.createElement('div');section.className='customization-section';section.innerHTML=`<h4>Pilier: ${p.name}</h4><div class="customization-item"><input type="text" value="${p.name}" data-pillar-index="${pIdx}" class="custom-pillar-name" aria-label="Nom pilier ${p.name}"><!---- Supprim√© pour simplicit√© ----></div><h5>Sous-Piliers:</h5>`;if(p.subPillars?.length>0){p.subPillars.forEach((sp,spIdx)=>{const subItem=document.createElement('div');subItem.className='customization-item';subItem.innerHTML=`<input type="text" value="${sp.name}" data-pillar-index="${pIdx}" data-sub-index="${spIdx}" class="custom-subpillar-name" aria-label="Nom sous-pilier ${sp.name}"><!---- Supprim√© pour simplicit√© ---->`;section.appendChild(subItem)})}else{section.innerHTML+='<p style="font-size:0.9em;color:var(--secondary-text-color);">Aucun.</p>'}customizationContent.appendChild(section)})}
        function saveCustomization() { if(!isPremium)return;const pInputs=document.querySelectorAll('.custom-pillar-name'),spInputs=document.querySelectorAll('.custom-subpillar-name');let changed=!1;pInputs.forEach(i=>{const idx=parseInt(i.dataset.pillarIndex),newName=i.value.trim();if(newName&&idx>=0&&idx<pillars.length&&pillars[idx].name!==newName){pillars[idx].name=newName;changed=!0}else if(!newName){showNotification(`Nom pilier ${idx+1} vide.`);i.value=pillars[idx].name}});spInputs.forEach(i=>{const pIdx=parseInt(i.dataset.pillarIndex),sIdx=parseInt(i.dataset.subIndex),newName=i.value.trim();if(newName&&pIdx>=0&&pIdx<pillars.length&&sIdx>=0&&sIdx<pillars[pIdx].subPillars.length&&pillars[pIdx].subPillars[sIdx].name!==newName){pillars[pIdx].subPillars[sIdx].name=newName;changed=!0}else if(!newName){showNotification(`Nom sous-pilier "${pillars[pIdx].subPillars[sIdx].name}" vide.`);i.value=pillars[pIdx].subPillars[sIdx].name}});if(changed){saveData();renderPillar();if(dashboardView.style.display==='block')renderDashboard();if(chartInstance)renderChart();showNotification("Noms sauvegard√©s.")}else{showNotification("Aucun changement.")}closeModal('customizationPopup')}
        // Suppression via Customization retir√©e pour simplifier, garder seulement renommage.

        // --- Theme Management ---
        function setupTheme() { const saved=localStorage.getItem('wheelOfLife_theme'),prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;if(saved==='dark'||(!saved&&prefersDark)){document.body.classList.add('dark-theme');themeCheckbox.checked=!0}else{document.body.classList.remove('dark-theme');document.body.classList.add('light-theme');themeCheckbox.checked=!1}themeCheckbox.addEventListener('change',toggleTheme);window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{const currentSaved=localStorage.getItem('wheelOfLife_theme');if(!currentSaved){if(e.matches){document.body.classList.add('dark-theme');document.body.classList.remove('light-theme');themeCheckbox.checked=!0}else{document.body.classList.remove('dark-theme');document.body.classList.add('light-theme');themeCheckbox.checked=!1}if(chartInstance)renderChart()}})}
        function toggleTheme() { if(themeCheckbox.checked){document.body.classList.remove('light-theme');document.body.classList.add('dark-theme');localStorage.setItem('wheelOfLife_theme','dark')}else{document.body.classList.remove('dark-theme');document.body.classList.add('light-theme');localStorage.setItem('wheelOfLife_theme','light')}if(chartInstance)renderChart();else if(chartView.style.display==='block')renderChart()}

        // --- Event Listeners ---
               
        function addEventListeners() {
            document.addEventListener('keydown', e => { /* ... gestion escape / fl√®ches ... */ });
            if (appLogo) { /* ... gestion logo premium ... */ }
            const pillarNav = document.getElementById('pillarNavigation');
            if (pillarNav) { /* ... gestion nav clavier ... */ }

            // --- NOUVEAU : Sauvegarde avant de quitter ---
            window.addEventListener('beforeunload', (event) => {
                // Appelle directement saveData (sans debounce) pour forcer l'√©criture
                // des derni√®res modifications potentielles non encore sauvegard√©es par le debounce.
                console.log("beforeunload: Forcing final save...");
                saveData();

                // La ligne ci-dessous est souvent utilis√©e pour afficher une confirmation
                // mais elle n'est plus garantie de fonctionner dans tous les navigateurs modernes
                // et n'est pas n√©cessaire si on veut juste sauvegarder silencieusement.
                // event.preventDefault();
                // event.returnValue = ''; // Standard pour afficher confirmation
            });
            // --- FIN NOUVEAU ---
        }

        // --- Start the Application ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
