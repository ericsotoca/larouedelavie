<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Roue de la Vie Interactive</title>
    <header>
        <img src="logo.png" alt="La Roue de la Vie Interactive" class="logo">
    </header>
    <style>
        /* --- Base & Variables --- */
        :root {
            --bg-color: #f4f4f4; --container-bg: white; --text-color: #2c3e50; --secondary-text-color: #34495e; --primary-color: #3498db; --primary-hover-color: #2980b9; --disabled-color: #bdc3c7; --slider-track-color: #dfe6e9; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.2); --chart-border-color: #3498db; --goal-bg-color: rgba(231, 76, 60, 0.1); --goal-border-color: #e74c3c; --danger-color: #e74c3c; --danger-hover-color: #c0392b; --shadow-color: rgba(0, 0, 0, 0.1); --focus-ring-color: #74b9ff; --grid-color: #dbe4e9; --tooltip-bg: rgba(52, 73, 94, 0.95); --tooltip-text-color: white; --pillar-border-color: transparent; --pillar-border-width: 10px; --help-icon-color: #7f8c8d; --help-icon-hover-color: var(--primary-color); --action-key-color: #f39c12;

            --pillar-color-0: #e74c3c; --pillar-color-1: #e67e22; --pillar-color-2: #f1c40f; --pillar-color-3: #2ecc71; --pillar-color-4: #3498db; --pillar-color-5: #1abc9c; --pillar-color-6: #9b59b6; --pillar-color-7: #34495e;
        }
        body.dark-theme {
            --bg-color: #2c3e50; --container-bg: #34495e; --text-color: #ecf0f1; --secondary-text-color: #bdc3c7; --primary-color: #3498db; --primary-hover-color: #5dade2; --disabled-color: #7f8c8d; --slider-track-color: #7f8c8d; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.3); --chart-border-color: #5dade2; --goal-bg-color: rgba(241, 150, 138, 0.2); --goal-border-color: #f1948a; --danger-color: #e74c3c; --danger-hover-color: #f1948a; --shadow-color: rgba(0, 0, 0, 0.3); --focus-ring-color: #a9cce3; --grid-color: #566573; --tooltip-bg: rgba(236, 240, 241, 0.95); --tooltip-text-color: #2c3e50; --help-icon-color: #95a5a6; --help-icon-hover-color: var(--primary-color); --action-key-color: #f1c40f;

            --pillar-color-0: #c0392b; --pillar-color-1: #d35400; --pillar-color-2: #f39c12; --pillar-color-3: #27ae60; --pillar-color-4: #2980b9; --pillar-color-5: #16a085; --pillar-color-6: #8e44ad; --pillar-color-7: #7f8c8d;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; touch-action: manipulation; }

        /* --- Layout & Containers --- */
        .main-view { max-width: 700px; margin: 20px auto; background: var(--container-bg); color: var(--text-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s, color 0.3s, border-left-color 0.3s; }
        #inputView { border-left: var(--pillar-border-width) solid var(--pillar-border-color); padding-left: calc(30px - var(--pillar-border-width)); }
        #chartView { display: none; text-align: center; }

        /* --- Typography & Headings --- */
        h1, h2, h3 { text-align: center; color: var(--text-color); }
        h1 { font-size: 2.2rem; font-weight: 700; margin: 20px 0; }
        h2 { font-size: 1.8rem; margin-bottom: 20px;}
        h3 { font-size: 1.5rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h4 { margin-top: 15px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1.1rem;}
        h5 { margin-top: 10px; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 1rem;}

        /* --- Logo & Scores --- */
        .logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; cursor: pointer; }
        #globalScore { font-size: 1.6rem; font-weight: 600; margin-bottom: 10px; text-align: center; }
        #pillarAverageScore { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--secondary-text-color); }

        /* --- Pillar & Sub-Pillar Structure --- */
        .pillar-actions { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px; flex-wrap: wrap; }
        .pillar-actions button { padding: 6px 12px; font-size: 0.9rem; background-color: var(--slider-track-color); color: var(--text-color); }
        .pillar-actions button:hover:not(:disabled) { background-color: var(--primary-hover-color); color: white; }
        .pillar { margin-bottom: 25px; }
        .sub-pillar { margin: 20px 0; padding: 15px; border: 1px solid var(--slider-track-color); border-radius: 8px; background-color: var(--bg-color); transition: background-color 0.3s; }
        .sub-pillar-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .sub-pillar label { flex-grow: 1; font-size: 1.1rem; color: var(--secondary-text-color); display: flex; align-items: center; gap: 8px; min-width: 150px; }
        .sub-pillar-controls { display: flex; align-items: center; gap: 10px; width: 60%; flex-grow: 1; min-width: 250px;}

        /* --- Sliders & Inputs --- */
        input[type="range"] { flex-grow: 1; margin-left: 10px; -webkit-appearance: none; appearance: none; height: 10px; background: var(--slider-track-color); border-radius: 5px; outline: none; transition: background 0.3s; cursor: pointer; box-shadow: inset 0 1px 3px var(--shadow-color); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--slider-thumb-color); border-radius: 50%; cursor: pointer; border: none; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--shadow-color); }
        input[type="range"]::-webkit-slider-thumb:hover, input[type="range"]::-moz-range-thumb:hover { transform: scale(1.1); }
        input[type="range"]:focus { outline: 2px solid var(--focus-ring-color); outline-offset: 4px; } /* More visible focus */
        .slider-value { font-size: 1.1rem; font-weight: bold; min-width: 25px; text-align: right; }
        .sub-pillar-details { margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .detail-group { display: flex; align-items: center; gap: 5px; }
        .detail-group label { font-size: 0.9rem; color: var(--secondary-text-color); flex-grow: 0; }
        .detail-group input[type="number"] { padding: 5px 8px; border-radius: 4px; border: 1px solid var(--slider-track-color); background-color: var(--container-bg); color: var(--text-color); font-size: 0.9rem; width: 50px; text-align: center; }
        .note-button { background: none; border: none; padding: 3px; margin-left: 5px; cursor: pointer; color: var(--secondary-text-color); line-height: 0; }
        .note-button:hover { color: var(--primary-color); }
        .note-button svg { width: 18px; height: 18px; vertical-align: middle; }

        /* --- Buttons --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        button, .button-like { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-align: center; transition: background-color 0.3s, transform 0.1s; text-decoration: none; display: inline-block; }
        button:disabled { background-color: var(--disabled-color); cursor: not-allowed; transform: none; }
        button:hover:not(:disabled), .button-like:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); }
        button:active:not(:disabled), .button-like:active { transform: translateY(0); }
        button:focus-visible, .button-like:focus-visible { outline: 3px solid var(--focus-ring-color); outline-offset: 2px; }
        .danger-button { background-color: var(--danger-color); }
        .danger-button:hover:not(:disabled) { background-color: var(--danger-hover-color); }
        .icon-button { background: none; border: none; padding: 2px; cursor: pointer; color: var(--secondary-text-color); }
        .icon-button:hover { color: var(--primary-color); }
        .icon-button svg { width: 16px; height: 16px; vertical-align: middle; }
        .danger-button.icon-button:hover { color: var(--danger-color); }

        /* --- Chart --- */
        #radarChart { max-width: 100%; margin-top: 10px; background-color: var(--container-bg); border-radius: 8px; display: block; }

        /* --- Modals (Popups) --- */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #overlay:not([style*="display: flex"]) { display: none; }
        .popup { position: relative; background: var(--container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); max-width: 90%; max-height: 85vh; overflow-y: auto; width: 600px; z-index: 1000; flex-shrink: 0; display: none; }
        .popup h3, .popup h4 { margin-top: 0; text-align: center; padding-right: 35px; min-height: 1.5em; margin-right: 5px; }
        .popup-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .popup-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; line-height: 1; padding: 0 5px; color: var(--secondary-text-color); cursor: pointer; transition: color 0.2s; z-index: 1001; }
        .popup-close-btn:hover { color: var(--danger-color); }

        /* --- Note Popup Specific --- */
        #notePopup textarea { width: 100%; min-height: 150px; margin-top: 15px; padding: 10px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; resize: vertical; box-sizing: border-box; }
        #notePopup #notePopupSubPillarName { font-weight: bold; color: var(--primary-color); }
        .action-key-checkbox { margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        .action-key-checkbox label { font-size: 0.9rem; color: var(--secondary-text-color); }
        .action-key-checkbox input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--action-key-color); }

        /* --- History & Action Key Popups --- */
        #historyContent, #actionKeysContent { margin-top: 15px; }
        #historyContent ul, #actionKeysContent ul { list-style: none; padding: 0; }
        #historyContent li, #actionKeysContent li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--slider-track-color); }
        #historyContent li:last-child, #actionKeysContent li:last-child { border-bottom: none; }
        .history-entry strong, .action-key-entry strong { font-size: 1.1em; }
        .history-scores, .action-key-note { margin-top: 5px; font-size: 0.9em; color: var(--secondary-text-color); }
        .action-key-note { white-space: pre-wrap; } /* Preserve line breaks in notes */
        .action-key-link { font-size: 0.8em; color: var(--primary-color); text-decoration: none; }
        .action-key-link:hover { text-decoration: underline; }
        .score-diff { margin-left: 5px; font-size: 0.8em; }
        .score-diff.positive { color: #2ecc71; font-weight: bold;}
        .score-diff.negative { color: var(--danger-color); font-weight: bold; }
        .history-scroll-container { margin-bottom: 10px; }
        #historyScrollToBottomBtn svg { width: 24px; height: 24px; vertical-align: middle; }
        #historyScrollToBottomBtn:hover { color: var(--primary-hover-color); background-color: var(--slider-track-color); border-radius: 50%; padding: 4px; }
        #historyPopup .popup-buttons { flex-wrap: wrap; overflow-x: auto; padding-bottom: 10px; justify-content: center; /* Avoid scrollbar overlap */}
        #compareControls { margin-top: 15px; }
        /* Mini Trend Graph */
        .mini-trend-graph { margin-bottom: 20px; padding: 15px; border: 1px solid var(--slider-track-color); border-radius: 8px; background-color: var(--bg-color); }
        .mini-trend-graph h5 { margin-top: 0; text-align: center; color: var(--secondary-text-color);}
        .trend-bars { display: flex; justify-content: space-around; align-items: flex-end; height: 60px; padding: 0 10px; }
        .trend-bar-item { display: flex; flex-direction: column; align-items: center; flex-basis: 0; flex-grow: 1; max-width: 50px; }
        .trend-bar { width: 70%; background-color: var(--primary-color); border-radius: 3px 3px 0 0; transition: height 0.3s ease-out; position: relative; }
        .trend-bar span { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--secondary-text-color); white-space: nowrap; }
        .trend-bar-item .bar-value { font-size: 0.8rem; margin-top: 3px; font-weight: bold; }

        /* --- Customization Popup --- */
        .customization-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--slider-track-color); }
        .customization-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .customization-item input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid var(--slider-track-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); min-width: 150px; }

        /* --- Pillar Navigation --- */
        .pillar-nav { display: flex; justify-content: center; gap: 5px; /* Reduced gap */ flex-wrap: wrap; margin: 15px 0; }
        .pillar-nav-button { background-color: var(--slider-track-color); color: var(--text-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem; /* Slightly smaller */ border: none; }
        .pillar-nav-button.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        .pillar-nav-button:hover:not(.active) { background-color: var(--primary-hover-color); color: white; }

        /* --- Theme Switch --- */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; position: absolute; top: 15px; right: 15px; z-index: 5; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- Help Popup --- */
        #helpPopup ul { margin-top: 15px; padding-left: 20px; }
        #helpPopup li { margin-bottom: 8px; }

        /* --- Tooltips & Help Icons --- */
        .help-icon { display: inline-block; margin-left: 5px; color: var(--help-icon-color); cursor: help; position: relative; font-weight: bold; font-size: 0.9em; border: 1px solid var(--help-icon-color); border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; transition: color 0.2s, border-color 0.2s; }
        .help-icon:hover, .help-icon:focus { color: var(--help-icon-hover-color); border-color: var(--help-icon-hover-color); outline: none; }
        .tooltiptext { visibility: hidden; width: 220px; background-color: var(--tooltip-bg); color: var(--tooltip-text-color); text-align: left; font-size: 0.85rem; font-weight: normal; border-radius: 6px; padding: 8px 10px; position: absolute; z-index: 10; bottom: 135%; /* Position above the icon */ left: 50%; margin-left: -110px; /* Center the tooltip */ opacity: 0; transition: opacity 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--tooltip-bg) transparent transparent transparent; }
        .help-icon:hover .tooltiptext, .help-icon:focus .tooltiptext { visibility: visible; opacity: 1; }
        /* Ensure help icon is clickable */
        h3 .help-icon { line-height: 16px; }
        label .help-icon { line-height: 16px; vertical-align: middle; }


        /* --- Utility Classes --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-2 { margin-bottom: 20px; }
        .w-100 { width: 100%; }

        /* --- Loading & Notifications --- */
        .loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); z-index: 1000; }
        .notification { position: fixed; bottom: 20px; /* Changed to bottom */ left: 50%; transform: translateX(-50%); background: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; box-shadow: 0 2px 8px var(--shadow-color); }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
             body { padding: 10px; }
            .main-view { padding: 15px; }
            #inputView { padding-left: calc(15px - var(--pillar-border-width)); }
            h1 { font-size: 1.8rem; }
            .sub-pillar-header { flex-direction: column; align-items: stretch; gap: 8px; }
            .sub-pillar-controls { width: 100%; margin-top: 5px;}
            input[type="range"] { margin-left: 0; width: 100%; }
            .sub-pillar label { font-size: 1rem; }
            .popup-buttons { flex-direction: column; gap: 10px; }
            button, .button-like { width: 100%; }
            #historyPopup .popup-buttons { flex-direction: row; justify-content: center; flex-wrap: wrap; }
            #historyPopup .popup-buttons button, #historyPopup .popup-buttons .button-like { width: auto; flex-grow: 0; flex-shrink: 0; margin-bottom: 5px; }
            .popup { width: 95%; padding: 20px; max-height: 90vh; } /* Slightly wider popup on mobile */
            .theme-switch-wrapper { position: static; justify-content: center; margin: 15px 0 5px; order: -1; }
            .detail-group { flex-basis: calc(50% - 8px); }
            .detail-group:has(.note-button) { flex-basis: auto; }
            h3 { font-size: 1.3rem; }
            #notePopup textarea { min-height: 100px; }
            .popup-close-btn { font-size: 1.6rem; top: 8px; right: 10px; }
            .popup h3, .popup h4 { padding-right: 30px; }
            .pillar-nav { gap: 5px; }
            .pillar-nav-button { padding: 4px 8px; font-size: 0.8rem; }
            .pillar-actions { margin-bottom: 15px; }
            .tooltiptext { width: 180px; margin-left: -90px; bottom: 140%; } /* Adjust tooltip on smaller screens */
        }
        @media (max-width: 480px) {
            .detail-group { flex-basis: 100%; }
            h1 { font-size: 1.6rem; }
            h3 { flex-direction: column; gap: 5px; }
             .pillar-nav-button { flex-basis: calc(33% - 4px); text-align: center; } /* Stack nav buttons better */
             .pillar-actions button { font-size: 0.85rem; padding: 5px 10px; }
             .trend-bar span { font-size: 0.7rem; }
        }
        /* Dark theme preference */
        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) {
                --bg-color: #2c3e50; --container-bg: #34495e; --text-color: #ecf0f1; --secondary-text-color: #bdc3c7; --primary-color: #3498db; --primary-hover-color: #5dade2; --disabled-color: #7f8c8d; --slider-track-color: #7f8c8d; --slider-thumb-color: #3498db; --chart-bg-color: rgba(52, 152, 219, 0.3); --chart-border-color: #5dade2; --goal-bg-color: rgba(241, 150, 138, 0.2); --goal-border-color: #f1948a; --danger-color: #e74c3c; --danger-hover-color: #f1948a; --shadow-color: rgba(0, 0, 0, 0.3); --focus-ring-color: #a9cce3; --grid-color: #566573; --tooltip-bg: rgba(236, 240, 241, 0.95); --tooltip-text-color: #2c3e50; --help-icon-color: #95a5a6; --help-icon-hover-color: var(--primary-color); --action-key-color: #f1c40f;

                --pillar-color-0: #c0392b; --pillar-color-1: #d35400; --pillar-color-2: #f39c12; --pillar-color-3: #27ae60; --pillar-color-4: #2980b9; --pillar-color-5: #16a085; --pillar-color-6: #8e44ad; --pillar-color-7: #7f8c8d;
            }
        }
    </style>
</head>
<body>

	<!-- Welcome View -->
	<div id="welcomeView" class="main-view" style="display: none;"> <!-- Sera affiché par JS au besoin -->
		<h2>Bienvenue sur la Roue de la Vie Interactive !</h2>
		<p style="text-align: center; font-size: 1.1em; color: var(--secondary-text-color); margin-bottom: 25px;">
			Prenez de la hauteur et redécouvrez votre équilibre global.
		</p>

		<p>Vous tenez entre les mains un outil puissant d'introspection et de visualisation. Son objectif est simple mais profond : vous aider à obtenir une image claire et honnête de l'équilibre actuel entre les différents domaines essentiels de votre existence.</p>

		<h4>Le Piège de la Focalisation Excessive</h4>
		<p>Vous sentez-vous parfois submergé(e) par <em>un</em> problème spécifique ? Une difficulté au travail, une tension relationnelle, une préoccupation financière... Il est naturel de focaliser notre attention, parfois de manière excessive, sur ce qui nous semble le plus urgent ou le plus douloureux.</p>
		<p>Le risque ? Cette "vision tunnel" peut nous faire perdre de vue la situation dans son ensemble, oublier nos forces et amplifier notre sentiment de déséquilibre.</p>

		<h4>La Solution : Défocaliser avec la Roue</h4>
		<p>C'est là que la Roue de la Vie devient un allié précieux. En vous invitant à évaluer, de manière égale, <em>tous</em> les piliers importants de votre vie, cet outil vous aide à <strong>défocaliser</strong> :</p>
		<ul>
			<li>Prendre du recul et voir la "carte complète".</li>
			<li>Élargir votre perspective au-delà du problème du moment.</li>
			<li>Identifier vos forces et les domaines satisfaisants.</li>
			<li>Relativiser les difficultés dans un contexte global.</li>
		</ul>

		 <h4>Les Bienfaits</h4>
		 <p>Utiliser cet outil vous permettra de gagner en clarté, mieux cibler vos efforts, réduire le sentiment d'être submergé(e), célébrer vos réussites et agir de manière plus alignée.</p>

		<p style="margin-top: 25px; font-style: italic; color: var(--secondary-text-color);">Vos données sont confidentielles et stockées uniquement dans votre navigateur.</p>

		<div class="text-center mt-2">
			<button onclick="startEvaluation()" class="button-like" style="padding: 15px 30px; font-size: 1.1em;">Commencer mon évaluation</button>
		</div>
	</div>


    <!-- Theme Switch -->
    <div class="theme-switch-wrapper">
        <span aria-hidden="true">☀️</span>
        <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" aria-label="Changer de thème (clair/sombre)">
            <span class="slider round"></span>
        </label>
        <span aria-hidden="true">🌙</span>
    </div>

    <!-- Loading Message & Notifications -->
    <div id="loadingMessage" class="loading-message">Chargement...</div>
    <div id="notification" class="notification"></div>

    <!-- Input View -->
    <div id="inputView" class="main-view">
        <img src="logo.png" alt="Logo de La Roue de la Vie" class="logo" id="appLogo" onerror="this.style.display='none'; this.alt='Logo indisponible'" aria-describedby="logoDescription">
        <p id="logoDescription" class="hidden">Logo de l'application La Roue de la Vie, représentant un cercle avec des icônes symbolisant différents aspects de la vie.</p>
        <h1>La Roue de la Vie</h1>
        <div id="pillarNavigation" class="pillar-nav" role="navigation" aria-label="Navigation entre les piliers"></div>
        <div id="globalScore" aria-live="polite">Note globale : - / 20</div>
        <div id="pillarDisplay">
            <!-- Pillar content will be rendered here by JS -->
        </div>
        <div id="pillarAverageScore" aria-live="polite">Moyenne Pilier : - / 10</div>
        <div class="nav-buttons">
            <button id="prevBtn" onclick="changePillar(-1)" aria-label="Aller au pilier précédent (Flèche Gauche)">Précédent</button>
            <button id="nextBtn" onclick="changePillar(1)" aria-label="Aller au pilier suivant (Flèche Droite)">Suivant</button>
        </div>
        <button id="showChartBtn" onclick="showChartAndSave()" class="w-100 mt-2" aria-label="Afficher le graphique et sauvegarder l'évaluation">Afficher la Roue & Sauvegarder</button>
        <div class="mt-2 text-center" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button id="personalizeBtn" onclick="openModal('customizationPopup')" aria-label="Ouvrir les options de personnalisation" style="display: none;">Personnaliser</button>
            <button onclick="openModal('helpPopup')" aria-label="Ouvrir l'aide">Aide</button>
        </div>
    </div>

    <!-- Chart View -->
    <div id="chartView" class="main-view">
        <h2>Votre Roue de la Vie</h2>
        <canvas id="radarChart" aria-label="Graphique radar des scores de la roue de la vie"></canvas>
        <div class="mt-2 mb-2" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
             <button onclick="openModal('historyPopup')" aria-label="Ouvrir l'historique des évaluations">Historique</button>
             <button onclick="showInputView()" aria-label="Revenir à la saisie des notes">Retour au Menu</button>
        </div>
    </div>

    <!-- Overlay & Modals -->
    <div id="overlay" onclick="closeAllModals()">

        <!-- History Popup -->
        <div id="historyPopup" class="popup" role="dialog" aria-labelledby="historyTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('historyPopup')" class="popup-close-btn" aria-label="Fermer la fenêtre d'historique">×</button>
            <h3 id="historyTitle">Historique des évaluations</h3>
            <div class="history-scroll-container text-center">
                <button id="historyScrollToBottomBtn" class="icon-button" onclick="historyScrollToBottom()" aria-label="Aller aux boutons en bas" title="Aller aux boutons en bas" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11,4H13V16L18.5,10.5L19.92,11.92L12,19.84L4.08,11.92L5.5,10.5L11,16V4Z" /></svg>
                </button>
            </div>
             <div id="miniTrendGraphContainer">
                 <!-- Mini trend graph will be rendered here -->
             </div>
            <div id="historyContent"></div>
            <div id="compareControls" class="mt-1 text-center" style="display: none;">
                <button id="compareBtn" onclick="compareSelectedEntries()" disabled aria-label="Comparer les 2 évaluations sélectionnées">Comparer (2)</button>
            </div>
            <div class="popup-buttons">
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button id="importBtn" onclick="document.getElementById('importFile').click()" aria-label="Importer des données depuis un fichier JSON" style="display: none;">Importer</button>
                <button onclick="exportData()" class="button-like" style="display: none;">Exporter Tout (JSON)</button>
                <button onclick="openModal('actionKeysPopup')" aria-label="Voir les actions clés définies">Voir Actions Clés</button>
                <button onclick="copyHistory()" aria-label="Copier l'historique et prompt pour analyse IA">Copier pour IA</button>
                <button onclick="resetApp()" class="danger-button" aria-label="Réinitialiser toutes les données de l'application">Tout Réinitialiser</button>
                <button onclick="closeModal('historyPopup')" aria-label="Fermer la fenêtre d'historique">Fermer</button>
            </div>
        </div>

        <!-- Customization Popup -->
        <div id="customizationPopup" class="popup" role="dialog" aria-labelledby="customizationTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('customizationPopup')" class="popup-close-btn" aria-label="Fermer la fenêtre de personnalisation">×</button>
            <h3 id="customizationTitle">Personnaliser les Piliers</h3>
            <div id="customizationContent"></div>
            <p style="font-size: 0.9em; color: var(--secondary-text-color);">Note : L'ajout de nouveaux piliers/sous-piliers n'est pas supporté...</p>
            <div class="popup-buttons">
                <button onclick="saveCustomization()" aria-label="Sauvegarder les changements de personnalisation">Sauvegarder & Fermer</button>
                <button onclick="closeModal('customizationPopup')" aria-label="Annuler et fermer la fenêtre de personnalisation">Annuler</button>
            </div>
        </div>

        <!-- Help Popup -->
        <div id="helpPopup" class="popup" role="dialog" aria-labelledby="helpTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('helpPopup')" class="popup-close-btn" aria-label="Fermer la fenêtre d'aide">×</button>
            <h3 id="helpTitle">Aide - La Roue de la Vie</h3>
            <p>La Roue de la Vie est un outil d'auto-évaluation qui vous aide à visualiser l'équilibre dans différents domaines de votre vie.</p>
            <ul>
                <li>Naviguez entre les "Piliers" (domaines) avec "Précédent" / "Suivant", la barre de navigation rapide, ou les flèches ← → du clavier (hors champs texte).</li>
                <li>Notez chaque "Sous-Pilier" de 1 (bas) à 10 (haut) avec le curseur (ajustable aussi avec les flèches du clavier une fois sélectionné).</li>
                <li>Cliquez sur l'icône <span class="help-icon" style="cursor:default; border:none; font-size: 1em; line-height: 1em; width:auto; height:auto;">?</span> à côté des titres pour des indices sur le domaine couvert.</li>
                <li>Cliquez sur l'icône <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em; height:1em; vertical-align: -0.125em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> pour ajouter une note détaillée. Marquez une note comme "Action Clé" pour la retrouver facilement via l'historique.</li>
                <li>Définissez un objectif optionnel (1-10) pour chaque sous-pilier (défaut: 10). Utilisez les boutons "Appliquer Objectif 10 à tous" ou "Réinitialiser Notes à 5" pour gagner du temps.</li>
                <li>Cliquez sur "Afficher la Roue & Sauvegarder" pour voir le graphique et enregistrer l'évaluation (remplace l'entrée du jour si < 24h).</li>
                <li>Depuis le graphique, utilisez "Retour au Menu" ou "Historique".</li>
                <li>Dans "Historique", cochez deux entrées et cliquez sur "Comparer" pour un graphique comparatif. Voyez aussi un mini-graphique de tendance globale et accédez à vos "Actions Clés".</li>
                <li><span id="helpPersonalizeSection" style="display: none;">"Personnaliser" (premium) permet de renommer ou supprimer des piliers/sous-piliers.<br></span></li>
                <li><span id="helpImportSection" style="display: none;">"Importer" (premium, depuis l'historique) permet de charger des données JSON.<br></span></li>
                <li>L'activation du mode Premium (appui long sur le logo) sera possible prochainement sous condition.</li>
                <li>Utilisez l'interrupteur (☀️/🌙) pour changer de thème.</li>
                <li>Exportez vos données via "Copier pour IA" (prompt inclus) ou "Exporter Tout (JSON)".</li>
                <li>L'application fonctionne hors ligne grâce à la sauvegarde locale (LocalStorage).</li>
            </ul>
            <div class="popup-buttons">
                <button onclick="closeModal('helpPopup')" aria-label="Fermer la fenêtre d'aide">Fermer</button>
            </div>
        </div>

        <!-- Note Popup -->
        <div id="notePopup" class="popup" role="dialog" aria-labelledby="notePopupTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('notePopup')" class="popup-close-btn" aria-label="Fermer la fenêtre de note">×</button>
            <h4 id="notePopupTitle">Ajouter/Modifier une Note pour <span id="notePopupSubPillarName"></span></h4>
            <textarea id="notePopupTextarea" placeholder="Écrivez vos réflexions, détails, contexte, prochaines étapes ici..." aria-label="Champ pour ajouter ou modifier une note"></textarea>
            <div class="action-key-checkbox">
                 <input type="checkbox" id="notePopupActionKey" aria-label="Marquer cette note comme une action clé">
                 <label for="notePopupActionKey">Marquer comme Action Clé</label>
            </div>
            <div class="popup-buttons">
                <button id="saveNoteBtn" onclick="saveNoteFromPopup()" aria-label="Sauvegarder la note">Sauvegarder</button>
                <button onclick="closeModal('notePopup')" aria-label="Annuler et fermer la fenêtre de note">Annuler</button>
            </div>
        </div>

        <!-- Action Keys Popup -->
        <div id="actionKeysPopup" class="popup" role="dialog" aria-labelledby="actionKeysTitle" aria-modal="true" onclick="event.stopPropagation()">
            <button onclick="closeModal('actionKeysPopup')" class="popup-close-btn" aria-label="Fermer la fenêtre des actions clés">×</button>
            <h3 id="actionKeysTitle">Vos Actions Clés</h3>
            <div id="actionKeysContent">
                <!-- Action keys will be rendered here -->
            </div>
             <p style="font-size: 0.85em; color: var(--secondary-text-color); margin-top:15px;">Ce sont les notes que vous avez marquées comme "Action Clé".</p>
            <div class="popup-buttons">
                <button onclick="closeModal('actionKeysPopup')" aria-label="Fermer la fenêtre des actions clés">Fermer</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        // --- Constants & Icons ---
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`;
        const noteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>`;
        const helpIcon = `<span class="help-icon" aria-hidden="true" tabindex="0">?</span>`; // tabindex for keyboard focus

        // --- Default Data & Tooltips ---
        // Default pillar/sub-pillar data with goal = 10 and tooltips
        const defaultPillarsData = [
             { id: "sante", name: "Santé", tooltip: "Bien-être physique et mental général.", subPillars: [
                 { id: "sante-phy", name: "Physique", score: 5, note: "", goal: 10, isAction: false, tooltip: "Activité physique, énergie, absence de douleur, forme." },
                 { id: "sante-men", name: "Mental", score: 5, note: "", goal: 10, isAction: false, tooltip: "Clarté d'esprit, gestion du stress, santé émotionnelle." },
                 { id: "sante-som", name: "Sommeil", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité et quantité du sommeil récupérateur." },
                 { id: "sante-nut", name: "Nutrition", score: 5, note: "", goal: 10, isAction: false, tooltip: "Équilibre et qualité de l'alimentation." },
                 { id: "sante-ene", name: "Énergie", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau de vitalité et d'endurance au quotidien." }
             ]},
             { id: "famille", name: "Famille", tooltip: "Relations avec les membres de la famille proche.", subPillars: [
                 { id: "fam-pro", name: "Proches", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité des liens avec le conjoint, enfants, parents..." },
                 { id: "fam-com", name: "Communication", score: 5, note: "", goal: 10, isAction: false, tooltip: "Facilité et ouverture dans les échanges familiaux." },
                 { id: "fam-tmp", name: "Temps passé", score: 5, note: "", goal: 10, isAction: false, tooltip: "Quantité et qualité du temps partagé en famille." },
                 { id: "fam-sou", name: "Soutien", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de soutien mutuel reçu et donné." },
                 { id: "fam-har", name: "Harmonie", score: 5, note: "", goal: 10, isAction: false, tooltip: "Climat général, résolution des conflits, entente." }
             ]},
             { id: "finances", name: "Finances", tooltip: "Gestion de l'argent et sécurité financière.", subPillars: [
                 { id: "fin-0", name: "Revenus", score: 5, note: "", goal: 10, isAction: false, tooltip: "Suffisance et satisfaction vis-à-vis des rentrées d'argent." },
                 { id: "fin-1", name: "Épargne", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à mettre de l'argent de côté régulièrement." },
                 { id: "fin-2", name: "Dépenses", score: 5, note: "", goal: 10, isAction: false, tooltip: "Maîtrise du budget et des sorties d'argent." },
                 { id: "fin-3", name: "Investissements", score: 5, note: "", goal: 10, isAction: false, tooltip: "Stratégies pour faire fructifier l'argent (si applicable)." },
                 { id: "fin-4", name: "Sécurité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de sécurité financière face aux imprévus." }
             ]},
             { id: "carriere", name: "Carrière", tooltip: "Travail, profession, activité principale.", subPillars: [
                 { id: "car-0", name: "Satisfaction", score: 5, note: "", goal: 10, isAction: false, tooltip: "Plaisir et épanouissement dans le travail actuel." },
                 { id: "car-1", name: "Progression", score: 5, note: "", goal: 10, isAction: false, tooltip: "Opportunités d'évolution et de développement professionnel." },
                 { id: "car-2", name: "Équilibre", score: 5, note: "", goal: 10, isAction: false, tooltip: "Harmonie entre vie professionnelle et vie personnelle." },
                 { id: "car-3", name: "Compétences", score: 5, note: "", goal: 10, isAction: false, tooltip: "Utilisation et développement des compétences." },
                 { id: "car-4", name: "Reconnaissance", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment d'être reconnu et valorisé pour son travail." }
             ]},
             { id: "loisirs", name: "Loisirs", tooltip: "Activités de détente, passions et temps libre.", subPillars: [
                 { id: "loi-0", name: "Temps libre", score: 5, note: "", goal: 10, isAction: false, tooltip: "Disponibilité de temps pour soi et ses activités." },
                 { id: "loi-1", name: "Passions", score: 5, note: "", goal: 10, isAction: false, tooltip: "Pratique d'activités qui passionnent et ressourcent." },
                 { id: "loi-2", name: "Détente", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à se relaxer et déconnecter." },
                 { id: "loi-3", name: "Créativité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Expression de sa créativité (arts, projets...)." },
                 { id: "loi-4", name: "Social", score: 5, note: "", goal: 10, isAction: false, tooltip: "Activités sociales et divertissements hors relations proches." }
             ]},
             { id: "devperso", name: "Développement perso", tooltip: "Croissance personnelle, apprentissage et objectifs.", subPillars: [
                 { id: "dev-0", name: "Apprentissage", score: 5, note: "", goal: 10, isAction: false, tooltip: "Acquisition de nouvelles connaissances ou compétences." },
                 { id: "dev-1", name: "Objectifs", score: 5, note: "", goal: 10, isAction: false, tooltip: "Clarté et poursuite des objectifs personnels." },
                 { id: "dev-2", name: "Confiance", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau de confiance en soi et en ses capacités." },
                 { id: "dev-3", name: "Résilience", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à faire face aux difficultés et à rebondir." },
                 { id: "dev-4", name: "Clarté", score: 5, note: "", goal: 10, isAction: false, tooltip: "Connaissance de soi, de ses valeurs et de sa direction." }
             ]},
             { id: "relations", name: "Relations sociales", tooltip: "Liens avec les amis, collègues, communauté.", subPillars: [
                 { id: "rel-0", name: "Amis", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité et profondeur des amitiés." },
                 { id: "rel-1", name: "Réseau", score: 5, note: "", goal: 10, isAction: false, tooltip: "Étendue et qualité du réseau social et professionnel." },
                 { id: "rel-2", name: "Écoute", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à écouter activement les autres." },
                 { id: "rel-3", name: "Partage", score: 5, note: "", goal: 10, isAction: false, tooltip: "Facilité à partager et échanger avec les autres." },
                 { id: "rel-4", name: "Qualité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Satisfaction générale de la qualité des interactions sociales." }
             ]},
             { id: "cadrevie", name: "Cadre de vie", tooltip: "Environnement matériel et organisationnel.", subPillars: [
                 { id: "cad-0", name: "Logement", score: 5, note: "", goal: 10, isAction: false, tooltip: "Satisfaction vis-à-vis du lieu de vie." },
                 { id: "cad-1", name: "Environnement", score: 5, note: "", goal: 10, isAction: false, tooltip: "Appréciation de l'environnement proche (quartier, nature...)." },
                 { id: "cad-2", name: "Organisation", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau d'ordre et d'organisation de ses espaces." },
                 { id: "cad-3", name: "Confort", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de confort et de bien-être matériel." },
                 { id: "cad-4", name: "Esthétique", score: 5, note: "", goal: 10, isAction: false, tooltip: "Appréciation de la beauté et de l'harmonie de son cadre." }
             ]}
        ];

        // --- Global Variables ---
        let pillars = [];
        let history = [];
        let currentPillarIndex = 0;
        let chartInstance = null;
        let isPremium = false;
        let longPressTimer = null;
        const PREMIUM_PRESS_DURATION = 10000; // 10 seconds for premium activation
        const pillarColors = [
            'var(--pillar-color-0)', 'var(--pillar-color-1)', 'var(--pillar-color-2)', 'var(--pillar-color-3)',
            'var(--pillar-color-4)', 'var(--pillar-color-5)', 'var(--pillar-color-6)', 'var(--pillar-color-7)'
        ];
        const MINI_TREND_COUNT = 7; // Number of entries for the mini trend graph

        // --- DOM References ---
		const welcomeView = document.getElementById('welcomeView');
        const inputView = document.getElementById('inputView');
        const chartView = document.getElementById('chartView');
        const pillarDisplay = document.getElementById('pillarDisplay');
        const globalScoreDisplay = document.getElementById('globalScore');
        const pillarAverageScoreDisplay = document.getElementById('pillarAverageScore');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const radarChartCanvas = document.getElementById('radarChart');
        const historyContent = document.getElementById('historyContent');
        const overlay = document.getElementById('overlay');
        const themeCheckbox = document.getElementById('theme-checkbox');
        const customizationContent = document.getElementById('customizationContent');
        const showChartBtn = document.getElementById('showChartBtn');
        const notePopup = document.getElementById('notePopup');
        const notePopupSubPillarName = document.getElementById('notePopupSubPillarName');
        const notePopupTextarea = document.getElementById('notePopupTextarea');
        const notePopupActionKeyCheckbox = document.getElementById('notePopupActionKey');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const historyPopup = document.getElementById('historyPopup');
        const historyScrollBtn = document.getElementById('historyScrollToBottomBtn');
        const personalizeBtn = document.getElementById('personalizeBtn');
        const importBtn = document.getElementById('importBtn');
        const appLogo = document.getElementById('appLogo');
        const loadingMessage = document.getElementById('loadingMessage');
        const notification = document.getElementById('notification');
        const actionKeysPopup = document.getElementById('actionKeysPopup');
        const actionKeysContent = document.getElementById('actionKeysContent');
        const miniTrendGraphContainer = document.getElementById('miniTrendGraphContainer');

        // --- Utility Functions ---
        function getCssVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function generateId(prefix = 'item') {
            return `${prefix.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`;
        }

        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.style.display = 'block';
            // Clear previous timer if any
            if (notification.timer) clearTimeout(notification.timer);
            notification.timer = setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Core Application Logic ---

        // Initialize the application
        
        // Initialize the application
        function initializeApp() {
            try {
                // 1. Initial setup (always run these first)
                loadData();
                setupTheme();
                updatePremiumUI();

                // 2. Decide which view to show based on welcome status
                const welcomeDismissed = localStorage.getItem('wheelOfLife_welcomeDismissed') === 'true';

                if (!welcomeDismissed) {
                    // --- Show Welcome Screen ---
                    welcomeView.style.display = 'block';
                    inputView.style.display = 'none'; // Hide input view initially
                    chartView.style.display = 'none'; // Hide chart view initially
                    // Ensure data is loaded even if welcome is shown (needed for potential future actions from welcome)
                    if (pillars.length === 0) {
                         handleNoPillars(); // Handle case where even default load failed
                    }
                    // Note: renderPillar() is NOT called here, only when starting evaluation.
                } else {
                    // --- Welcome Already Seen - Show Input/Evaluation View ---
                    welcomeView.style.display = 'none'; // Ensure welcome is hidden
                    if (pillars.length > 0) {
                        renderPillar(); // Render the current/first pillar
                        showInputView(); // Show the main input view
                    } else {
                        handleNoPillars(); // Handle case where no pillars exist after load
                    }
                }

                // 3. Add event listeners (only once, after view is determined)
                addEventListeners();

                // 4. Show initial notification (only once)
                showNotification("Application chargée. Prête à l'emploi hors ligne !");

            } catch (error) {
                // --- Error Handling ---
                console.error("Erreur critique lors de l'initialisation :", error);
                showNotification("Erreur critique au chargement. Certaines fonctionnalités peuvent être indisponibles. Rechargez ou réinitialisez si le problème persiste.", 6000);
                // Attempt to display *something* even on error, maybe just the error message?
                // Or try a minimal fallback state. For now, just log and notify.
                // You could potentially try to display the welcome screen as a last resort here too.
                 welcomeView.style.display = 'none'; // Hide other views on critical error
                 inputView.style.display = 'none';
                 chartView.style.display = 'none';
                 // Optionally display an error message directly in the body
                 // document.body.innerHTML = `<div class="main-view" style="color: red; text-align: center; padding: 40px;"><h1>Erreur</h1><p>Impossible de charger l'application. ${error.message}</p></div>`;

            } finally {
                // --- Cleanup (always run) ---
                loadingMessage.style.display = 'none'; // Hide loading message
            }
        }		
		
		

        // Handle case where no pillars are defined (should be rare now)
        function handleNoPillars() {
            inputView.style.display = 'block';
            chartView.style.display = 'none';
            pillarDisplay.innerHTML = "<p class='text-center'>Aucun pilier défini. Veuillez recharger l'application ou réinitialiser.</p>";
            globalScoreDisplay.textContent = `Note globale : - / 20`;
            pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            showChartBtn.disabled = true;
            inputView.style.setProperty('--pillar-border-color', 'transparent');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        // Load data from localStorage
        function loadData() {
            const storedPillars = localStorage.getItem('wheelOfLife_pillars');
            const storedHistory = localStorage.getItem('wheelOfLife_history');

            try {
                const parsedPillars = storedPillars ? JSON.parse(storedPillars) : null;
                // Use default data if no stored data or if stored data is invalid/empty
                pillars = parsedPillars && Array.isArray(parsedPillars) && parsedPillars.length > 0
                          ? migrateDataStructure(parsedPillars)
                          : JSON.parse(JSON.stringify(defaultPillarsData));
            } catch (e) {
                console.error("Erreur lors du chargement des piliers, réinitialisation aux valeurs par défaut:", e);
                pillars = JSON.parse(JSON.stringify(defaultPillarsData));
                localStorage.removeItem('wheelOfLife_pillars'); // Remove corrupted data
                showNotification("Données des piliers corrompues. Réinitialisation.");
            }

            try {
                const parsedHistory = storedHistory ? JSON.parse(storedHistory) : [];
                history = Array.isArray(parsedHistory) ? parsedHistory : [];
                 // Ensure history items have a valid structure (basic check)
                 history = history.filter(entry => entry && entry.date && entry.timestamp && Array.isArray(entry.scores));
                history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort newest first
            } catch (e) {
                console.error("Erreur lors du chargement de l'historique, réinitialisation:", e);
                history = [];
                localStorage.removeItem('wheelOfLife_history'); // Remove corrupted data
                showNotification("Historique corrompu. Réinitialisation.");
            }

             // Ensure pillars array is valid after potential errors
             if (!Array.isArray(pillars) || pillars.length === 0) {
                 console.warn("Pillars array invalid after load attempt, forcing defaults.");
                 pillars = JSON.parse(JSON.stringify(defaultPillarsData));
             }

            currentPillarIndex = 0; // Start at the first pillar
            const storedPremium = localStorage.getItem('wheelOfLife_premiumStatus');
            isPremium = storedPremium === 'true';
        }


        // Migrate old data structures if needed (add missing fields like goal, isAction, tooltip)
        function migrateDataStructure(loadedPillars) {
            if (!Array.isArray(loadedPillars)) return JSON.parse(JSON.stringify(defaultPillarsData)); // Fallback

            const defaultMap = new Map();
            defaultPillarsData.forEach(dp => {
                const subMap = new Map();
                dp.subPillars.forEach(dsp => subMap.set(dsp.id, dsp));
                defaultMap.set(dp.id, { pillar: dp, subPillars: subMap });
            });

            return loadedPillars.map((p, pIdx) => {
                const pillarBase = p || {};
                const defaultPillarData = defaultMap.get(pillarBase.id)?.pillar || defaultPillarsData[pIdx] || {}; // Try matching ID, fallback to index
                const defaultSubPillarsMap = defaultMap.get(pillarBase.id)?.subPillars || new Map();

                return {
                    id: pillarBase.id || defaultPillarData.id || generateId(pillarBase.name || `pillar-${pIdx}`),
                    name: pillarBase.name || defaultPillarData.name || `Pilier ${pIdx + 1}`,
                    tooltip: pillarBase.tooltip || defaultPillarData.tooltip || "", // Add tooltip
                    subPillars: Array.isArray(pillarBase.subPillars) ? pillarBase.subPillars.map((sp, spIdx) => {
                        const subPillarBase = typeof sp === 'string' ? { name: sp } : (sp || {});
                        const defaultSubPillarData = defaultSubPillarsMap.get(subPillarBase.id) || defaultPillarData.subPillars?.[spIdx] || {}; // Match ID, fallback index

                        return {
                            id: subPillarBase.id || defaultSubPillarData.id || generateId((pillarBase.id || `p${pIdx}`) + '-' + (subPillarBase.name || `sub-${spIdx}`)),
                            name: subPillarBase.name || defaultSubPillarData.name || `Sous-pilier ${spIdx + 1}`,
                            score: (subPillarBase.score !== undefined && !isNaN(parseInt(subPillarBase.score))) ? parseInt(subPillarBase.score) : 5,
                            note: subPillarBase.note || "",
                            goal: (subPillarBase.goal !== undefined && !isNaN(parseInt(subPillarBase.goal))) ? parseInt(subPillarBase.goal) : 10, // Default goal 10
                            isAction: typeof subPillarBase.isAction === 'boolean' ? subPillarBase.isAction : false, // Add isAction
                            tooltip: subPillarBase.tooltip || defaultSubPillarData.tooltip || "" // Add tooltip
                        };
                    }) : (defaultPillarData.subPillars ? JSON.parse(JSON.stringify(defaultPillarData.subPillars)) : []) // Fallback if subPillars missing
                };
            }).filter(p => p.name && p.id); // Ensure basic validity
        }


        // Save current state (pillars, history) to localStorage
        const debouncedSaveData = debounce(saveData, 500); // Debounce saving
        function saveData() {
            try {
                localStorage.setItem('wheelOfLife_pillars', JSON.stringify(pillars));
                localStorage.setItem('wheelOfLife_history', JSON.stringify(history));
                 // console.log("Data saved successfully."); // Optional: for debugging
            } catch (e) {
                console.error("Erreur lors de la sauvegarde :", e);
                // Handle potential quota exceeded error
                if (e.name === 'QuotaExceededError') {
                    showNotification("Erreur: Espace de stockage local plein. Impossible de sauvegarder.", 5000);
                    // Consider offering to prune old history here
                } else {
                    showNotification("Erreur : Impossible de sauvegarder les données.", 5000);
                }
            }
        }

        // --- Premium Feature Handling ---
        function savePremiumStatus() {
            localStorage.setItem('wheelOfLife_premiumStatus', isPremium);
        }

        function activatePremium() {
            if (isPremium) return;
            isPremium = true;
            savePremiumStatus();
            updatePremiumUI();
            showNotification("Mode Premium activé ! Fonctionnalités supplémentaires débloquées.", 4000);
        }

        function updatePremiumUI() {
            // Toggle visibility based on premium status
            const displayValue = isPremium ? 'inline-block' : 'none';
            if (personalizeBtn) personalizeBtn.style.display = displayValue;
            if (importBtn) importBtn.style.display = displayValue; // Assuming import is premium
             // Also update the export button which might be premium too
             const exportBtn = document.querySelector('button[onclick="exportData()"]');
             if (exportBtn) exportBtn.style.display = displayValue;

            const helpPersonalize = document.getElementById('helpPersonalizeSection');
            const helpImport = document.getElementById('helpImportSection');
            if (helpPersonalize) helpPersonalize.style.display = isPremium ? 'list-item' : 'none';
            if (helpImport) helpImport.style.display = isPremium ? 'list-item' : 'none';
        }

        // Logo long press handlers
        function handleLogoPressStart(event) {
            // Prevent context menu on long press (especially mobile)
            event.preventDefault();
            clearTimeout(longPressTimer);
            // Visual feedback for press start (optional)
            // appLogo.style.transform = 'scale(0.95)';
            longPressTimer = setTimeout(activatePremium, PREMIUM_PRESS_DURATION);
        }

        function handleLogoPressEnd() {
            clearTimeout(longPressTimer);
            // Reset visual feedback (optional)
            // appLogo.style.transform = 'scale(1)';
        }


        // --- Pillar Rendering & Interaction ---

        // Render the current pillar's content
        function renderPillar() {
            if (!pillars || pillars.length === 0) {
                handleNoPillars();
                return;
            }
            // Ensure currentPillarIndex is valid
            if (currentPillarIndex < 0 || currentPillarIndex >= pillars.length) {
                currentPillarIndex = 0;
            }

            const pillar = pillars[currentPillarIndex];
            const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
            inputView.style.setProperty('--pillar-border-color', pillarColor);

            // Render Pillar Navigation Tabs
            const navContainer = document.getElementById('pillarNavigation');
            navContainer.innerHTML = pillars.map((p, idx) => `
                <button class="pillar-nav-button ${idx === currentPillarIndex ? 'active' : ''}"
                        onclick="navigateToPillar(${idx})"
                        aria-label="Aller au pilier ${p.name}"
                        aria-current="${idx === currentPillarIndex ? 'true' : 'false'}">
                    ${p.name}
                </button>
            `).join('');

             // Tooltip generation function
             const createTooltip = (text) => {
                 if (!text) return '';
                 // Using tabIndex=0 makes the icon focusable for keyboard users
                 return `<span class="help-icon" aria-hidden="true" tabindex="0">?<span class="tooltiptext">${text}</span></span>`;
             };

            // Build Pillar HTML
             let pillarHTML = `
                 <h3 id="pillar-title">
                     <span>${pillar.name}</span>
                     ${createTooltip(pillar.tooltip)}
                     <span style="font-weight:normal; font-size: 0.8em; margin-left: auto;">(${currentPillarIndex + 1}/${pillars.length})</span>
                 </h3>
                 <div class="pillar-actions">
                     <button onclick="applyGoalToAllSubPillars('${pillar.id}', 10)" aria-label="Appliquer l'objectif 10 à tous les sous-piliers de ${pillar.name}">Objectif 10 pour tous</button>
                     <button onclick="resetPillarScores('${pillar.id}', 5)" aria-label="Réinitialiser les notes de tous les sous-piliers de ${pillar.name} à 5">Notes à 5</button>
                 </div>
             `;


            if (!pillar.subPillars || pillar.subPillars.length === 0) {
                pillarHTML += "<p class='text-center'>Ce pilier n'a pas de sous-piliers.</p>";
            } else {
                pillar.subPillars.forEach((subPillar, index) => {
                    // Ensure scores/goals are numbers, provide defaults if not
                    const displayScore = (typeof subPillar.score === 'number' && !isNaN(subPillar.score)) ? subPillar.score : 5;
                    const displayGoal = (typeof subPillar.goal === 'number' && !isNaN(subPillar.goal)) ? subPillar.goal : 10; // Default 10

                    pillarHTML += `
                        <div class="sub-pillar" id="subpillar-div-${subPillar.id}">
                            <div class="sub-pillar-header">
                                <label for="range-${subPillar.id}" id="label-${subPillar.id}">
                                    <span>${subPillar.name}</span>
                                    ${createTooltip(subPillar.tooltip)}
                                </label>
                                <div class="sub-pillar-controls">
                                    <input type="range" id="range-${subPillar.id}" min="1" max="10" value="${displayScore}" oninput="updateScore('${pillar.id}', '${subPillar.id}', this.value, true)" aria-labelledby="label-${subPillar.id} slider-value-${subPillar.id}" aria-valuemin="1" aria-valuemax="10" aria-valuenow="${displayScore}">
                                    <output class="slider-value" id="slider-value-${subPillar.id}" for="range-${subPillar.id}">${displayScore}</output>
                                </div>
                            </div>
                            <div class="sub-pillar-details">
                                <div class="detail-group">
                                    <label for="goal-${subPillar.id}">Objectif:</label>
                                    <input type="number" id="goal-${subPillar.id}" min="1" max="10" value="${displayGoal}" onchange="updateGoal('${pillar.id}', '${subPillar.id}', this.value)" aria-label="Objectif pour ${subPillar.name}">
                                </div>
                                <div class="detail-group">
                                    <button class="note-button" onclick="openNotePopup('${pillar.id}', '${subPillar.id}')" aria-label="Ajouter ou modifier une note pour ${subPillar.name}">
                                        ${noteIcon}
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
            }
            pillarDisplay.innerHTML = pillarHTML;

            // Update UI elements
            updateNavigationButtons();
            updateScoresDisplay(); // Update scores immediately
            showChartBtn.disabled = false; // Enable chart button if pillars exist
        }

        // Find a specific sub-pillar in the data structure
        function findSubPillar(pillarId, subPillarId) {
            const pillar = pillars.find(p => p.id === pillarId);
            if (!pillar || !Array.isArray(pillar.subPillars)) {
                console.warn(`Pillar not found or invalid: ${pillarId}`);
                return null;
            }
            const subPillar = pillar.subPillars.find(sp => sp.id === subPillarId);
             if (!subPillar) {
                 console.warn(`SubPillar not found: ${subPillarId} in pillar ${pillarId}`);
             }
            return subPillar;
        }

        // Debounced function for updating score displays
        const debouncedUpdateScoresDisplay = debounce(updateScoresDisplay, 150);

        // Update a sub-pillar's score
        function updateScore(pillarId, subPillarId, value, fromInput = false) {
            const score = parseInt(value);
            // Basic validation
            if (isNaN(score) || score < 1 || score > 10) {
                 console.warn(`Invalid score value received: ${value}`);
                 // Optionally reset the input value?
                 return;
            }

            const subPillar = findSubPillar(pillarId, subPillarId);
            if (subPillar) {
                subPillar.score = score;
                // Update the UI immediately if triggered by user input
                if (fromInput) {
                    const output = document.getElementById(`slider-value-${subPillarId}`);
                    if (output) output.textContent = score;
                    const rangeInput = document.getElementById(`range-${subPillarId}`);
                    if (rangeInput) rangeInput.setAttribute('aria-valuenow', score); // Update ARIA value
                }
                debouncedUpdateScoresDisplay(); // Update averages display (debounced)
                debouncedSaveData(); // Save data (debounced)
            }
        }

         // Update a sub-pillar's note and action key status
         function updateNote(pillarId, subPillarId, noteValue, isActionValue) {
             const subPillar = findSubPillar(pillarId, subPillarId);
             if (subPillar) {
                 subPillar.note = noteValue.trim();
                 subPillar.isAction = !!isActionValue; // Ensure boolean
                 debouncedSaveData();
             }
         }


        // Update a sub-pillar's goal
        function updateGoal(pillarId, subPillarId, value) {
            const goal = parseInt(value);
            const input = document.getElementById(`goal-${subPillarId}`);
            const subPillar = findSubPillar(pillarId, subPillarId);

            if (subPillar) {
                if (!isNaN(goal) && goal >= 1 && goal <= 10) {
                    subPillar.goal = goal;
                    debouncedSaveData(); // Save data
                } else {
                    // Invalid input, revert to the stored value
                    if (input) input.value = subPillar.goal !== undefined ? subPillar.goal : 10; // Revert to current or default 10
                    showNotification("L'objectif doit être un nombre entre 1 et 10.", 3000);
                }
            }
        }

         // Apply a specific goal to all sub-pillars of a given pillar
         function applyGoalToAllSubPillars(pillarId, goalValue) {
             const pillar = pillars.find(p => p.id === pillarId);
             if (!pillar || !Array.isArray(pillar.subPillars)) return;

             let changed = false;
             pillar.subPillars.forEach(sp => {
                 if (sp.goal !== goalValue) {
                     sp.goal = goalValue;
                     const input = document.getElementById(`goal-${sp.id}`);
                     if (input) input.value = goalValue;
                     changed = true;
                 }
             });

             if (changed) {
                 debouncedSaveData();
                 showNotification(`Objectif ${goalValue} appliqué à tous les sous-piliers de "${pillar.name}".`);
                 // No need to re-render, just saved data and updated inputs
             } else {
                 showNotification(`Tous les objectifs étaient déjà à ${goalValue}.`);
             }
         }

         // Reset scores of all sub-pillars of a given pillar
         function resetPillarScores(pillarId, scoreValue) {
             const pillar = pillars.find(p => p.id === pillarId);
             if (!pillar || !Array.isArray(pillar.subPillars)) return;

             let changed = false;
             pillar.subPillars.forEach(sp => {
                 if (sp.score !== scoreValue) {
                     sp.score = scoreValue;
                     // Update corresponding UI elements
                     const rangeInput = document.getElementById(`range-${sp.id}`);
                     const output = document.getElementById(`slider-value-${sp.id}`);
                     if (rangeInput) {
                         rangeInput.value = scoreValue;
                         rangeInput.setAttribute('aria-valuenow', scoreValue);
                     }
                     if (output) output.textContent = scoreValue;
                     changed = true;
                 }
             });

             if (changed) {
                 debouncedUpdateScoresDisplay(); // Update averages
                 debouncedSaveData(); // Save changes
                 showNotification(`Notes réinitialisées à ${scoreValue} pour "${pillar.name}".`);
             } else {
                  showNotification(`Toutes les notes étaient déjà à ${scoreValue}.`);
             }
         }

        // Calculate pillar averages and global score
        function calculateAverages() {
            if (!pillars || pillars.length === 0) {
                return { pillarAverages: [], globalScore: 0 };
            }
            const pillarAverages = pillars.map(pillar => {
                // Handle pillars with no sub-pillars gracefully
                if (!pillar.subPillars || pillar.subPillars.length === 0) return NaN; // Use NaN to indicate invalid/no score
                // Filter out potentially non-numeric scores before summing
                const validScores = pillar.subPillars.map(sub => sub.score).filter(score => typeof score === 'number' && !isNaN(score));
                if (validScores.length === 0) return NaN; // No valid scores in this pillar
                const sum = validScores.reduce((acc, score) => acc + score, 0);
                return sum / validScores.length; // Calculate average based on valid scores
            });

            // Calculate global average only from pillars that have a valid average
            const validPillarAverages = pillarAverages.filter(avg => !isNaN(avg));
            const globalAverage = validPillarAverages.length > 0
                ? validPillarAverages.reduce((sum, avg) => sum + avg, 0) / validPillarAverages.length
                : 0; // Default to 0 if no valid pillar averages

            const globalScore = globalAverage * 2; // Scale to /20

            return { pillarAverages, globalScore };
        }

        // Update the score displays (global and current pillar)
        function updateScoresDisplay() {
            if (!pillars || pillars.length === 0) {
                 // Reset display if no pillars
                 globalScoreDisplay.textContent = `Note globale : - / 20`;
                 pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
                 return;
             }
            const { pillarAverages, globalScore } = calculateAverages();
            globalScoreDisplay.textContent = `Note globale : ${globalScore.toFixed(1)} / 20`;

            // Handle current pillar average display, including NaN case
            const currentPillarAverage = pillarAverages[currentPillarIndex];
            pillarAverageScoreDisplay.textContent = `Moyenne Pilier : ${!isNaN(currentPillarAverage) ? currentPillarAverage.toFixed(1) : '-'} / 10`;
        }

        // Navigate between pillars
        function navigateToPillar(index) {
            if (index === currentPillarIndex || index < 0 || index >= pillars.length) return;
            currentPillarIndex = index;
            renderPillar();
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
        }
        function changePillar(direction) {
            if (!pillars || pillars.length <= 1) return; // No change if 0 or 1 pillar
            let newIndex = currentPillarIndex + direction;
            if (newIndex < 0) {
                newIndex = pillars.length - 1; // Wrap around (last)
            } else if (newIndex >= pillars.length) {
                newIndex = 0; // Wrap around (first)
            }
            navigateToPillar(newIndex);
        }

        // Update the state of Previous/Next buttons
        function updateNavigationButtons() {
            const numPillars = pillars ? pillars.length : 0;
            prevBtn.disabled = numPillars <= 1;
            nextBtn.disabled = numPillars <= 1;
        }

        // Scroll history popup to the bottom
        function historyScrollToBottom() {
            if (historyPopup) {
                // Scroll to the button container instead of the absolute bottom
                 const buttons = historyPopup.querySelector('.popup-buttons');
                 if (buttons) {
                     buttons.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 } else {
                     historyPopup.scrollTo({ top: historyPopup.scrollHeight, behavior: 'smooth' });
                 }
            }
        }

        // --- View Switching ---

        function showInputView() {
            welcomeView.style.display = 'none'; 
			inputView.style.display = 'block';
            chartView.style.display = 'none';
            // Re-apply border color in case it was changed by comparison chart
            if (pillars.length > 0 && currentPillarIndex >= 0 && currentPillarIndex < pillars.length) {
                const pillarColor = pillarColors[currentPillarIndex % pillarColors.length];
                inputView.style.setProperty('--pillar-border-color', pillarColor);
            } else {
                inputView.style.setProperty('--pillar-border-color', 'transparent');
            }
             // Try to focus a relevant element, e.g., the first slider or the next button
             const firstSlider = inputView.querySelector('input[type="range"]');
             if (firstSlider) {
                 // firstSlider.focus(); // Focusing sliders directly can be jarring, maybe focus nav instead
             } else if (nextBtn && !nextBtn.disabled) {
                 nextBtn.focus();
             }
        }
		
        // Called when user clicks the button on the welcome screen
        function startEvaluation() {
            // 1. Mark welcome as dismissed
            localStorage.setItem('wheelOfLife_welcomeDismissed', 'true');
            welcomeView.style.display = 'none'; // Hide welcome screen

            // 2. Ensure pillar content is ready FIRST
            if (pillars.length > 0) {
                // Always render the current/first pillar when starting evaluation from welcome
                // Make sure currentPillarIndex is 0 if coming from welcome
                currentPillarIndex = 0;
                renderPillar();
            } else {
                 handleNoPillars(); // Handle case where no pillars exist (shouldn't happen with defaults)
                 return; // Stop if no pillars, nothing to show in input view
            }

            // 3. THEN show the view containing the rendered content
            showInputView();

            // 4. Focus logic (optional but good for UX)
            const firstSlider = inputView.querySelector('input[type="range"]');
            if (firstSlider) {
               // firstSlider.focus(); // Optional: Focusing sliders directly can be jarring
            } else if (nextBtn && !nextBtn.disabled) {
               nextBtn.focus(); // Focus next button is a reasonable default
            } else if (prevBtn && !prevBtn.disabled) {
               prevBtn.focus(); // Fallback to prev button
            }
        }



        function showChartView() {
			welcomeView.style.display = 'none';
            inputView.style.display = 'none';
            chartView.style.display = 'block';
            renderChart(); // Render or update the chart
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Focus a button in the chart view for accessibility
            const historyButton = chartView.querySelector('button[onclick^="openModal(\'historyPopup\'"]');
            if (historyButton) {
                 historyButton.focus();
            }
        }

        // --- Chart Rendering ---

        function renderChart(comparisonData = null) {
            const ctx = radarChartCanvas.getContext('2d');
            const themeTextColor = getCssVar('--text-color');
            const themeSecondaryTextColor = getCssVar('--secondary-text-color');
            const themeGridColor = getCssVar('--grid-color');
            const themeContainerBgColor = getCssVar('--container-bg');
            const themeTooltipBgColor = getCssVar('--tooltip-bg');

             // Common Chart Options
             const commonOptions = {
                 responsive: true,
                 maintainAspectRatio: true,
                 scales: {
                     r: {
                         min: 0,
                         max: 10,
                         ticks: { stepSize: 2, backdropColor: themeContainerBgColor, color: themeSecondaryTextColor, font: { size: 10 } },
                         pointLabels: { color: themeTextColor, font: { size: 11 } }, // Slightly smaller point labels
                         grid: { color: themeGridColor },
                         angleLines: { color: themeGridColor }
                     }
                 },
                 plugins: {
                     legend: { position: 'top', labels: { color: themeTextColor, usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11 } } },
                     tooltip: {
                         enabled: true,
                         backgroundColor: themeTooltipBgColor,
                         titleColor: themeTextColor,
                         bodyColor: themeTextColor,
                         borderColor: themeGridColor,
                         borderWidth: 1,
                         padding: 10,
                         cornerRadius: 4,
                         usePointStyle: true,
                         callbacks: {
                             label: function(context) {
                                 let label = context.dataset.label || '';
                                 if (label) label += ': ';
                                 if (context.parsed.r !== null) label += context.parsed.r.toFixed(1);
                                 return label;
                             }
                         }
                     }
                 },
                  animation: {
                      // Disable animation for theme changes/updates, enable for initial draw?
                      // Consider disabling all animations for simplicity and performance
                      duration: 0
                  },
                  // Elements styling can also be theme-dependent if needed
                  elements: {
                     line: {
                         borderWidth: 2.5 // Default line width
                     },
                     point: {
                         radius: 4,
                         hoverRadius: 6,
                         pointStyle: 'circle'
                     }
                 }
             };

            let chartData;
            let chartOptions = commonOptions; // Start with common options

            if (comparisonData) {
                 // --- Comparison Chart ---
                 const labels = comparisonData.labels;
                 chartData = {
                     labels: labels,
                     datasets: comparisonData.datasets.map((dataset, index) => ({
                         ...dataset, // Spread existing dataset properties (label, data)
                         backgroundColor: index === 0 ? getCssVar('--chart-bg-color') : getCssVar('--goal-bg-color'), // Use existing theme vars for comparison
                         borderColor: index === 0 ? getCssVar('--chart-border-color') : getCssVar('--goal-border-color'),
                         pointBackgroundColor: index === 0 ? getCssVar('--chart-border-color') : getCssVar('--goal-border-color'),
                         pointBorderColor: '#fff',
                         pointHoverBackgroundColor: '#fff',
                         pointHoverBorderColor: index === 0 ? getCssVar('--chart-border-color') : getCssVar('--goal-border-color'),
                     }))
                 };
                 // Specific options for comparison chart could be added here if needed
                 chartOptions.plugins.legend.labels.usePointStyle = true; // Good for comparisons

            } else {
                 // --- Standard Chart (Current + Goal) ---
                 if (!pillars || pillars.length === 0) {
                     if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
                     return; // No data to render
                 }
                const { pillarAverages } = calculateAverages();
                 // Calculate average goals per pillar
                 const pillarGoalsAverages = pillars.map(pillar => {
                     if (!pillar.subPillars || pillar.subPillars.length === 0) return NaN;
                     const validGoals = pillar.subPillars.map(sub => sub.goal).filter(goal => typeof goal === 'number' && !isNaN(goal));
                     if (validGoals.length === 0) return NaN;
                     const sum = validGoals.reduce((acc, goal) => acc + goal, 0);
                     return sum / validGoals.length;
                 });

                 const labels = pillars.map(p => p.name);
                 const scoreBgColor = getCssVar('--chart-bg-color');
                 const scoreBorderColor = getCssVar('--chart-border-color');
                 const goalBgColor = getCssVar('--goal-bg-color');
                 const goalBorderColor = getCssVar('--goal-border-color');

                 chartData = {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Score Actuel',
                             data: pillarAverages.map(avg => isNaN(avg) ? 0 : avg), // Replace NaN with 0 for charting
                             backgroundColor: scoreBgColor,
                             borderColor: scoreBorderColor,
                             pointBackgroundColor: scoreBorderColor,
                             pointBorderColor: '#fff',
                             pointHoverBackgroundColor: '#fff',
                             pointHoverBorderColor: scoreBorderColor,
                         },
                         {
                             label: 'Objectif Moyen',
                             data: pillarGoalsAverages.map(avg => isNaN(avg) ? 0 : avg), // Replace NaN with 0
                             backgroundColor: goalBgColor,
                             borderColor: goalBorderColor,
                             borderWidth: 1.5, // Thinner line for goal
                             borderDash: [6, 3], // Dashed line for goal
                             pointBackgroundColor: goalBorderColor,
                             pointBorderColor: '#fff',
                             pointHoverBackgroundColor: '#fff',
                             pointHoverBorderColor: goalBorderColor,
                             pointRadius: 3, // Slightly smaller points for goal
                             pointHoverRadius: 5,
                         }
                     ]
                 };
                 chartOptions.plugins.legend.labels.usePointStyle = false; // Standard legend
             }


            // Create or Update Chart.js instance
            if (chartInstance) {
                 // If chart exists, update its data and options
                 chartInstance.data = chartData;
                 chartInstance.options = chartOptions;
                 chartInstance.update('none'); // 'none' prevents animation on update
            } else {
                 // If chart doesn't exist, create it
                 chartInstance = new Chart(ctx, {
                     type: 'radar',
                     data: chartData,
                     options: chartOptions
                 });
            }
        }


        // --- History Management ---

        // Show chart view and save the current state to history
        function showChartAndSave() {
            if (!pillars || pillars.length === 0) {
                showNotification("Aucun pilier à afficher ou sauvegarder.");
                return;
            }
            const { pillarAverages } = calculateAverages();
            saveToHistory(pillarAverages); // Save current state
            showChartView(); // Switch to chart view
            showNotification("Évaluation sauvegardée avec succès.");
        }

        // Save the current pillar data to the history array
        function saveToHistory(currentAverages) {
             const timestamp = Date.now();
             const twentyFourHoursInMillis = 24 * 60 * 60 * 1000;

             // Create a deep copy of pillars data for the history entry
             const scoresData = pillars.map((p, index) => ({
                 pillarId: p.id,
                 pillarName: p.name,
                 average: (!isNaN(currentAverages[index]) ? currentAverages[index] : 0), // Store calculated average
                 // Deep copy subPillars to avoid future modifications affecting history
                 subPillars: JSON.parse(JSON.stringify(p.subPillars || []))
             }));

             const newEntry = {
                 id: `hist-${timestamp}-${Math.random().toString(36).substr(2, 5)}`,
                 date: new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' }),
				 timestamp: timestamp,
                 scores: scoresData
             };

             // Sort history by timestamp DESCENDING (newest first) before checking
             history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

             const lastEntry = history.length > 0 ? history[0] : null;

             // Check if the last entry is within 24 hours
             if (lastEntry && (timestamp - (lastEntry.timestamp || 0)) < twentyFourHoursInMillis) {
                 console.log("Remplacement de l'entrée récente (< 24h).");
                 history[0] = newEntry; // Replace the most recent entry
             } else {
                 console.log("Ajout d'une nouvelle entrée à l'historique.");
                 history.push(newEntry); // Add as a new entry
                 // Re-sort after adding (push might not preserve order if history was empty)
                 history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
             }

             // Limit history size (e.g., keep last 100 entries) - Optional
             const MAX_HISTORY_ENTRIES = 100;
             if (history.length > MAX_HISTORY_ENTRIES) {
                 history = history.slice(0, MAX_HISTORY_ENTRIES); // Keep the newest 100
                 console.log(`Historique limité aux ${MAX_HISTORY_ENTRIES} dernières entrées.`);
             }


             saveData(); // Save the updated history
        }


        // Render the history list in its popup
        function showHistory() {
            historyContent.innerHTML = ''; // Clear previous content
            miniTrendGraphContainer.innerHTML = ''; // Clear previous graph

            if (history.length === 0) {
                historyContent.innerHTML = "<p>Aucun historique disponible.</p>";
                if (historyScrollBtn) historyScrollBtn.style.display = 'none';
                document.getElementById('compareControls').style.display = 'none';
                return;
            }

            renderMiniTrendGraph(); // Render the trend graph first

            const ul = document.createElement('ul');
            history.forEach((entry, index) => {
                if (!entry || !entry.scores || !Array.isArray(entry.scores)) {
                    console.warn("Skipping invalid history entry:", entry);
                    return; // Skip invalid entries
                }

                const li = document.createElement('li');
                li.className = 'history-entry';

                // Calculate global score for this entry
                const entryAverages = entry.scores.map(s => s.average).filter(avg => !isNaN(avg));
                const entryGlobalScore = entryAverages.length > 0 ? (entryAverages.reduce((sum, avg) => sum + avg, 0) / entryAverages.length * 2) : 0;

                let entryHTML = `
                    <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px;">
                         <input type="checkbox" class="history-compare-checkbox" data-index="${index}" onchange="updateCompareControls()" aria-label="Sélectionner l'entrée du ${entry.date} pour comparaison">
                         <strong>${entry.date || 'Date inconnue'}</strong>
                         <span style="font-size: 0.9em; color: var(--secondary-text-color);">(Score Global: ${entryGlobalScore.toFixed(1)}/20)</span>
                    </div>`;

                // Find the previous entry *in the sorted list* for comparison
                const prevEntry = history[index + 1]; // Because history is sorted newest first

                entryHTML += '<div class="history-scores">';
                entry.scores.forEach(currentScore => {
                    entryHTML += `${currentScore.pillarName || 'Pilier inconnu'}: ${currentScore.average !== undefined ? currentScore.average.toFixed(1) : '-'}`;

                    // Compare with the score from the *previous* entry (older one)
                    if (prevEntry && prevEntry.scores && Array.isArray(prevEntry.scores)) {
                        const prevPillarScore = prevEntry.scores.find(ps => ps.pillarId === currentScore.pillarId);
                        if (prevPillarScore && prevPillarScore.average !== undefined && currentScore.average !== undefined) {
                            const diff = currentScore.average - prevPillarScore.average;
                            if (Math.abs(diff) > 0.05) { // Show diff only if significant
                                const diffClass = diff > 0 ? 'positive' : 'negative';
                                const diffSign = diff > 0 ? '+' : '';
                                entryHTML += ` <span class="score-diff ${diffClass}" title="vs ${prevPillarScore.average.toFixed(1)} le ${prevEntry.date || ''}">(${diffSign}${diff.toFixed(1)})</span>`;
                            }
                        }
                    }
                    entryHTML += '<br>';
                });
                entryHTML += '</div>';
                li.innerHTML = entryHTML;
                ul.appendChild(li);
            });

            historyContent.appendChild(ul);
            document.getElementById('compareControls').style.display = 'block'; // Show compare button container
            updateCompareControls(); // Set initial state of compare button

            // Show/hide scroll-to-bottom button based on content height
            if (historyPopup && historyScrollBtn) {
                // Use setTimeout to allow the DOM to update fully before checking scrollHeight
                setTimeout(() => {
                     // Check if the element still exists (popup might be closed quickly)
                     if (document.getElementById('historyPopup')) {
                         const isScrollable = historyPopup.scrollHeight > historyPopup.clientHeight;
                         historyScrollBtn.style.display = isScrollable ? 'inline-block' : 'none';
                     }
                 }, 100); // Small delay
            }
        }

        // Render the mini trend graph in the history popup
        function renderMiniTrendGraph() {
             if (history.length < 2) { // Need at least 2 points for a trend
                 miniTrendGraphContainer.innerHTML = ''; // Clear if not enough data
                 return;
             }

             // Get the last N entries (remember history is sorted newest first)
             const trendData = history.slice(0, MINI_TREND_COUNT).reverse(); // Get newest, then reverse to plot oldest first

             const scores = trendData.map(entry => {
                 const entryAverages = entry.scores.map(s => s.average).filter(avg => !isNaN(avg));
                 return entryAverages.length > 0 ? (entryAverages.reduce((sum, avg) => sum + avg, 0) / entryAverages.length * 2) : 0; // Global score /20
             });

             const maxValue = 20; // Max possible score is 20
             const minValue = 0;

             let graphHTML = `
                 <div class="mini-trend-graph">
                     <h5>Tendance Globale Récente (/20)</h5>
                     <div class="trend-bars">`;

             scores.forEach((score, index) => {
                 const percentageHeight = maxValue > 0 ? (score / maxValue * 100) : 0;
                 const dateLabel = trendData[index].date.split(',')[0]; // Just the date part
                 graphHTML += `
                     <div class="trend-bar-item" title="${trendData[index].date}: ${score.toFixed(1)}/20">
                          <div class="bar-value">${score.toFixed(1)}</div>
                         <div class="trend-bar" style="height: ${percentageHeight}%;">
                             <span>${dateLabel}</span>
                         </div>
                     </div>`;
             });

             graphHTML += `
                     </div>
                 </div>`;

             miniTrendGraphContainer.innerHTML = graphHTML;
         }


        // Update the state of the 'Compare' button based on checkbox selection
        function updateCompareControls() {
            const selectedCheckboxes = document.querySelectorAll('.history-compare-checkbox:checked');
            const compareBtn = document.getElementById('compareBtn');
            if (compareBtn) {
                 compareBtn.disabled = selectedCheckboxes.length !== 2;
             }
        }

        // Get selected history entries and trigger comparison chart rendering
        function compareSelectedEntries() {
             const selectedCheckboxes = document.querySelectorAll('.history-compare-checkbox:checked');
             if (selectedCheckboxes.length !== 2) {
                 showNotification("Veuillez sélectionner exactement deux évaluations à comparer.");
                 return;
             }

             // Get the indices from the data attributes
             const indices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));

             // Get the corresponding history entries (make sure indices are valid)
             if (indices.some(isNaN) || indices.some(idx => idx < 0 || idx >= history.length)) {
                  showNotification("Erreur: Sélection invalide.");
                  console.error("Invalid indices for comparison:", indices);
                  return;
              }

             const entriesToCompare = [history[indices[0]], history[indices[1]]];

             // Ensure the entries are valid
             if (entriesToCompare.some(entry => !entry || !entry.scores)) {
                 showNotification("Erreur: Impossible de comparer les entrées sélectionnées (données manquantes).");
                 console.error("Invalid entries selected for comparison:", entriesToCompare);
                 return;
             }


            // Prepare data for the comparison chart
            // Use the *current* pillar names as labels, as they might have changed
             const currentPillarLabels = pillars.map(p => p.name);
             const comparisonDatasets = entriesToCompare.map(entry => {
                 // Map historical scores to the current pillar structure/order using pillarId
                 const data = currentPillarLabels.map(label => {
                     // Find the pillar in the *current* structure that matches the label
                     const currentPillar = pillars.find(p => p.name === label);
                     if (!currentPillar) return 0; // Pillar might have been deleted

                     // Find the score in the *historical* entry that matches this pillar's ID
                     const historicalScore = entry.scores.find(s => s.pillarId === currentPillar.id);
                     return historicalScore ? (historicalScore.average || 0) : 0; // Default to 0 if not found
                 });

                 return {
                     label: `Éval. ${entry.date}`, // Label for the dataset
                     data: data // Array of scores in the order of currentPillarLabels
                 };
             });


            const comparisonChartData = {
                labels: currentPillarLabels,
                datasets: comparisonDatasets
            };

            closeModal('historyPopup'); // Close the history modal
            showChartView(); // Switch to the chart view
            renderChart(comparisonChartData); // Render the comparison chart
            showNotification(`Comparaison des évaluations du ${entriesToCompare[0].date} et ${entriesToCompare[1].date}.`);
        }

        // --- Action Keys Management ---
         function openActionKeysPopup() {
             renderActionKeys();
             openModal('actionKeysPopup');
         }

         function renderActionKeys() {
             actionKeysContent.innerHTML = '';
             const actions = [];

             // Iterate through history (newest first) to find actions
             history.forEach(entry => {
                 if (!entry || !entry.scores) return;
                 entry.scores.forEach(pillarScore => {
                     if (!pillarScore.subPillars) return;
                     pillarScore.subPillars.forEach(sp => {
                         if (sp.isAction && sp.note) {
                             actions.push({
                                 date: entry.date,
                                 pillarName: pillarScore.pillarName,
                                 subPillarName: sp.name,
                                 note: sp.note,
                                 // We need IDs to potentially jump back to the item later (more complex)
                                 // pillarId: pillarScore.pillarId,
                                 // subPillarId: sp.id
                             });
                         }
                     });
                 });
             });

             if (actions.length === 0) {
                 actionKeysContent.innerHTML = '<p>Aucune action clé définie pour le moment.</p><p style="font-size: 0.9em;">Utilisez l\'icône <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:0.9em; height:0.9em; vertical-align: -0.1em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> puis cochez la case "Marquer comme Action Clé".</p>';
                 return;
             }

             const ul = document.createElement('ul');
             actions.forEach(action => {
                 const li = document.createElement('li');
                 li.className = 'action-key-entry';
                 // Basic HTML structure for each action
                 li.innerHTML = `
                     <strong>${action.pillarName} > ${action.subPillarName}</strong>
                     <span style="font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px;">(${action.date})</span>
                     <div class="action-key-note">${action.note}</div>
                     `;
                 ul.appendChild(li);
             });
             actionKeysContent.appendChild(ul);
         }


        // --- Import / Export / Reset ---

        // Copy history and AI prompt to clipboard
        function copyHistory() {
            if (history.length === 0) {
                showNotification("L'historique est vide, rien à copier.");
                return;
            }
            try {
                 // Prune potentially large note fields for brevity if needed for AI context limits
                 const historyForAI = history.map(entry => ({
                     ...entry,
                     scores: entry.scores.map(score => ({
                         ...score,
                         subPillars: score.subPillars.map(sp => ({
                             ...sp,
                             // Truncate long notes for AI prompt? Optional.
                             // note: sp.note.length > 200 ? sp.note.substring(0, 197) + '...' : sp.note
                         }))
                     }))
                 }));

                 const historyJson = JSON.stringify(historyForAI, null, 2); // Pretty print JSON
                 const promptText = `Bonjour ! Voici mon historique d'évaluations de la Roue de la Vie, au format JSON. Chaque entrée représente une évaluation à une date donnée, avec les scores moyens par pilier et les détails (note, objectif, score) pour chaque sous-pilier.\n\nPeux-tu m'aider à analyser ces données pour :\n1. Identifier les tendances d'évolution (positives et négatives) dans les différents domaines de ma vie ?\n2. Repérer mes points forts et mes points faibles récurrents ?\n3. Me suggérer des pistes de réflexion ou d'action concrètes pour améliorer mon équilibre global et travailler sur les domaines les moins satisfaisants, en te basant sur mes notes et objectifs passés ?\n\nVoici les données :\n\n\`\`\`json\n${historyJson}\n\`\`\`\n\nMerci pour ton analyse et tes conseils !`;

                 navigator.clipboard.writeText(promptText).then(() => {
                     showNotification("Historique formaté et prompt pour IA copiés ! Collez dans votre IA préférée.", 5000);
                 }).catch(err => {
                     console.error("Erreur lors de la copie vers le presse-papiers :", err);
                     showNotification("Erreur : Impossible de copier. Vérifiez les permissions du navigateur.", 4000);
                 });
             } catch (error) {
                 console.error("Erreur lors de la préparation des données pour la copie :", error);
                 showNotification("Erreur lors de la préparation des données pour la copie.", 4000);
             }
        }

        // Export all data (pillars, history, premium status) as JSON file
        function exportData() {
             if (!isPremium) {
                 showNotification("La fonction d'exportation est réservée aux utilisateurs Premium.");
                 return;
             }
             try {
                 const dataToExport = {
                     pillars: pillars,
                     history: history,
                     premiumStatus: isPremium,
                     exportTimestamp: new Date().toISOString() // Add export time
                 };
                 const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print
                 const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 // Generate a filename with date
                 const dateStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                 a.download = `roue_de_la_vie_export_${dateStr}.json`;
                 document.body.appendChild(a); // Required for Firefox
                 a.click();
                 document.body.removeChild(a); // Clean up
                 URL.revokeObjectURL(url); // Free up memory
                 showNotification("Données exportées avec succès.");
             } catch (error) {
                 console.error("Erreur lors de l'exportation JSON :", error);
                 showNotification("Erreur lors de la création du fichier d'exportation.", 4000);
             }
        }

        // Handle file input change for importing data
        function importData(event) {
             if (!isPremium) {
                 showNotification("La fonction d'importation est réservée aux utilisateurs Premium.");
                 event.target.value = ''; // Clear the file input
                 return;
             }

             const file = event.target.files[0];
             if (!file) {
                 showNotification("Aucun fichier sélectionné.");
                 return;
             }
             // Basic validation for file type
             if (!file.type.match('application/json')) {
                 showNotification("Fichier invalide. Veuillez sélectionner un fichier JSON exporté.", 4000);
                 event.target.value = ''; // Clear the file input
                 return;
             }

             const reader = new FileReader();

             reader.onload = function(e) {
                 try {
                     const importedData = JSON.parse(e.target.result);
                     if (!importedData || typeof importedData !== 'object') {
                         throw new Error("Le contenu du fichier n'est pas un objet JSON valide.");
                     }

                     let importedPillars = null;
                     let importedHistory = null;
                     let importedPremium = null;

                     // Validate and extract data (check for expected keys)
                     if (importedData.pillars && Array.isArray(importedData.pillars)) {
                         importedPillars = importedData.pillars;
                     } else {
                         console.warn("Données de piliers manquantes ou invalides dans l'import.");
                     }

                     if (importedData.history && Array.isArray(importedData.history)) {
                         importedHistory = importedData.history;
                     } else {
                         console.warn("Données d'historique manquantes ou invalides dans l'import.");
                     }

                      if (typeof importedData.premiumStatus === 'boolean') {
                         importedPremium = importedData.premiumStatus;
                     }

                     // Ask for confirmation before overwriting
                     if (!confirm("Importer ces données remplacera votre configuration et historique actuels. Continuer ?")) {
                         event.target.value = ''; // Clear the file input
                         return;
                     }

                     // Apply imported data if valid
                     let migrationNeeded = false;
                     if (importedPillars) {
                         pillars = migrateDataStructure(importedPillars); // Migrate imported structure
                         migrationNeeded = true; // Assume migration might change things
                     } else {
                          // Optionally, keep current pillars if import lacks them? Or reset? Reset is safer.
                          pillars = JSON.parse(JSON.stringify(defaultPillarsData));
                          showNotification("Piliers non trouvés dans l'import, réinitialisation aux défauts.");
                     }

                     if (importedHistory) {
                          // Basic validation of history entries before assigning
                          history = importedHistory.filter(entry => entry && entry.date && entry.timestamp && Array.isArray(entry.scores));
                          history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort imported history
                     } else {
                         history = []; // Reset history if not in import
                     }

                      if (importedPremium !== null) {
                         isPremium = importedPremium;
                         savePremiumStatus();
                         updatePremiumUI();
                     }


                     saveData(); // Save the newly imported data
                     currentPillarIndex = 0; // Reset view to first pillar
                     renderPillar(); // Re-render the UI with new data
                     showHistory(); // Update history view if modal is opened later
                     showChartView(); // Show chart to reflect imported data immediately
                     showNotification("Données importées et appliquées avec succès.");

                 } catch (err) {
                     console.error("Erreur lors de l'importation JSON :", err);
                     showNotification(`Erreur d'importation: ${err.message}. Fichier invalide ou corrompu.`, 5000);
                 } finally {
                     event.target.value = ''; // Clear the file input regardless of success/failure
                 }
             };

             reader.onerror = function() {
                 showNotification("Erreur lors de la lecture du fichier.", 4000);
                 event.target.value = ''; // Clear the file input
             };

             reader.readAsText(file);
        }


        // Reset the entire application to default state
        function resetApp() {
            if (!confirm("ATTENTION : Êtes-vous absolument sûr de vouloir réinitialiser TOUTES les données (piliers, historique, notes, statut premium) ? Cette action est IRRÉVERSIBLE.")) {
                return;
            }

            // Clear localStorage items
             localStorage.removeItem('wheelOfLife_pillars');
             localStorage.removeItem('wheelOfLife_history');
             localStorage.removeItem('wheelOfLife_premiumStatus');
             // Optionally clear theme preference too?
             // localStorage.removeItem('wheelOfLife_theme');

            // Reset global variables to defaults
            pillars = JSON.parse(JSON.stringify(defaultPillarsData));
            history = [];
            isPremium = false; // Reset premium status
            currentPillarIndex = 0;

            // Update UI immediately
            updatePremiumUI();
            renderPillar(); // Render default pillars
            showInputView(); // Ensure input view is shown
             if (chartInstance) { chartInstance.destroy(); chartInstance = null; } // Destroy chart

            // Close any open modals
            closeAllModals();

            showNotification("Application entièrement réinitialisée.", 4000);
            // No need to call saveData() as localStorage is already cleared.
             // Reloading might be the cleanest way to ensure everything resets:
             // window.location.reload(); // Uncomment this for a full page reload reset
        }


        // --- Modal Management ---

        function openModal(modalId) {
            closeAllModals(); // Close any other open modal first
            const modal = document.getElementById(modalId);
            if (!modal) {
                 console.error(`Modal with ID ${modalId} not found.`);
                 return;
             }

            // Prepare content based on modal type
            if (modalId === 'historyPopup') {
                showHistory(); // Render history content
            } else if (modalId === 'customizationPopup') {
                 if (!isPremium) {
                     showNotification("La personnalisation est une fonctionnalité Premium.");
                     return;
                 }
                renderCustomizationForm(); // Render customization form
            } else if (modalId === 'actionKeysPopup') {
                 renderActionKeys(); // Render action keys list
             }
             // No special prep needed for help or note popups here

            overlay.style.display = 'flex'; // Show the overlay
            modal.style.display = 'block'; // Show the specific modal
            modal.setAttribute('aria-hidden', 'false'); // Mark as visible for screen readers

            // Focus the first focusable element inside the modal
            // Use more robust selector for focusable elements
             const focusableElements = modal.querySelectorAll(
                 'button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])'
             );
             const firstFocusable = focusableElements[0];

             if (firstFocusable) {
                 // Delay focus slightly to ensure modal is fully rendered
                 setTimeout(() => firstFocusable.focus(), 50);
             }
        }


        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal || modal.style.display === 'none') {
                 return; // Modal not found or already hidden
             }

            modal.style.display = 'none'; // Hide the modal
            modal.setAttribute('aria-hidden', 'true'); // Mark as hidden

             // Check if any *other* modals are still open before hiding overlay
             const anyModalOpen = Array.from(document.querySelectorAll('.popup')).some(
                 m => m.style.display === 'block'
             );

             if (!anyModalOpen) {
                 overlay.style.display = 'none'; // Hide overlay only if no modals are left
             }

             // Return focus to the element that likely opened the modal (heuristic)
             // This needs refinement for better UX. For now, focus main view buttons.
             if (inputView.style.display === 'block') {
                 const personalizeButton = document.getElementById('personalizeBtn');
                 const helpButton = inputView.querySelector('button[onclick^="openModal(\'helpPopup\'"]');
                 // Try focusing the button that opened the modal if possible, else default
                 if (modalId === 'personalizePopup' && personalizeButton) personalizeButton.focus();
                 else if (modalId === 'helpPopup' && helpButton) helpButton.focus();
                 else if (nextBtn && !nextBtn.disabled) nextBtn.focus(); // Default focus
                 else if (prevBtn && !prevBtn.disabled) prevBtn.focus();

             } else if (chartView.style.display === 'block') {
                 const historyButton = chartView.querySelector('button[onclick^="openModal(\'historyPopup\'"]');
                 const returnButton = chartView.querySelector('button[onclick="showInputView()"]');
                 if (modalId === 'historyPopup' && historyButton) historyButton.focus();
                 else if (returnButton) returnButton.focus(); // Default focus
             }
        }

        // Close all currently open modals
        function closeAllModals() {
            document.querySelectorAll('.popup').forEach(modal => {
                if (modal.style.display !== 'none') {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                }
            });
            if (overlay.style.display !== 'none') {
                overlay.style.display = 'none';
            }
             // Optionally, return focus to a sensible default element, like the main heading
             // document.querySelector('h1').focus(); // Example
        }


        // --- Note Popup Logic ---

        function openNotePopup(pillarId, subPillarId) {
            const subPillar = findSubPillar(pillarId, subPillarId);
            if (!subPillar) return; // Exit if sub-pillar not found

            notePopupSubPillarName.textContent = subPillar.name;
            notePopupTextarea.value = subPillar.note || ''; // Populate textarea
            notePopupActionKeyCheckbox.checked = subPillar.isAction || false; // Populate checkbox

            // Store IDs on the save button's dataset for retrieval later
            saveNoteBtn.dataset.pillarId = pillarId;
            saveNoteBtn.dataset.subPillarId = subPillarId;

            openModal('notePopup'); // Show the modal
             // Focus the textarea after opening
             setTimeout(() => notePopupTextarea.focus(), 50);
        }

        function saveNoteFromPopup() {
            const pillarId = saveNoteBtn.dataset.pillarId;
            const subPillarId = saveNoteBtn.dataset.subPillarId;

            if (!pillarId || !subPillarId) {
                 console.error("Missing IDs on saveNoteBtn dataset");
                 showNotification("Erreur: Impossible de sauvegarder la note (IDs manquants).", 4000);
                 return;
             }

             const noteValue = notePopupTextarea.value;
             const isActionValue = notePopupActionKeyCheckbox.checked;

             updateNote(pillarId, subPillarId, noteValue, isActionValue); // Update the data model
             closeModal('notePopup'); // Close the modal
             showNotification("Note sauvegardée avec succès.");
        }


        // --- Customization Logic (Premium) ---

        // Render the form for customizing pillar/sub-pillar names
        function renderCustomizationForm() {
            customizationContent.innerHTML = ''; // Clear previous form
            if (!pillars || pillars.length === 0) {
                 customizationContent.innerHTML = "<p>Aucun pilier à personnaliser.</p>";
                 return;
             }

            pillars.forEach((pillar, pillarIndex) => {
                const section = document.createElement('div');
                section.className = 'customization-section';
                // Pillar Name Input & Delete Button
                 section.innerHTML = `
                     <h4>Pilier: ${pillar.name}</h4>
                     <div class="customization-item">
                         <input type="text" value="${pillar.name}" data-pillar-index="${pillarIndex}" class="custom-pillar-name" aria-label="Nouveau nom pour le pilier ${pillar.name}">
                         <button class="icon-button danger-button" onclick="deletePillar(${pillarIndex})" aria-label="Supprimer le pilier ${pillar.name} et ses sous-piliers" title="Supprimer ce pilier">
                             ${deleteIcon}
                         </button>
                     </div>
                     <h5>Sous-Piliers:</h5>`;

                // Sub-Pillar Name Inputs & Delete Buttons
                 if (pillar.subPillars && pillar.subPillars.length > 0) {
                     pillar.subPillars.forEach((subPillar, subIndex) => {
                         const subItem = document.createElement('div');
                         subItem.className = 'customization-item';
                         subItem.innerHTML = `
                             <input type="text" value="${subPillar.name}" data-pillar-index="${pillarIndex}" data-sub-index="${subIndex}" class="custom-subpillar-name" aria-label="Nouveau nom pour le sous-pilier ${subPillar.name}">
                             <button class="icon-button danger-button" onclick="deleteSubPillar(${pillarIndex}, ${subIndex})" aria-label="Supprimer le sous-pilier ${subPillar.name}" title="Supprimer ce sous-pilier">
                                 ${deleteIcon}
                             </button>
                         `;
                         section.appendChild(subItem);
                     });
                 } else {
                     section.innerHTML += '<p style="font-size:0.9em; color: var(--secondary-text-color);">Aucun sous-pilier.</p>';
                 }

                customizationContent.appendChild(section);
            });
        }


        // Save changes made in the customization form
        function saveCustomization() {
             if (!isPremium) return;

             const pillarInputs = document.querySelectorAll('.custom-pillar-name');
             const subPillarInputs = document.querySelectorAll('.custom-subpillar-name');
             let changed = false;

             // Update Pillar Names
             pillarInputs.forEach(input => {
                 const index = parseInt(input.dataset.pillarIndex);
                 const newName = input.value.trim();
                 // Check if valid index and name is not empty and actually changed
                 if (newName && index >= 0 && index < pillars.length && pillars[index].name !== newName) {
                     pillars[index].name = newName;
                     changed = true;
                 } else if (!newName) {
                      showNotification(`Le nom du pilier ${index + 1} ne peut pas être vide.`);
                      input.value = pillars[index].name; // Revert empty input
                 }
             });

             // Update Sub-Pillar Names
             subPillarInputs.forEach(input => {
                 const pillarIndex = parseInt(input.dataset.pillarIndex);
                 const subIndex = parseInt(input.dataset.subIndex);
                 const newName = input.value.trim();
                  // Check validity and if name actually changed
                 if (newName &&
                     pillarIndex >= 0 && pillarIndex < pillars.length &&
                     subIndex >= 0 && subIndex < pillars[pillarIndex].subPillars.length &&
                     pillars[pillarIndex].subPillars[subIndex].name !== newName)
                 {
                     pillars[pillarIndex].subPillars[subIndex].name = newName;
                     changed = true;
                 } else if (!newName) {
                      showNotification(`Le nom du sous-pilier "${pillars[pillarIndex].subPillars[subIndex].name}" ne peut pas être vide.`);
                       input.value = pillars[pillarIndex].subPillars[subIndex].name; // Revert
                  }
             });


             if (changed) {
                 saveData(); // Save the modified pillar structure
                 renderPillar(); // Re-render the current pillar view to reflect changes
                 // Chart labels will update automatically on next renderChart call
                 showNotification("Personnalisation sauvegardée.");
             } else {
                  showNotification("Aucun changement détecté.");
              }

             closeModal('customizationPopup'); // Close the modal
         }


        // Delete a pillar (Premium)
        function deletePillar(pillarIndex) {
             if (!isPremium) return;
             if (pillars.length <= 1) {
                 showNotification("Impossible de supprimer le dernier pilier.");
                 return;
             }
             if (pillarIndex < 0 || pillarIndex >= pillars.length) {
                  showNotification("Erreur: Index de pilier invalide.");
                  return;
              }

             const pillarName = pillars[pillarIndex].name;
             if (!confirm(`Voulez-vous vraiment supprimer définitivement le pilier "${pillarName}" et tous ses sous-piliers ?`)) {
                 return;
             }

             const deletedPillarId = pillars[pillarIndex].id;
             pillars.splice(pillarIndex, 1); // Remove from current data

             // Remove corresponding data from history entries
             history = history.map(entry => {
                 if (entry && entry.scores) {
                     entry.scores = entry.scores.filter(score => score.pillarId !== deletedPillarId);
                 }
                 return entry;
             }).filter(entry => entry && entry.scores && entry.scores.length > 0); // Remove entries with no scores left

             // Adjust current pillar index if necessary
             if (currentPillarIndex >= pillars.length) {
                 currentPillarIndex = Math.max(0, pillars.length - 1);
             }

             saveData(); // Save changes
             renderPillar(); // Re-render current view
             renderCustomizationForm(); // Re-render customization form without the deleted pillar
             if (chartInstance) { renderChart(); } // Update chart if visible
             showNotification(`Pilier "${pillarName}" supprimé.`);
         }

        // Delete a sub-pillar (Premium)
        function deleteSubPillar(pillarIndex, subIndex) {
             if (!isPremium) return;
              if (pillarIndex < 0 || pillarIndex >= pillars.length || !pillars[pillarIndex].subPillars) {
                  showNotification("Erreur: Pilier invalide.");
                  return;
              }
             if (pillars[pillarIndex].subPillars.length <= 1) {
                 showNotification("Chaque pilier doit conserver au moins un sous-pilier.");
                 return;
             }
              if (subIndex < 0 || subIndex >= pillars[pillarIndex].subPillars.length) {
                  showNotification("Erreur: Index de sous-pilier invalide.");
                  return;
              }

             const subPillarName = pillars[pillarIndex].subPillars[subIndex].name;
             if (!confirm(`Voulez-vous vraiment supprimer définitivement le sous-pilier "${subPillarName}" ?`)) {
                 return;
             }

             const deletedSubPillarId = pillars[pillarIndex].subPillars[subIndex].id;
             pillars[pillarIndex].subPillars.splice(subIndex, 1); // Remove from current data

             // Remove corresponding data from history entries
             history = history.map(entry => {
                 if (entry && entry.scores) {
                     const pillarScore = entry.scores.find(score => score.pillarId === pillars[pillarIndex].id);
                     if (pillarScore && pillarScore.subPillars) {
                         pillarScore.subPillars = pillarScore.subPillars.filter(sp => sp.subPillarId !== deletedSubPillarId);
                          // Recalculate average for this pillar in history? Or keep old one? Keeping old is simpler.
                     }
                 }
                 return entry;
             });


             saveData(); // Save changes
             renderPillar(); // Re-render current view
             renderCustomizationForm(); // Re-render customization form
             updateScoresDisplay(); // Recalculate averages for display
             if (chartInstance) { renderChart(); } // Update chart if visible
             showNotification(`Sous-pilier "${subPillarName}" supprimé.`);
         }

        // --- Theme Management ---

        function setupTheme() {
            const savedTheme = localStorage.getItem('wheelOfLife_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-theme');
                themeCheckbox.checked = true;
            } else {
                 // Light theme is default or explicitly saved
                 document.body.classList.remove('dark-theme'); // Ensure dark is removed
                 document.body.classList.add('light-theme'); // Explicitly add light class might not be needed if CSS defaults to light
                 themeCheckbox.checked = false;
            }
             // Add listener AFTER setting initial state
             themeCheckbox.addEventListener('change', toggleTheme);
              // Listen for system theme changes if no preference is saved
              window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                  const currentSavedTheme = localStorage.getItem('wheelOfLife_theme');
                  // Only react if user hasn't explicitly chosen a theme
                  if (!currentSavedTheme) {
                      if (event.matches) {
                          document.body.classList.add('dark-theme');
                          document.body.classList.remove('light-theme');
                          themeCheckbox.checked = true;
                      } else {
                          document.body.classList.remove('dark-theme');
                          document.body.classList.add('light-theme');
                          themeCheckbox.checked = false;
                      }
                      if (chartInstance) { renderChart(); } // Update chart on theme change
                  }
              });
        }

        function toggleTheme() {
            if (themeCheckbox.checked) {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
                localStorage.setItem('wheelOfLife_theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
                localStorage.setItem('wheelOfLife_theme', 'light');
            }
            // Re-render chart immediately to reflect new theme colors
            if (chartInstance) {
                 // Re-call renderChart without arguments to redraw standard chart
                 renderChart();
             } else if (chartView.style.display === 'block') {
                 // If chart view is visible but instance somehow lost, try rendering
                 renderChart();
             }
        }


        // --- Event Listeners ---
        function addEventListeners() {
            // Global keydown listener
            document.addEventListener('keydown', (e) => {
                 // Close modals on Escape key
                 if (e.key === 'Escape') {
                    // Check if a modal is actually open before trying to close
                    if (overlay.style.display === 'flex') {
                        closeAllModals();
                    }
                 }

                // Pillar navigation with arrow keys (only if not focused on input/textarea)
                const activeElement = document.activeElement;
                const isInputFocused = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.getAttribute('role') === 'slider'); // Check role for range input focus maybe?

                if (!isInputFocused && inputView.style.display === 'block') { // Only in input view
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault(); // Prevent browser back navigation
                        changePillar(-1);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault(); // Prevent default behavior
                        changePillar(1);
                    }
                }
            });

            // Premium activation listeners on logo
            if (appLogo) {
                appLogo.addEventListener('mousedown', handleLogoPressStart);
                appLogo.addEventListener('touchstart', handleLogoPressStart, { passive: false }); // Need passive: false to call preventDefault
                appLogo.addEventListener('mouseup', handleLogoPressEnd);
                appLogo.addEventListener('touchend', handleLogoPressEnd);
                appLogo.addEventListener('mouseleave', handleLogoPressEnd); // End timer if mouse leaves
                appLogo.addEventListener('touchcancel', handleLogoPressEnd); // End timer if touch is cancelled
                 // Prevent context menu on long press (important for mobile)
                 appLogo.addEventListener('contextmenu', (e) => e.preventDefault());
            }


            // Improve Pillar Nav Button Accessibility (Enter/Space activation)
            // Use event delegation on the container for efficiency
             const pillarNavContainer = document.getElementById('pillarNavigation');
             if (pillarNavContainer) {
                 pillarNavContainer.addEventListener('click', (e) => {
                     if (e.target.classList.contains('pillar-nav-button')) {
                         // Already handled by onclick attribute
                         // We could move logic here if we remove onclick attributes
                     }
                 });
                 pillarNavContainer.addEventListener('keydown', (e) => {
                     if (e.target.classList.contains('pillar-nav-button') && (e.key === 'Enter' || e.key === ' ')) {
                         e.preventDefault(); // Prevent space bar scrolling
                         e.target.click(); // Simulate click
                     }
                 });
             }
        }

        // --- Start the Application ---
        initializeApp();

    </script>
</body>
</html>
